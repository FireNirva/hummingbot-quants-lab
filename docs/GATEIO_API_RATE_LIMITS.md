# ğŸš¦ Gate.io API é™æµåˆ†æå’Œé£é™©è¯„ä¼°

## ğŸ“Š **Gate.io API é™æµæ”¿ç­–**

æ ¹æ® Gate.io å®˜æ–¹æ–‡æ¡£ï¼ˆhttps://www.gate.io/docs/developers/apiv4/ï¼‰ï¼š

### **ç°è´§ API é™åˆ¶**

| ç«¯ç‚¹ç±»å‹ | é™åˆ¶ | çª—å£ | è¯´æ˜ |
|---------|------|------|------|
| **å…¬å…±ç«¯ç‚¹** | 900 æ¬¡ | 10ç§’ | æ— éœ€è®¤è¯ |
| **è®¢å•ç°¿** | 100 æ¬¡ | 10ç§’ | `/spot/order_book` |
| **äº¤æ˜“æ•°æ®** | 100 æ¬¡ | 10ç§’ | `/spot/trades` |
| **ç§æœ‰ç«¯ç‚¹** | 300 æ¬¡ | 10ç§’ | éœ€è¦ API Key |

### **é™æµç»´åº¦**

- âœ… **IP çº§åˆ«**ï¼šæ‰€æœ‰è¯·æ±‚åŸºäº IP åœ°å€
- âœ… **ç«¯ç‚¹çº§åˆ«**ï¼šä¸åŒç«¯ç‚¹ç‹¬ç«‹è®¡æ•°
- âš ï¸ **å¹¶å‘é™åˆ¶**ï¼šæœ€å¤š 10 ä¸ªå¹¶å‘è¿æ¥

---

## ğŸ”¢ **ä½ çš„åœºæ™¯è®¡ç®—**

### **é‡‡é›†é…ç½®**

```yaml
äº¤æ˜“å¯¹æ•°é‡: 24
é‡‡é›†é¢‘ç‡: æ¯åˆ†é’Ÿ 1 æ¬¡
è®¢å•ç°¿æ·±åº¦: 100 æ¡£
```

### **è¯·æ±‚é‡è®¡ç®—**

```
æ¯åˆ†é’Ÿè¯·æ±‚æ•° = 24 ä¸ªäº¤æ˜“å¯¹ Ã— 1 æ¬¡/åˆ†é’Ÿ = 24 æ¬¡/åˆ†é’Ÿ

æ¢ç®—åˆ° 10 ç§’çª—å£ï¼š
24 æ¬¡/åˆ†é’Ÿ Ã· 6 = 4 æ¬¡/10ç§’

å¯¹æ¯”é™åˆ¶ï¼š
- è®¢å•ç°¿é™åˆ¶ï¼š100 æ¬¡/10ç§’
- ä½ çš„è¯·æ±‚ï¼š4 æ¬¡/10ç§’
- å®‰å…¨ç‡ï¼š4%ï¼ˆéå¸¸å®‰å…¨ï¼‰âœ…
```

### **å¹¶å‘è¯·æ±‚**

```python
# å½“å‰é…ç½®ï¼ˆå¼‚æ­¥å¹¶å‘é‡‡é›†ï¼‰
tasks = [
    self._collect_orderbook_snapshot(pair)
    for pair in self.trading_pairs  # 24ä¸ªäº¤æ˜“å¯¹
]
results = await asyncio.gather(*tasks)

# å®é™…å¹¶å‘æ•°ï¼šæœ€å¤š 10-24 ä¸ªï¼ˆå–å†³äºç½‘ç»œå»¶è¿Ÿï¼‰
# å¹¶å‘é™åˆ¶ï¼š10 ä¸ª
# é£é™©ï¼šâš ï¸ å¯èƒ½è¶…è¿‡å¹¶å‘é™åˆ¶
```

---

## âš ï¸ **é£é™©è¯„ä¼°**

### **è¯·æ±‚é¢‘ç‡é£é™©ï¼šâœ… æä½**

```
ä½ çš„è¯·æ±‚é€Ÿç‡ï¼š4 æ¬¡/10ç§’ï¼ˆ4%ï¼‰
é™åˆ¶é˜ˆå€¼ï¼š100 æ¬¡/10ç§’
ç»“è®ºï¼šå®Œå…¨å®‰å…¨ âœ…
```

### **å¹¶å‘è¿æ¥é£é™©ï¼šâš ï¸ ä¸­ç­‰**

```
ä½ çš„å¹¶å‘æ•°ï¼š24 ä¸ªï¼ˆç†è®ºæœ€å¤§ï¼‰
é™åˆ¶é˜ˆå€¼ï¼š10 ä¸ª
ç»“è®ºï¼šå¯èƒ½è§¦å‘é™åˆ¶ âš ï¸
```

### **IP å°ç¦é£é™©ï¼šâœ… æä½**

```
Gate.io é€šå¸¸åªå¯¹ä»¥ä¸‹æƒ…å†µå°ç¦ï¼š
- âŒ æ¶æ„çˆ¬è™«ï¼ˆæ¯ç§’æ•°ç™¾æ¬¡è¯·æ±‚ï¼‰
- âŒ DDoS æ”»å‡»
- âŒ æŒç»­è¿åé™åˆ¶ï¼ˆå¤šæ¬¡ 429 é”™è¯¯ï¼‰

ä½ çš„æƒ…å†µï¼š
- âœ… åˆç†çš„æ•°æ®é‡‡é›†ï¼ˆ24æ¬¡/åˆ†é’Ÿï¼‰
- âœ… æ­£å¸¸ä½¿ç”¨åœºæ™¯
- âœ… æœ‰å»¶è¿Ÿæ§åˆ¶
```

---

## ğŸ’¡ **å®‰å…¨å»ºè®®å’Œä¼˜åŒ–æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ 1ï¼šé™ä½å¹¶å‘æ•°ï¼ˆæ¨èï¼‰â­â­â­â­â­**

**ä¿®æ”¹é‡‡é›†ä»»åŠ¡ï¼Œæ·»åŠ å¹¶å‘æ§åˆ¶**ï¼š

```python
# åœ¨ app/tasks/data_collection/orderbook_snapshot_task.py

async def execute(self, context: TaskContext) -> Dict[str, Any]:
    """ä¸»æ‰§è¡Œé€»è¾‘ï¼šé‡‡é›†è®¢å•ç°¿å¿«ç…§"""
    start_time = datetime.now(timezone.utc)
    
    # æ·»åŠ å¹¶å‘æ§åˆ¶
    MAX_CONCURRENT = 5  # é™åˆ¶æœ€å¤š 5 ä¸ªå¹¶å‘
    semaphore = asyncio.Semaphore(MAX_CONCURRENT)
    
    async def collect_with_limit(pair):
        async with semaphore:
            return await self._collect_orderbook_snapshot(pair)
    
    # ä½¿ç”¨å—é™å¹¶å‘
    tasks = [
        collect_with_limit(pair)
        for pair in self.trading_pairs
    ]
    
    results = await asyncio.gather(*tasks, return_exceptions=True)
    # ... å…¶ä½™ä»£ç 
```

**æ•ˆæœ**ï¼š
- âœ… å¹¶å‘æ•°ï¼šâ‰¤ 5 ä¸ªï¼ˆå®Œå…¨å®‰å…¨ï¼‰
- âœ… æ€»æ—¶é—´ï¼š~10-15 ç§’/è½®ï¼ˆå¯æ¥å—ï¼‰
- âœ… é£é™©ï¼šå‡ ä¹ä¸ºé›¶

---

### **æ–¹æ¡ˆ 2ï¼šæ·»åŠ è¯·æ±‚é—´å»¶è¿Ÿ**

```python
async def _collect_orderbook_snapshot(self, trading_pair: str) -> bool:
    """é‡‡é›†å•ä¸ªäº¤æ˜“å¯¹çš„è®¢å•ç°¿å¿«ç…§"""
    try:
        # æ·»åŠ éšæœºå»¶è¿Ÿï¼ˆé¿å…çªå‘è¯·æ±‚ï¼‰
        await asyncio.sleep(random.uniform(0.1, 0.5))
        
        # ... åŸæœ‰ä»£ç 
```

**æ•ˆæœ**ï¼š
- âœ… è¯·æ±‚æ›´å¹³æ»‘
- âœ… é™ä½çªå‘æµé‡
- âš ï¸ é‡‡é›†æ—¶é—´ç¨é•¿ï¼ˆ+12ç§’ï¼‰

---

### **æ–¹æ¡ˆ 3ï¼šåˆ†æ‰¹é‡‡é›†**

```python
async def execute(self, context: TaskContext) -> Dict[str, Any]:
    """åˆ†æ‰¹é‡‡é›†ï¼šå°†24ä¸ªäº¤æ˜“å¯¹åˆ†æˆ3æ‰¹ï¼Œæ¯æ‰¹8ä¸ª"""
    
    BATCH_SIZE = 8
    batches = [
        self.trading_pairs[i:i+BATCH_SIZE]
        for i in range(0, len(self.trading_pairs), BATCH_SIZE)
    ]
    
    all_results = []
    
    for batch_idx, batch in enumerate(batches):
        logger.info(f"Processing batch {batch_idx+1}/{len(batches)}")
        
        tasks = [
            self._collect_orderbook_snapshot(pair)
            for pair in batch
        ]
        
        results = await asyncio.gather(*tasks, return_exceptions=True)
        all_results.extend(results)
        
        # æ‰¹æ¬¡é—´å»¶è¿Ÿ
        if batch_idx < len(batches) - 1:
            await asyncio.sleep(2)  # æ‰¹æ¬¡é—´ç­‰å¾…2ç§’
    
    # ... å¤„ç† all_results
```

**æ•ˆæœ**ï¼š
- âœ… å¹¶å‘æ•°ï¼šâ‰¤ 8 ä¸ªï¼ˆå®‰å…¨ï¼‰
- âœ… æ‰¹æ¬¡é—´å»¶è¿Ÿï¼šæ›´å®‰å…¨
- âš ï¸ æ€»æ—¶é—´ï¼š~10-15 ç§’ï¼ˆç•¥é•¿ï¼‰

---

### **æ–¹æ¡ˆ 4ï¼šé™ä½é‡‡é›†é¢‘ç‡ï¼ˆæœ€ä¿å®ˆï¼‰**

```yaml
# config/orderbook_snapshot_gateio.yml

schedule:
  type: frequency
  frequency_minutes: 5  # æ”¹ä¸ºæ¯5åˆ†é’Ÿ
  # frequency_minutes: 1  # åŸæ¥æ¯1åˆ†é’Ÿ
```

**æ•ˆæœ**ï¼š
- âœ… è¯·æ±‚é€Ÿç‡ï¼šé™ä½ 5 å€
- âœ… é£é™©ï¼šæ¥è¿‘é›¶
- âš ï¸ æ•°æ®ç²’åº¦ï¼šé™ä½ï¼ˆä½†å¯¹å¤§å¤šæ•°ç”¨é€”ä»è¶³å¤Ÿï¼‰

---

## ğŸ“Š **æ¨èé…ç½®ï¼ˆå¹³è¡¡æ–¹æ¡ˆï¼‰**

### **é…ç½® Aï¼šä¿å®ˆæ¨¡å¼ï¼ˆæ¨èæ–°æ‰‹ï¼‰**

```python
# å¹¶å‘æ§åˆ¶
MAX_CONCURRENT = 5

# è¯·æ±‚é—´å»¶è¿Ÿ
DELAY_BETWEEN_REQUESTS = 0.2  # 200ms

# é‡‡é›†é¢‘ç‡
frequency_minutes = 2  # æ¯2åˆ†é’Ÿ
```

**ç‰¹ç‚¹**ï¼š
- âœ… æä½é£é™©
- âœ… è¶³å¤Ÿæ•°æ®
- âœ… é€‚åˆé•¿æœŸè¿è¡Œ

---

### **é…ç½® Bï¼šç§¯ææ¨¡å¼ï¼ˆæ¨èæœ‰ç»éªŒç”¨æˆ·ï¼‰**

```python
# å¹¶å‘æ§åˆ¶
MAX_CONCURRENT = 8

# è¯·æ±‚é—´å»¶è¿Ÿ
DELAY_BETWEEN_REQUESTS = 0.1  # 100ms

# é‡‡é›†é¢‘ç‡
frequency_minutes = 1  # æ¯1åˆ†é’Ÿ
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ›´é«˜æ•°æ®ç²¾åº¦
- âš ï¸ éœ€è¦ç›‘æ§
- âœ… é£é™©å¯æ§

---

## ğŸ”§ **å®æ–½æ­¥éª¤**

### **1. æ›´æ–°é‡‡é›†ä»»åŠ¡ï¼ˆæ·»åŠ å¹¶å‘æ§åˆ¶ï¼‰**

æˆ‘å¸®ä½ åˆ›å»ºä¸€ä¸ªä¼˜åŒ–ç‰ˆæœ¬ï¼š

```bash
# ä½¿ç”¨ä¼˜åŒ–åçš„é‡‡é›†ä»»åŠ¡
python cli.py trigger-task \
  --task orderbook_snapshot_gateio_safe \
  --config config/orderbook_snapshot_gateio_safe.yml
```

### **2. ç›‘æ§è¿è¡ŒçŠ¶æ€**

```bash
# ç›‘æ§æ—¥å¿—
tail -f orderbook_collection.log | grep -E "Error|429|rate"

# æ£€æŸ¥é‡‡é›†æˆåŠŸç‡
python -c "
from app.tasks.data_collection.orderbook_snapshot_task import load_orderbook_snapshots
import pandas as pd

df = load_orderbook_snapshots('gate_io', 'IRON-USDT')
print(f'æ€»å¿«ç…§æ•°: {len(df)}')
print(f'æ—¶é—´èŒƒå›´: {df[\"timestamp\"].min()} åˆ° {df[\"timestamp\"].max()}')

# è®¡ç®—é‡‡é›†æˆåŠŸç‡
expected = 24 * 60 * 24  # 24ä¸ªå¯¹ Ã— 60æ¬¡/å°æ—¶ Ã— 24å°æ—¶
actual = len(df)
success_rate = actual / expected * 100
print(f'é‡‡é›†æˆåŠŸç‡: {success_rate:.1f}%')
"
```

### **3. é”™è¯¯å¤„ç†**

å¦‚æœçœ‹åˆ° `429` é”™è¯¯ï¼ˆé™æµï¼‰ï¼š

```python
# ä»»åŠ¡ä¸­å·²å†…ç½®é‡è¯•é€»è¾‘
try:
    orderbook = await self.connector.get_order_book(formatted_pair)
except Exception as e:
    if '429' in str(e):
        logger.warning(f"Rate limited for {trading_pair}, will retry next cycle")
        # è‡ªåŠ¨åœ¨ä¸‹æ¬¡é‡‡é›†å‘¨æœŸé‡è¯•
        return False
```

---

## ğŸ“ˆ **é•¿æœŸè¿è¡Œå»ºè®®**

### **ç¬¬ 1 å‘¨ï¼šä¿å®ˆæ¨¡å¼**

```yaml
frequency_minutes: 5
MAX_CONCURRENT: 5
```

- è§‚å¯Ÿæ˜¯å¦æœ‰ 429 é”™è¯¯
- éªŒè¯æ•°æ®å®Œæ•´æ€§
- è°ƒæ•´å‚æ•°

### **ç¬¬ 2-4 å‘¨ï¼šæ­£å¸¸æ¨¡å¼**

```yaml
frequency_minutes: 2
MAX_CONCURRENT: 8
```

- ç»§ç»­ç›‘æ§
- å¦‚æœç¨³å®šï¼Œè€ƒè™‘æ›´ç§¯æçš„é…ç½®

### **é•¿æœŸç¨³å®šè¿è¡Œ**

```yaml
frequency_minutes: 1
MAX_CONCURRENT: 10  # æ¥è¿‘ä½†ä¸è¶…è¿‡é™åˆ¶
```

---

## ğŸ¯ **ç»“è®º**

### âœ… **ä½ çš„åœºæ™¯æ˜¯å®‰å…¨çš„ï¼**

| ç»´åº¦ | ä½ çš„é…ç½® | é™åˆ¶ | å®‰å…¨ç‡ | é£é™© |
|------|---------|------|--------|------|
| **è¯·æ±‚é¢‘ç‡** | 4/10ç§’ | 100/10ç§’ | 4% | âœ… æä½ |
| **å¹¶å‘è¿æ¥** | 24ä¸ª | 10ä¸ª | 240% | âš ï¸ éœ€ä¼˜åŒ– |
| **IP å°ç¦** | åˆç†ä½¿ç”¨ | æ¶æ„è¡Œä¸º | N/A | âœ… æä½ |

### ğŸ¯ **å»ºè®®è¡ŒåŠ¨**

1. **ç«‹å³å¯åš**ï¼šæŒ‰åŸé…ç½®è¿è¡Œï¼ˆé£é™©å¾ˆä½ï¼‰
   - è¯·æ±‚é€Ÿç‡ï¼š4/10ç§’ï¼ˆä»… 4%ï¼‰
   - æœ€åæƒ…å†µï¼šå¶å°” 429 é”™è¯¯ï¼Œè‡ªåŠ¨é‡è¯•

2. **æœ€ä½³å®è·µ**ï¼šæ·»åŠ å¹¶å‘æ§åˆ¶ï¼ˆæ¨èï¼‰
   - é™åˆ¶å¹¶å‘æ•°ï¼š5-8 ä¸ª
   - å‡ ä¹é›¶é£é™©

3. **ç›‘æ§è¿è¡Œ**ï¼šè§‚å¯Ÿ 1-2 å¤©
   - å¦‚æ—  429 é”™è¯¯ï¼šé…ç½®å®Œç¾
   - å¦‚æœ‰å°‘é‡ 429ï¼šé™ä½å¹¶å‘æˆ–é¢‘ç‡

### ğŸ’¡ **å¿«é€Ÿåˆ¤æ–­**

```
å¦‚æœä½ çœ‹åˆ°ï¼š
- âœ… æ—¥å¿—æ—  "429" æˆ– "rate limit" â†’ é…ç½®å®Œç¾
- âš ï¸ å¶å°”å‡ºç° 429 â†’ é™ä½å¹¶å‘æ•°åˆ° 5
- âŒ é¢‘ç¹å‡ºç° 429 â†’ é™ä½é¢‘ç‡åˆ° 5 åˆ†é’Ÿ

å°ç¦é£é™©ï¼š
- å‡ ä¹ä¸ºé›¶ï¼ˆä½ çš„è¯·æ±‚é€Ÿç‡åªæœ‰é™åˆ¶çš„ 4%ï¼‰
```

---

## ğŸ“ **éœ€è¦å¸®åŠ©ï¼Ÿ**

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä»£ç 
2. é™ä½ `frequency_minutes` æˆ– `MAX_CONCURRENT`
3. è”ç³» Gate.io æ”¯æŒç¡®è®¤é™åˆ¶

**æ€»ç»“ï¼š24 ä¸ªäº¤æ˜“å¯¹æ¯åˆ†é’Ÿé‡‡é›†æ˜¯å®Œå…¨å®‰å…¨çš„ï¼** ğŸ‰

