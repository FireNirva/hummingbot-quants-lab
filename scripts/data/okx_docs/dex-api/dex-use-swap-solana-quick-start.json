{
  "title": "在 Solana 链上搭建兑换应用 | 搭建兑换应用 | 指南 | 交易 API | DEX API | DEX API 文档 | 欧易",
  "text": "在 Solana 链上搭建兑换应用\n#\n在 Solana 上使用OKX DEX构建兑换应用程序有两种方法：\nAPI的方法-直接与OKX DEX API交互\nSDK方法-使用\n@okx-dex/okx-dex-sdk\n简化开发人员体验\n本指南涵盖了这两种方法，以帮助你选择最适合你需求的方法。\n方法1：API方法\n#\n在本指南中，我们将提供通过OKX DEX进行Solana代币兑换的用例。\n1.设置环境\n#\n导入必要的Node. js库并设置环境变量：\n// Required libraries\nimport\nbase58\nfrom\n\"bs58\"\n;\nimport\nBN\nfrom\n\"bn.js\"\n;\nimport\n*\nas\nsolanaWeb3\nfrom\n\"@solana/web3.js\"\n;\nimport\n{\nConnection\n}\nfrom\n\"@solana/web3.js\"\n;\nimport\ncryptoJS\nfrom\n\"crypto-js\"\n;\nimport\naxios\nfrom\n\"axios\"\n;\nimport\ndotenv\nfrom\n'dotenv'\n;\ndotenv\n.\nconfig\n(\n)\n;\n// Environment variables\nconst\napiKey\n=\nprocess\n.\nenv\n.\nOKX_API_KEY\n;\nconst\nsecretKey\n=\nprocess\n.\nenv\n.\nOKX_SECRET_KEY\n;\nconst\napiPassphrase\n=\nprocess\n.\nenv\n.\nOKX_API_PASSPHRASE\n;\nconst\nprojectId\n=\nprocess\n.\nenv\n.\nOKX_PROJECT_ID\n;\nconst\nuserAddress\n=\nprocess\n.\nenv\n.\nWALLET_ADDRESS\n;\nconst\nuserPrivateKey\n=\nprocess\n.\nenv\n.\nPRIVATE_KEY\n;\nconst\nsolanaRpcUrl\n=\nprocess\n.\nenv\n.\nSOLANA_RPC_URL\n;\n// Constants\nconst\nSOLANA_CHAIN_ID\n=\n\"501\"\n;\nconst\nCOMPUTE_UNITS\n=\n300000\n;\nconst\nMAX_RETRIES\n=\n3\n;\n// Initialize Solana connection\nconst\nconnection\n=\nnew\nConnection\n(\n`\n${\nsolanaRpcUrl\n}\n`\n,\n{\nconfirmTransactionInitialTimeout\n:\n5000\n}\n)\n;\n// Utility function for OKX API authentication\nfunction\ngetHeaders\n(\ntimestamp\n:\nstring\n,\nmethod\n:\nstring\n,\nrequestPath\n:\nstring\n,\nqueryString\n=\n\"\"\n,\nbody\n=\n\"\"\n)\n{\nconst\nstringToSign\n=\ntimestamp\n+\nmethod\n+\nrequestPath\n+\n(\nqueryString\n||\nbody\n)\n;\nreturn\n{\n\"Content-Type\"\n:\n\"application/json\"\n,\n\"OK-ACCESS-KEY\"\n:\napiKey\n,\n\"OK-ACCESS-SIGN\"\n:\ncryptoJS\n.\nenc\n.\nBase64\n.\nstringify\n(\ncryptoJS\n.\nHmacSHA256\n(\nstringToSign\n,\nsecretKey\n)\n)\n,\n\"OK-ACCESS-TIMESTAMP\"\n:\ntimestamp\n,\n\"OK-ACCESS-PASSPHRASE\"\n:\napiPassphrase\n,\n\"OK-ACCESS-PROJECT\"\n:\nprojectId\n,\n}\n;\n}\n2.获取兑换数据\n#\nSolana的本机令牌地址11111111111111111111111111111111。使用/swap端点检索详细的兑换信息：\nasync\nfunction\ngetSwapData\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n,\namount\n:\nstring\n,\nslippage\n=\n'0.5'\n)\n{\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n\"/api/v5/dex/aggregator/swap\"\n;\nconst\nparams\n=\n{\namount\n:\namount\n,\nchainId\n:\nSOLANA_CHAIN_ID\n,\nfromTokenAddress\n:\nfromTokenAddress\n,\ntoTokenAddress\n:\ntoTokenAddress\n,\nuserWalletAddress\n:\nuserAddress\n,\nslippage\n:\nslippage\n}\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n\"GET\"\n,\nrequestPath\n,\nqueryString\n)\n;\ntry\n{\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\n`\nhttps://web3.okx.com\n${\nrequestPath\n}\n${\nqueryString\n}\n`\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n!==\n\"0\"\n||\n!\nresponse\n.\ndata\n.\ndata\n?.\n[\n0\n]\n)\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n\"Failed to get swap data\"\n}\n`\n)\n;\n}\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n\"Error fetching swap data:\"\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n3.准备交易\n#\n从 /swap 获得callData后，你需要反序列化并签名交易：\nasync\nfunction\nprepareTransaction\n(\ncallData\n:\nstring\n)\n{\ntry\n{\n// Decode the base58 encoded transaction data\nconst\ndecodedTransaction\n=\nbase58\n.\ndecode\n(\ncallData\n)\n;\n// Get the latest blockhash\nconst\nrecentBlockHash\n=\nawait\nconnection\n.\ngetLatestBlockhash\n(\n)\n;\nconsole\n.\nlog\n(\n\"Got blockhash:\"\n,\nrecentBlockHash\n.\nblockhash\n)\n;\nlet\ntx\n;\n// Try to deserialize as a versioned transaction first\ntry\n{\ntx\n=\nsolanaWeb3\n.\nVersionedTransaction\n.\ndeserialize\n(\ndecodedTransaction\n)\n;\nconsole\n.\nlog\n(\n\"Successfully created versioned transaction\"\n)\n;\ntx\n.\nmessage\n.\nrecentBlockhash\n=\nrecentBlockHash\n.\nblockhash\n;\n}\ncatch\n(\ne\n)\n{\n// Fall back to legacy transaction if versioned fails\nconsole\n.\nlog\n(\n\"Versioned transaction failed, trying legacy:\"\n,\ne\n)\n;\ntx\n=\nsolanaWeb3\n.\nTransaction\n.\nfrom\n(\ndecodedTransaction\n)\n;\nconsole\n.\nlog\n(\n\"Successfully created legacy transaction\"\n)\n;\ntx\n.\nrecentBlockhash\n=\nrecentBlockHash\n.\nblockhash\n;\n}\nreturn\n{\ntransaction\n:\ntx\n,\nrecentBlockHash\n}\n;\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n\"Error preparing transaction:\"\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\nasync\nfunction\nsignTransaction\n(\ntx\n:\nsolanaWeb3\n.\nTransaction\n|\nsolanaWeb3\n.\nVersionedTransaction\n)\n{\nif\n(\n!\nuserPrivateKey\n)\n{\nthrow\nnew\nError\n(\n\"Private key not found\"\n)\n;\n}\nconst\nfeePayer\n=\nsolanaWeb3\n.\nKeypair\n.\nfromSecretKey\n(\nbase58\n.\ndecode\n(\nuserPrivateKey\n)\n)\n;\nif\n(\ntx\ninstanceof\nsolanaWeb3\n.\nVersionedTransaction\n)\n{\ntx\n.\nsign\n(\n[\nfeePayer\n]\n)\n;\n}\nelse\n{\ntx\n.\npartialSign\n(\nfeePayer\n)\n;\n}\n}\n4. 广播交易\n#\n4.1 使用\nRPC\n广播交易\nconst\ntxId\n=\nawait\nconnection\n.\nsendRawTransaction\n(\ntx\n.\nserialize\n(\n)\n)\n;\nconsole\n.\nlog\n(\n'Transaction ID:'\n,\ntxId\n)\n;\n// Wait for confirmation\nawait\nconnection\n.\nconfirmTransaction\n(\ntxId\n)\n;\nconsole\n.\nlog\n(\n`\nTransaction confirmed: https://solscan.io/tx/\n${\ntxId\n}\n`\n)\n;\n4.2 使用\n交易上链 API\n广播交易\nasync\nfunction\nbroadcastTransaction\n(\nsignedTx\n:\nsolanaWeb3\n.\nTransaction\n|\nsolanaWeb3\n.\nVersionedTransaction\n)\n{\ntry\n{\nconst\nserializedTx\n=\nsignedTx\n.\nserialize\n(\n)\n;\nconst\nencodedTx\n=\nbase58\n.\nencode\n(\nserializedTx\n)\n;\nconst\npath\n=\n\"dex/pre-transaction/broadcast-transaction\"\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconst\nbroadcastData\n=\n{\nsignedTx\n:\nencodedTx\n,\nchainIndex\n:\nSOLANA_CHAIN_ID\n,\naddress\n:\nuserAddress\n}\n;\n// Prepare authentication with body included in signature\nconst\nbodyString\n=\nJSON\n.\nstringify\n(\nbroadcastData\n)\n;\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'POST'\n,\nrequestPath\n,\n\"\"\n,\nbodyString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\npost\n(\nurl\n,\nbroadcastData\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nconst\norderId\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norderId\n;\nconsole\n.\nlog\n(\n`\nTransaction broadcast successfully, Order ID:\n${\norderId\n}\n`\n)\n;\nreturn\norderId\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to broadcast transaction:'\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n5.追踪交易\n#\n使用\n交易上链 API\n// Define transaction status interface\ninterface\nTxErrorInfo\n{\nerror\n:\nstring\n;\nmessage\n:\nstring\n;\naction\n:\nstring\n;\n}\n/**\n * Tracking transaction confirmation status using the Onchain gateway API\n *\n@param\norderId\n- Order ID from broadcast response\n *\n@param\nintervalMs\n- Polling interval in milliseconds\n *\n@param\ntimeoutMs\n- Maximum time to wait\n *\n@returns\nFinal transaction confirmation status\n */\nasync\nfunction\ntrackTransaction\n(\norderId\n:\nstring\n,\nintervalMs\n:\nnumber\n=\n5000\n,\ntimeoutMs\n:\nnumber\n=\n300000\n)\n:\nPromise\n<\nany\n>\n{\nconsole\n.\nlog\n(\n`\nTracking transaction with Order ID:\n${\norderId\n}\n`\n)\n;\nconst\nstartTime\n=\nDate\n.\nnow\n(\n)\n;\nlet\nlastStatus\n=\n''\n;\nwhile\n(\nDate\n.\nnow\n(\n)\n-\nstartTime\n<\ntimeoutMs\n)\n{\n// Get transaction status\ntry\n{\nconst\npath\n=\n'dex/post-transaction/orders'\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\norderId\n:\norderId\n,\nchainIndex\n:\nSOLANA_CHAIN_ID\n,\naddress\n:\nuserAddress\n,\nlimit\n:\n'1'\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n&&\nresponse\n.\ndata\n.\ndata\n&&\nresponse\n.\ndata\n.\ndata\n.\nlength\n>\n0\n)\n{\nif\n(\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n&&\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n.\nlength\n>\n0\n)\n{\nconst\ntxData\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n[\n0\n]\n;\n// Use txStatus to match the API response\nconst\nstatus\n=\ntxData\n.\ntxStatus\n;\n// Only log when status changes\nif\n(\nstatus\n!==\nlastStatus\n)\n{\nlastStatus\n=\nstatus\n;\nif\n(\nstatus\n===\n'1'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction pending:\n${\ntxData\n.\ntxHash\n||\n'Hash not available yet'\n}\n`\n)\n;\n}\nelse\nif\n(\nstatus\n===\n'2'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction successful: https://solscan.io/tx/\n${\ntxData\n.\ntxHash\n}\n`\n)\n;\nreturn\ntxData\n;\n}\nelse\nif\n(\nstatus\n===\n'3'\n)\n{\nconst\nfailReason\n=\ntxData\n.\nfailReason\n||\n'Unknown reason'\n;\nconst\nerrorMessage\n=\n`\nTransaction failed:\n${\nfailReason\n}\n`\n;\nconsole\n.\nerror\n(\nerrorMessage\n)\n;\nconst\nerrorInfo\n=\nhandleTransactionError\n(\ntxData\n)\n;\nconsole\n.\nlog\n(\n`\nError type:\n${\nerrorInfo\n.\nerror\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nSuggested action:\n${\nerrorInfo\n.\naction\n}\n`\n)\n;\nthrow\nnew\nError\n(\nerrorMessage\n)\n;\n}\n}\n}\nelse\n{\nconsole\n.\nlog\n(\n`\nNo orders found for Order ID:\n${\norderId\n}\n`\n)\n;\n}\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nwarn\n(\n'Error checking transaction status:'\n,\n(\nerror\ninstanceof\nError\n?\nerror\n.\nmessage\n:\n\"Unknown error\"\n)\n)\n;\n}\n// Wait before next check\nawait\nnew\nPromise\n(\nresolve\n=>\nsetTimeout\n(\nresolve\n,\nintervalMs\n)\n)\n;\n}\nthrow\nnew\nError\n(\n'Transaction tracking timed out'\n)\n;\n}\n/**\n * Comprehensive error handling with failReason\n *\n@param\ntxData\n- Transaction data from post-transaction/orders\n *\n@returns\nStructured error information\n */\nfunction\nhandleTransactionError\n(\ntxData\n:\nany\n)\n:\nTxErrorInfo\n{\nconst\nfailReason\n=\ntxData\n.\nfailReason\n||\n'Unknown reason'\n;\n// Log the detailed error\nconsole\n.\nerror\n(\n`\nTransaction failed with reason:\n${\nfailReason\n}\n`\n)\n;\n// Default error info\nlet\nerrorInfo\n:\nTxErrorInfo\n=\n{\nerror\n:\n'TRANSACTION_FAILED'\n,\nmessage\n:\nfailReason\n,\naction\n:\n'Try again or contact support'\n}\n;\n// More specific error handling based on the failure reason\nif\n(\nfailReason\n.\nincludes\n(\n'insufficient funds'\n)\n)\n{\nerrorInfo\n=\n{\nerror\n:\n'INSUFFICIENT_FUNDS'\n,\nmessage\n:\n'Your wallet does not have enough funds to complete this transaction'\n,\naction\n:\n'Add more SOL to your wallet to cover the transaction'\n}\n;\n}\nelse\nif\n(\nfailReason\n.\nincludes\n(\n'blockhash'\n)\n)\n{\nerrorInfo\n=\n{\nerror\n:\n'BLOCKHASH_EXPIRED'\n,\nmessage\n:\n'The transaction blockhash has expired'\n,\naction\n:\n'Try again with a fresh transaction'\n}\n;\n}\nelse\nif\n(\nfailReason\n.\nincludes\n(\n'compute budget'\n)\n)\n{\nerrorInfo\n=\n{\nerror\n:\n'COMPUTE_BUDGET_EXCEEDED'\n,\nmessage\n:\n'Transaction exceeded compute budget'\n,\naction\n:\n'Increase compute units or simplify the transaction'\n}\n;\n}\nreturn\nerrorInfo\n;\n}\n详细的兑换信息，我们可以使用 Swap API\n/**\n * Track transaction using SWAP API\n *\n@param\nchainId\n- Chain ID (e.g., 501 for Solana)\n *\n@param\ntxHash\n- Transaction hash\n *\n@returns\nTransaction details\n */\nasync\nfunction\ntrackTransactionWithSwapAPI\n(\ntxHash\n:\nstring\n)\n:\nPromise\n<\nany\n>\n{\ntry\n{\nconst\npath\n=\n'dex/aggregator/history'\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\nchainId\n:\nSOLANA_CHAIN_ID\n,\ntxHash\n:\ntxHash\n,\nisFromMyProject\n:\n'true'\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nconst\ntxData\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\nconst\nstatus\n=\ntxData\n.\nstatus\n;\nif\n(\nstatus\n===\n'pending'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction is still pending:\n${\ntxHash\n}\n`\n)\n;\nreturn\n{\nstatus\n:\n'pending'\n,\ndetails\n:\ntxData\n}\n;\n}\nelse\nif\n(\nstatus\n===\n'success'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction successful!\n`\n)\n;\nconsole\n.\nlog\n(\n`\nFrom:\n${\ntxData\n.\nfromTokenDetails\n.\nsymbol\n}\n- Amount:\n${\ntxData\n.\nfromTokenDetails\n.\namount\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nTo:\n${\ntxData\n.\ntoTokenDetails\n.\nsymbol\n}\n- Amount:\n${\ntxData\n.\ntoTokenDetails\n.\namount\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nTransaction Fee:\n${\ntxData\n.\ntxFee\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nExplorer URL: https://solscan.io/tx/\n${\ntxHash\n}\n`\n)\n;\nreturn\n{\nstatus\n:\n'success'\n,\ndetails\n:\ntxData\n}\n;\n}\nelse\nif\n(\nstatus\n===\n'failure'\n)\n{\nconsole\n.\nerror\n(\n`\nTransaction failed:\n${\ntxData\n.\nerrorMsg\n||\n'Unknown reason'\n}\n`\n)\n;\nreturn\n{\nstatus\n:\n'failure'\n,\ndetails\n:\ntxData\n}\n;\n}\nreturn\ntxData\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to track transaction status:'\n,\n(\nerror\ninstanceof\nError\n?\nerror\n.\nmessage\n:\n\"Unknown error\"\n)\n)\n;\nthrow\nerror\n;\n}\n}\n交易上链 API 监控使用 /dex/post-transaction/orders 跟踪内部订单处理状态。它有助于监控交易在 OKX 系统中的移动情况，并提供订单 ID 和基本状态（1：待处理，2：成功，3：失败）。\nSwap API 交易跟踪使用 /dex/aggregator/history 提供全面的兑换执行详情。它提供特定于代币的信息（代码、金额）、已支付的费用以及详细的区块链数据。如果您需要完整的兑换验证并提供代币级详细信息，请使用此选项。\n选择前者用于基本交易状态更新，而选择后者用于获取兑换执行本身的详细信息。\n6.完整实现\n#\n这是一个完整的实现示例：\n// solana-swap.ts\nimport\nbase58\nfrom\n\"bs58\"\n;\nimport\nBN\nfrom\n\"bn.js\"\n;\nimport\n*\nas\nsolanaWeb3\nfrom\n\"@solana/web3.js\"\n;\nimport\n{\nConnection\n}\nfrom\n\"@solana/web3.js\"\n;\nimport\ncryptoJS\nfrom\n\"crypto-js\"\n;\nimport\naxios\nfrom\n\"axios\"\n;\nimport\ndotenv\nfrom\n'dotenv'\n;\ndotenv\n.\nconfig\n(\n)\n;\n// Environment variables\nconst\napiKey\n=\nprocess\n.\nenv\n.\nOKX_API_KEY\n;\nconst\nsecretKey\n=\nprocess\n.\nenv\n.\nOKX_SECRET_KEY\n;\nconst\napiPassphrase\n=\nprocess\n.\nenv\n.\nOKX_API_PASSPHRASE\n;\nconst\nprojectId\n=\nprocess\n.\nenv\n.\nOKX_PROJECT_ID\n;\nconst\nuserAddress\n=\nprocess\n.\nenv\n.\nWALLET_ADDRESS\n;\nconst\nuserPrivateKey\n=\nprocess\n.\nenv\n.\nPRIVATE_KEY\n;\nconst\nsolanaRpcUrl\n=\nprocess\n.\nenv\n.\nSOLANA_RPC_URL\n;\n// Constants\nconst\nSOLANA_CHAIN_ID\n=\n\"501\"\n;\n// Solana Mainnet\nconst\nCOMPUTE_UNITS\n=\n300000\n;\nconst\nMAX_RETRIES\n=\n3\n;\nconst\nCONFIRMATION_TIMEOUT\n=\n60000\n;\nconst\nPOLLING_INTERVAL\n=\n5000\n;\nconst\nBASE_URL\n=\n\"https://web3.okx.com\"\n;\nconst\nDEX_PATH\n=\n\"api/v5/dex\"\n;\n// Initialize Solana connection\nconst\nconnection\n=\nnew\nConnection\n(\nsolanaRpcUrl\n||\n\"https://api.mainnet-beta.solana.com\"\n,\n{\nconfirmTransactionInitialTimeout\n:\n30000\n}\n)\n;\n// ======== Utility Functions ========\n/**\n* Generate API authentication headers\n*/\nfunction\ngetHeaders\n(\ntimestamp\n:\nstring\n,\nmethod\n:\nstring\n,\nrequestPath\n:\nstring\n,\nqueryString\n=\n\"\"\n,\nbody\n=\n\"\"\n)\n{\nif\n(\n!\napiKey\n||\n!\nsecretKey\n||\n!\napiPassphrase\n||\n!\nprojectId\n)\n{\nthrow\nnew\nError\n(\n\"Missing required environment variables for API authentication\"\n)\n;\n}\nconst\nstringToSign\n=\ntimestamp\n+\nmethod\n+\nrequestPath\n+\n(\nqueryString\n||\nbody\n)\n;\nreturn\n{\n\"Content-Type\"\n:\n\"application/json\"\n,\n\"OK-ACCESS-KEY\"\n:\napiKey\n,\n\"OK-ACCESS-SIGN\"\n:\ncryptoJS\n.\nenc\n.\nBase64\n.\nstringify\n(\ncryptoJS\n.\nHmacSHA256\n(\nstringToSign\n,\nsecretKey\n)\n)\n,\n\"OK-ACCESS-TIMESTAMP\"\n:\ntimestamp\n,\n\"OK-ACCESS-PASSPHRASE\"\n:\napiPassphrase\n,\n\"OK-ACCESS-PROJECT\"\n:\nprojectId\n,\n}\n;\n}\n/**\n* Convert human-readable amount to the smallest token units\n*/\nfunction\nconvertAmount\n(\namount\n:\nstring\n,\ndecimals\n:\nnumber\n)\n:\nstring\n{\ntry\n{\nif\n(\n!\namount\n||\nisNaN\n(\nparseFloat\n(\namount\n)\n)\n)\n{\nthrow\nnew\nError\n(\n\"Invalid amount\"\n)\n;\n}\nconst\nvalue\n=\nparseFloat\n(\namount\n)\n;\nif\n(\nvalue\n<=\n0\n)\n{\nthrow\nnew\nError\n(\n\"Amount must be greater than 0\"\n)\n;\n}\nreturn\nnew\nBN\n(\nvalue\n*\nMath\n.\npow\n(\n10\n,\ndecimals\n)\n)\n.\ntoString\n(\n)\n;\n}\ncatch\n(\nerr\n)\n{\nconsole\n.\nerror\n(\n\"Amount conversion error:\"\n,\nerr\n)\n;\nthrow\nnew\nError\n(\n\"Invalid amount format\"\n)\n;\n}\n}\n/**\n* Get token information from the API\n*/\nasync\nfunction\ngetTokenInfo\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n)\n{\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\npath\n=\n`\n${\nDEX_PATH\n}\n/aggregator/quote\n`\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nparams\n:\nRecord\n<\nstring\n,\nstring\n>\n=\n{\nchainId\n:\nSOLANA_CHAIN_ID\n,\nfromTokenAddress\n,\ntoTokenAddress\n,\namount\n:\n\"1000000\"\n,\n// Small amount just to get token info\nslippage\n:\n\"0.5\"\n,\n}\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n\"GET\"\n,\nrequestPath\n,\nqueryString\n)\n;\ntry\n{\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\n`\n${\nBASE_URL\n}\n${\nrequestPath\n}\n${\nqueryString\n}\n`\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n!==\n\"0\"\n||\n!\nresponse\n.\ndata\n.\ndata\n?.\n[\n0\n]\n)\n{\nthrow\nnew\nError\n(\n\"Failed to get token information\"\n)\n;\n}\nconst\nquoteData\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\nreturn\n{\nfromToken\n:\n{\nsymbol\n:\nquoteData\n.\nfromToken\n.\ntokenSymbol\n,\ndecimals\n:\nparseInt\n(\nquoteData\n.\nfromToken\n.\ndecimal\n)\n,\nprice\n:\nquoteData\n.\nfromToken\n.\ntokenUnitPrice\n}\n,\ntoToken\n:\n{\nsymbol\n:\nquoteData\n.\ntoToken\n.\ntokenSymbol\n,\ndecimals\n:\nparseInt\n(\nquoteData\n.\ntoToken\n.\ndecimal\n)\n,\nprice\n:\nquoteData\n.\ntoToken\n.\ntokenUnitPrice\n}\n}\n;\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n\"Error fetching token information:\"\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n// ======== Pre-Transaction Functionality ========\n/**\n* Get swap data from the API\n*/\nasync\nfunction\ngetSwapData\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n,\namount\n:\nstring\n,\nslippage\n=\n'0.5'\n)\n{\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\npath\n=\n`\n${\nDEX_PATH\n}\n/aggregator/swap\n`\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\n// Ensure all parameters are defined before creating URLSearchParams\nconst\nparams\n:\nRecord\n<\nstring\n,\nstring\n>\n=\n{\namount\n,\nchainId\n:\nSOLANA_CHAIN_ID\n,\nfromTokenAddress\n,\ntoTokenAddress\n,\nslippage\n}\n;\n// Only add userWalletAddress if it's defined\nif\n(\nuserAddress\n)\n{\nparams\n.\nuserWalletAddress\n=\nuserAddress\n;\n}\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n\"GET\"\n,\nrequestPath\n,\nqueryString\n)\n;\ntry\n{\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\n`\n${\nBASE_URL\n}\n${\nrequestPath\n}\n${\nqueryString\n}\n`\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n!==\n\"0\"\n||\n!\nresponse\n.\ndata\n.\ndata\n?.\n[\n0\n]\n)\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n\"Failed to get swap data\"\n}\n`\n)\n;\n}\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n\"Error fetching swap data:\"\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n/**\n* Prepare the transaction with the latest blockhash and compute units\n*/\nasync\nfunction\nprepareTransaction\n(\ncallData\n:\nstring\n)\n{\ntry\n{\n// Decode the base58 encoded transaction data\nconst\ndecodedTransaction\n=\nbase58\n.\ndecode\n(\ncallData\n)\n;\n// Get the latest blockhash for transaction freshness\nconst\nrecentBlockHash\n=\nawait\nconnection\n.\ngetLatestBlockhash\n(\n)\n;\nconsole\n.\nlog\n(\n\"Got blockhash:\"\n,\nrecentBlockHash\n.\nblockhash\n)\n;\nlet\ntx\n;\n// Try to deserialize as a versioned transaction first (Solana v0 transaction format)\ntry\n{\ntx\n=\nsolanaWeb3\n.\nVersionedTransaction\n.\ndeserialize\n(\ndecodedTransaction\n)\n;\nconsole\n.\nlog\n(\n\"Successfully created versioned transaction\"\n)\n;\ntx\n.\nmessage\n.\nrecentBlockhash\n=\nrecentBlockHash\n.\nblockhash\n;\n}\ncatch\n(\ne\n)\n{\n// Fall back to legacy transaction if versioned fails\nconsole\n.\nlog\n(\n\"Versioned transaction failed, trying legacy format\"\n)\n;\ntx\n=\nsolanaWeb3\n.\nTransaction\n.\nfrom\n(\ndecodedTransaction\n)\n;\nconsole\n.\nlog\n(\n\"Successfully created legacy transaction\"\n)\n;\ntx\n.\nrecentBlockhash\n=\nrecentBlockHash\n.\nblockhash\n;\n// Add compute budget instruction for complex swaps (only for legacy transactions)\n// For versioned transactions, this would already be included in the message\nconst\ncomputeBudgetIx\n=\nsolanaWeb3\n.\nComputeBudgetProgram\n.\nsetComputeUnitLimit\n(\n{\nunits\n:\nCOMPUTE_UNITS\n}\n)\n;\ntx\n.\nadd\n(\ncomputeBudgetIx\n)\n;\n}\nreturn\n{\ntransaction\n:\ntx\n,\nrecentBlockHash\n}\n;\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n\"Error preparing transaction:\"\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n/**\n* Sign the transaction with user's private key\n*/\nasync\nfunction\nsignTransaction\n(\ntx\n:\nsolanaWeb3\n.\nTransaction\n|\nsolanaWeb3\n.\nVersionedTransaction\n)\n{\nif\n(\n!\nuserPrivateKey\n)\n{\nthrow\nnew\nError\n(\n\"Private key not found\"\n)\n;\n}\nconst\nfeePayer\n=\nsolanaWeb3\n.\nKeypair\n.\nfromSecretKey\n(\nbase58\n.\ndecode\n(\nuserPrivateKey\n)\n)\n;\nif\n(\ntx\ninstanceof\nsolanaWeb3\n.\nVersionedTransaction\n)\n{\ntx\n.\nsign\n(\n[\nfeePayer\n]\n)\n;\n}\nelse\n{\ntx\n.\npartialSign\n(\nfeePayer\n)\n;\n}\nreturn\ntx\n;\n}\n/**\n* Broadcast transaction using Onchain gateway API\n*/\nasync\nfunction\nbroadcastTransaction\n(\nsignedTx\n:\nsolanaWeb3\n.\nTransaction\n|\nsolanaWeb3\n.\nVersionedTransaction\n)\n{\ntry\n{\nconst\nserializedTx\n=\nsignedTx\n.\nserialize\n(\n)\n;\nconst\nencodedTx\n=\nbase58\n.\nencode\n(\nserializedTx\n)\n;\nconst\npath\n=\n`\n${\nDEX_PATH\n}\n/pre-transaction/broadcast-transaction\n`\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\n// Ensure all parameters are defined\nconst\nbroadcastData\n:\nRecord\n<\nstring\n,\nstring\n>\n=\n{\nsignedTx\n:\nencodedTx\n,\nchainIndex\n:\nSOLANA_CHAIN_ID\n}\n;\n// Only add address if it's defined\nif\n(\nuserAddress\n)\n{\nbroadcastData\n.\naddress\n=\nuserAddress\n;\n}\n// Prepare authentication with body included in signature\nconst\nbodyString\n=\nJSON\n.\nstringify\n(\nbroadcastData\n)\n;\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'POST'\n,\nrequestPath\n,\n\"\"\n,\nbodyString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\npost\n(\n`\n${\nBASE_URL\n}\n${\nrequestPath\n}\n`\n,\nbroadcastData\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nconst\norderId\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norderId\n;\nconsole\n.\nlog\n(\n`\nTransaction broadcast successfully, Order ID:\n${\norderId\n}\n`\n)\n;\nreturn\norderId\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to broadcast transaction:'\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n// ======== Post-Transaction Monitoring ========\n// Define error info interface\ninterface\nTxErrorInfo\n{\nerror\n:\nstring\n;\nmessage\n:\nstring\n;\naction\n:\nstring\n;\n}\n/**\n * Monitor transaction status using Onchain gateway API\n *\n@param\norderId\n- Order ID from broadcast response\n *\n@param\nintervalMs\n- Polling interval in milliseconds\n *\n@param\ntimeoutMs\n- Maximum time to wait\n *\n@returns\nFinal transaction status\n */\nasync\nfunction\ntrackTransaction\n(\norderId\n:\nstring\n,\nintervalMs\n:\nnumber\n=\nPOLLING_INTERVAL\n,\ntimeoutMs\n:\nnumber\n=\nCONFIRMATION_TIMEOUT\n)\n:\nPromise\n<\nany\n>\n{\nconsole\n.\nlog\n(\n`\nMonitoring transaction with Order ID:\n${\norderId\n}\n`\n)\n;\nconst\nstartTime\n=\nDate\n.\nnow\n(\n)\n;\nlet\nlastStatus\n=\n''\n;\nwhile\n(\nDate\n.\nnow\n(\n)\n-\nstartTime\n<\ntimeoutMs\n)\n{\n// Get transaction status\ntry\n{\nconst\npath\n=\n`\n${\nDEX_PATH\n}\n/post-transaction/orders\n`\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\n// Ensure all parameters are defined before creating URLSearchParams\nconst\nparams\n:\nRecord\n<\nstring\n,\nstring\n>\n=\n{\norderId\n:\norderId\n,\nchainIndex\n:\nSOLANA_CHAIN_ID\n,\nlimit\n:\n'1'\n}\n;\n// Only add address if it's defined\nif\n(\nuserAddress\n)\n{\nparams\n.\naddress\n=\nuserAddress\n;\n}\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\n`\n${\nBASE_URL\n}\n${\nrequestPath\n}\n${\nqueryString\n}\n`\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n&&\nresponse\n.\ndata\n.\ndata\n&&\nresponse\n.\ndata\n.\ndata\n.\nlength\n>\n0\n)\n{\nif\n(\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n&&\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n.\nlength\n>\n0\n)\n{\nconst\ntxData\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n[\n0\n]\n;\n// Use txStatus to match the API response\nconst\nstatus\n=\ntxData\n.\ntxStatus\n;\n// Only log when status changes\nif\n(\nstatus\n!==\nlastStatus\n)\n{\nlastStatus\n=\nstatus\n;\nif\n(\nstatus\n===\n'1'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction pending:\n${\ntxData\n.\ntxHash\n||\n'Hash not available yet'\n}\n`\n)\n;\n}\nelse\nif\n(\nstatus\n===\n'2'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction successful: https://solscan.io/tx/\n${\ntxData\n.\ntxHash\n}\n`\n)\n;\nreturn\ntxData\n;\n}\nelse\nif\n(\nstatus\n===\n'3'\n)\n{\nconst\nfailReason\n=\ntxData\n.\nfailReason\n||\n'Unknown reason'\n;\nconst\nerrorMessage\n=\n`\nTransaction failed:\n${\nfailReason\n}\n`\n;\nconsole\n.\nerror\n(\nerrorMessage\n)\n;\nconst\nerrorInfo\n=\nhandleTransactionError\n(\ntxData\n)\n;\nconsole\n.\nlog\n(\n`\nError type:\n${\nerrorInfo\n.\nerror\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nSuggested action:\n${\nerrorInfo\n.\naction\n}\n`\n)\n;\nthrow\nnew\nError\n(\nerrorMessage\n)\n;\n}\n}\n}\nelse\n{\nconsole\n.\nlog\n(\n`\nNo orders found for Order ID:\n${\norderId\n}\n`\n)\n;\n}\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nwarn\n(\n'Error checking transaction status:'\n,\n(\nerror\ninstanceof\nError\n?\nerror\n.\nmessage\n:\n\"Unknown error\"\n)\n)\n;\n}\n// Wait before next check\nawait\nnew\nPromise\n(\nresolve\n=>\nsetTimeout\n(\nresolve\n,\nintervalMs\n)\n)\n;\n}\nthrow\nnew\nError\n(\n'Transaction monitoring timed out'\n)\n;\n}\n/**\n * error handling with failReason\n *\n@param\ntxData\n- Transaction data from post-transaction/orders\n *\n@returns\nStructured error information\n */\nfunction\nhandleTransactionError\n(\ntxData\n:\nany\n)\n:\nTxErrorInfo\n{\nconst\nfailReason\n=\ntxData\n.\nfailReason\n||\n'Unknown reason'\n;\n// Log the detailed error\nconsole\n.\nerror\n(\n`\nTransaction failed with reason:\n${\nfailReason\n}\n`\n)\n;\n// Default error handling\nreturn\n{\nerror\n:\n'TRANSACTION_FAILED'\n,\nmessage\n:\nfailReason\n,\naction\n:\n'Try again or contact support'\n}\n;\n}\n// ======== Main Swap Execution Function ========\n/**\n* Execute a token swap on Solana\n*/\nasync\nfunction\nexecuteSwap\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n,\namount\n:\nstring\n,\nslippage\n:\nstring\n=\n'0.5'\n)\n:\nPromise\n<\nany\n>\n{\ntry\n{\n// Validate inputs\nif\n(\n!\nuserPrivateKey\n)\n{\nthrow\nnew\nError\n(\n\"Missing private key\"\n)\n;\n}\nif\n(\n!\nuserAddress\n)\n{\nthrow\nnew\nError\n(\n\"Missing wallet address\"\n)\n;\n}\n// Step 1: Get swap data from OKX DEX API\nconsole\n.\nlog\n(\n\"Getting swap data...\"\n)\n;\nconst\nswapData\n=\nawait\ngetSwapData\n(\nfromTokenAddress\n,\ntoTokenAddress\n,\namount\n,\nslippage\n)\n;\nconsole\n.\nlog\n(\n\"Swap route obtained\"\n)\n;\n// Step 2: Get the transaction data\nconst\ncallData\n=\nswapData\n.\ntx\n.\ndata\n;\nif\n(\n!\ncallData\n)\n{\nthrow\nnew\nError\n(\n\"Invalid transaction data received from API\"\n)\n;\n}\n// Step 3: Prepare the transaction with compute units\nconst\n{\ntransaction\n,\nrecentBlockHash\n}\n=\nawait\nprepareTransaction\n(\ncallData\n)\n;\nconsole\n.\nlog\n(\n\"Transaction prepared with compute unit limit:\"\n,\nCOMPUTE_UNITS\n)\n;\n// Step 4: Sign the transaction\nconst\nsignedTx\n=\nawait\nsignTransaction\n(\ntransaction\n)\n;\nconsole\n.\nlog\n(\n\"Transaction signed\"\n)\n;\n// Step 5: Broadcast the transaction using Onchain gateway API\nconst\norderId\n=\nawait\nbroadcastTransaction\n(\nsignedTx\n)\n;\nconsole\n.\nlog\n(\n`\nTransaction broadcast successful with order ID:\n${\norderId\n}\n`\n)\n;\n// Step 6: Monitor the transaction status\nconsole\n.\nlog\n(\n\"Monitoring transaction status...\"\n)\n;\nconst\ntxStatus\n=\nawait\ntrackTransaction\n(\norderId\n)\n;\nreturn\n{\nsuccess\n:\ntrue\n,\norderId\n,\ntxHash\n:\ntxStatus\n.\ntxHash\n,\nstatus\n:\ntxStatus\n.\ntxStatus\n===\n'2'\n?\n'SUCCESS'\n:\n'PENDING'\n}\n;\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n\"Error during swap:\"\n,\nerror\n)\n;\nreturn\n{\nsuccess\n:\nfalse\n,\nerror\n:\nerror\ninstanceof\nError\n?\nerror\n.\nmessage\n:\n\"Unknown error\"\n}\n;\n}\n}\n// ======== Command Line Interface ========\nasync\nfunction\nmain\n(\n)\n{\ntry\n{\nconst\nargs\n=\nprocess\n.\nargv\n.\nslice\n(\n2\n)\n;\nif\n(\nargs\n.\nlength\n<\n3\n)\n{\nconsole\n.\nlog\n(\n\"Usage: ts-node solana-swap.ts <amount> <fromTokenAddress> <toTokenAddress> [<slippage>]\"\n)\n;\nconsole\n.\nlog\n(\n\"Example: ts-node solana-swap.ts 0.1 11111111111111111111111111111111 EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v 0.5\"\n)\n;\nprocess\n.\nexit\n(\n1\n)\n;\n}\nconst\n[\namountStr\n,\nfromTokenAddress\n,\ntoTokenAddress\n,\nslippage\n=\n'0.5'\n]\n=\nargs\n;\n// Get token information\nconsole\n.\nlog\n(\n\"Getting token information...\"\n)\n;\nconst\ntokenInfo\n=\nawait\ngetTokenInfo\n(\nfromTokenAddress\n,\ntoTokenAddress\n)\n;\nconsole\n.\nlog\n(\n`\nFrom:\n${\ntokenInfo\n.\nfromToken\n.\nsymbol\n}\n(\n${\ntokenInfo\n.\nfromToken\n.\ndecimals\n}\ndecimals)\n`\n)\n;\nconsole\n.\nlog\n(\n`\nTo:\n${\ntokenInfo\n.\ntoToken\n.\nsymbol\n}\n(\n${\ntokenInfo\n.\ntoToken\n.\ndecimals\n}\ndecimals)\n`\n)\n;\n// Convert amount using fetched decimals\nconst\nrawAmount\n=\nconvertAmount\n(\namountStr\n,\ntokenInfo\n.\nfromToken\n.\ndecimals\n)\n;\nconsole\n.\nlog\n(\n`\nAmount in\n${\ntokenInfo\n.\nfromToken\n.\nsymbol\n}\nbase units:\n`\n,\nrawAmount\n)\n;\n// Execute swap\nconsole\n.\nlog\n(\n\"\\nExecuting swap...\"\n)\n;\nconst\nresult\n=\nawait\nexecuteSwap\n(\nfromTokenAddress\n,\ntoTokenAddress\n,\nrawAmount\n,\nslippage\n)\n;\nif\n(\nresult\n.\nsuccess\n)\n{\nconsole\n.\nlog\n(\n\"\\nSwap completed successfully!\"\n)\n;\nconsole\n.\nlog\n(\n\"Order ID:\"\n,\nresult\n.\norderId\n)\n;\nif\n(\nresult\n.\ntxHash\n)\n{\nconsole\n.\nlog\n(\n\"Transaction ID:\"\n,\nresult\n.\ntxHash\n)\n;\nconsole\n.\nlog\n(\n\"Explorer URL:\"\n,\n`\nhttps://solscan.io/tx/\n${\nresult\n.\ntxHash\n}\n`\n)\n;\n}\n}\nelse\n{\nconsole\n.\nerror\n(\n\"\\nSwap failed:\"\n,\nresult\n.\nerror\n)\n;\n}\nprocess\n.\nexit\n(\nresult\n.\nsuccess\n?\n0\n:\n1\n)\n;\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n\"Error:\"\n,\nerror\ninstanceof\nError\n?\nerror\n.\nmessage\n:\n\"Unknown error\"\n)\n;\nprocess\n.\nexit\n(\n1\n)\n;\n}\n}\n// Execute main function if run directly\nif\n(\nrequire\n.\nmain\n===\nmodule\n)\n{\nmain\n(\n)\n;\n}\n// Export functions for modular usage\nexport\n{\nexecuteSwap\n,\nbroadcastTransaction\n,\ntrackTransaction\n,\nprepareTransaction\n}\n;\n7. MEV保护\n#\nSolana交易存在MEV（最大可提取价值）风险。虽然MEV保护不直接包含在SDK中，但您可以使用API优先的方法自行实施。\n第一道防线使用动态优先级费用-将其视为您在拍卖中对抗MEV机器人的出价。\nconst\nMEV_PROTECTION\n=\n{\n// Trade Protection\nMAX_PRICE_IMPACT\n:\n\"0.05\"\n,\n// 5% max price impact\nSLIPPAGE\n:\n\"0.05\"\n,\n// 5% slippage tolerance\nMIN_ROUTES\n:\n2\n,\n// Minimum DEX routes\n// Priority Fees\nMIN_PRIORITY_FEE\n:\n10_000\n,\nMAX_PRIORITY_FEE\n:\n1_000_000\n,\nPRIORITY_MULTIPLIER\n:\n2\n,\n// TWAP Settings\nTWAP_ENABLED\n:\ntrue\n,\nTWAP_INTERVALS\n:\n4\n,\n// Split into 4 parts\nTWAP_DELAY_MS\n:\n2000\n,\n// 2s between trades\n// Transaction Settings\nCOMPUTE_UNITS\n:\n300_000\n,\nMAX_RETRIES\n:\n3\n,\nCONFIRMATION_TIMEOUT\n:\n60_000\n,\n// Block Targeting\nTARGET_SPECIFIC_BLOCKS\n:\ntrue\n,\nPREFERRED_SLOT_OFFSET\n:\n2\n,\n// Target blocks with slot % 4 == 2\n}\nas\nconst\n;\nstatic\nasync\ngetPriorityFee\n(\n)\n{\nconst\nrecentFees\n=\nawait\nconnection\n.\ngetRecentPrioritizationFees\n(\n)\n;\nconst\nmaxFee\n=\nMath\n.\nmax\n(\n...\nrecentFees\n.\nmap\n(\nfee\n=>\nfee\n.\nprioritizationFee\n)\n)\n;\nreturn\nMath\n.\nmin\n(\nmaxFee\n*\n1.5\n,\nMEV_PROTECTION\n.\nMAX_PRIORITY_FEE\n)\n;\n}\n对于较大的交易，您可以启用TWAP（时间加权平均价格）。您的交易将被分成更小的部分，而不是MEV机器人喜欢瞄准的一个大的飞溅。\n// Define the TWAPExecution class outside of the if block\nclass\nTWAPExecution\n{\nstatic\nasync\nsplitTrade\n(\ntotalAmount\n:\nstring\n,\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n)\n:\nPromise\n<\nTradeChunk\n[\n]\n>\n{\nconst\namount\n=\nnew\nBN\n(\ntotalAmount\n)\n;\nconst\nchunkSize\n=\namount\n.\ndivn\n(\nMEV_PROTECTION\n.\nTWAP_INTERVALS\n)\n;\nreturn\nArray\n(\nMEV_PROTECTION\n.\nTWAP_INTERVALS\n)\n.\nfill\n(\nnull\n)\n.\nmap\n(\n(\n)\n=>\n(\n{\namount\n:\nchunkSize\n.\ntoString\n(\n)\n,\nfromTokenAddress\n,\ntoTokenAddress\n,\nminAmountOut\n:\n\"0\"\n// Will be calculated per chunk\n}\n)\n)\n;\n}\n}\n// Then use it in the if block\nif\n(\nMEV_PROTECTION\n.\nTWAP_ENABLED\n)\n{\nconst\nchunks\n=\nawait\nTWAPExecution\n.\nsplitTrade\n(\nrawAmount\n,\nfromTokenAddress\n,\ntoTokenAddress\n)\n;\n}\n运行中防护\n#\n当您使用\n此实现\n执行交易时，会发生几件事情：\n交易前检查：\n购买的代币会被检查是否存在貔貅盘特征\n检查你的网络费用来设置有竞争力的优先费用\n查看你的交易额度来确认是否要拆单\n在交易期间：\n大额交易将拆分成不同金额的单子，并在随机时间发出\n每单将根据市场条件设置优先费用\n特定的区块来减少暴露风险\n交易的安全性保障：\n每笔交易都将进行预执行模拟\n对区块确认状态进行内置的追踪\n出现问题自动重试逻辑\n虽然Solana上的MEV不能完全消除，但这些保护措施使MEV机器人的生活更加困难。\n方法2：SDK方法\n#\n使用OKX DEXSDK提供了更简单的开发人员体验，同时保留了API方法的所有功能。SDK为您处理许多实现细节，包括重试逻辑、错误处理和事务管理。\n1.安装SDK\n#\nnpm\ninstall\n@okx-dex/okx-dex-sdk\n# or\nyarn\nadd\n@okx-dex/okx-dex-sdk\n# or\npnpm\nadd\n@okx-dex/okx-dex-sdk\n2.设置环境\n#\n使用您的API凭据和钱包信息创建一个. env文件：\n# OKX API Credentials\nOKX_API_KEY\n=\nyour_api_key\nOKX_SECRET_KEY\n=\nyour_secret_key\nOKX_API_PASSPHRASE\n=\nyour_passphrase\nOKX_PROJECT_ID\n=\nyour_project_id\n# Solana Configuration\nSOLANA_RPC_URL\n=\nyour_solana_rpc_url\nSOLANA_WALLET_ADDRESS\n=\nyour_solana_wallet_address\nSOLANA_PRIVATE_KEY\n=\nyour_solana_private_key\n3.初始化客户端\n#\n为您的DEX客户端创建一个文件（例如，DexClient. ts）：\n// DexClient.ts\nimport\n{\nOKXDexClient\n}\nfrom\n'@okx-dex/okx-dex-sdk'\n;\nimport\n'dotenv/config'\n;\n// Validate environment variables\nconst\nrequiredEnvVars\n=\n[\n'OKX_API_KEY'\n,\n'OKX_SECRET_KEY'\n,\n'OKX_API_PASSPHRASE'\n,\n'OKX_PROJECT_ID'\n,\n'SOLANA_WALLET_ADDRESS'\n,\n'SOLANA_PRIVATE_KEY'\n,\n'SOLANA_RPC_URL'\n]\n;\nfor\n(\nconst\nenvVar\nof\nrequiredEnvVars\n)\n{\nif\n(\n!\nprocess\n.\nenv\n[\nenvVar\n]\n)\n{\nthrow\nnew\nError\n(\n`\nMissing required environment variable:\n${\nenvVar\n}\n`\n)\n;\n}\n}\n// Initialize the client\nexport\nconst\nclient\n=\nnew\nOKXDexClient\n(\n{\napiKey\n:\nprocess\n.\nenv\n.\nOKX_API_KEY\n!\n,\nsecretKey\n:\nprocess\n.\nenv\n.\nOKX_SECRET_KEY\n!\n,\napiPassphrase\n:\nprocess\n.\nenv\n.\nOKX_API_PASSPHRASE\n!\n,\nprojectId\n:\nprocess\n.\nenv\n.\nOKX_PROJECT_ID\n!\n,\nsolana\n:\n{\nconnection\n:\n{\nrpcUrl\n:\nprocess\n.\nenv\n.\nSOLANA_RPC_URL\n!\n,\nwsEndpoint\n:\nprocess\n.\nenv\n.\nSOLANA_WS_URL\n,\nconfirmTransactionInitialTimeout\n:\n5000\n}\n,\nwalletAddress\n:\nprocess\n.\nenv\n.\nSOLANA_WALLET_ADDRESS\n!\n,\nprivateKey\n:\nprocess\n.\nenv\n.\nSOLANA_PRIVATE_KEY\n!\n,\ncomputeUnits\n:\n300000\n,\nmaxRetries\n:\n3\n}\n}\n)\n;\n4.调用SDK执行兑换\n#\n创建兑换执行的文件：\n// swap.ts\nimport\n{\nclient\n}\nfrom\n'./DexClient'\n;\n/**\n* Example: Execute a swap from SOL to USDC\n*/\nasync\nfunction\nexecuteSwap\n(\n)\n{\ntry\n{\nif\n(\n!\nprocess\n.\nenv\n.\nSOLANA_PRIVATE_KEY\n)\n{\nthrow\nnew\nError\n(\n'Missing SOLANA_PRIVATE_KEY in .env file'\n)\n;\n}\n// Get quote to fetch token information\nconsole\n.\nlog\n(\n\"Getting token information...\"\n)\n;\nconst\nquote\n=\nawait\nclient\n.\ndex\n.\ngetQuote\n(\n{\nchainId\n:\n'501'\n,\nfromTokenAddress\n:\n'11111111111111111111111111111111'\n,\n// SOL\ntoTokenAddress\n:\n'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'\n,\n// USDC\namount\n:\n'1000000'\n,\n// Small amount for quote\nslippage\n:\n'0.5'\n}\n)\n;\nconst\ntokenInfo\n=\n{\nfromToken\n:\n{\nsymbol\n:\nquote\n.\ndata\n[\n0\n]\n.\nfromToken\n.\ntokenSymbol\n,\ndecimals\n:\nparseInt\n(\nquote\n.\ndata\n[\n0\n]\n.\nfromToken\n.\ndecimal\n)\n,\nprice\n:\nquote\n.\ndata\n[\n0\n]\n.\nfromToken\n.\ntokenUnitPrice\n}\n,\ntoToken\n:\n{\nsymbol\n:\nquote\n.\ndata\n[\n0\n]\n.\ntoToken\n.\ntokenSymbol\n,\ndecimals\n:\nparseInt\n(\nquote\n.\ndata\n[\n0\n]\n.\ntoToken\n.\ndecimal\n)\n,\nprice\n:\nquote\n.\ndata\n[\n0\n]\n.\ntoToken\n.\ntokenUnitPrice\n}\n}\n;\n// Convert amount to base units (for display purposes)\nconst\nhumanReadableAmount\n=\n0.1\n;\n// 0.1 SOL\nconst\nrawAmount\n=\n(\nhumanReadableAmount\n*\nMath\n.\npow\n(\n10\n,\ntokenInfo\n.\nfromToken\n.\ndecimals\n)\n)\n.\ntoString\n(\n)\n;\nconsole\n.\nlog\n(\n\"\\nSwap Details:\"\n)\n;\nconsole\n.\nlog\n(\n\"--------------------\"\n)\n;\nconsole\n.\nlog\n(\n`\nFrom:\n${\ntokenInfo\n.\nfromToken\n.\nsymbol\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nTo:\n${\ntokenInfo\n.\ntoToken\n.\nsymbol\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nAmount:\n${\nhumanReadableAmount\n}\n${\ntokenInfo\n.\nfromToken\n.\nsymbol\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nAmount in base units:\n${\nrawAmount\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nApproximate USD value: $\n${\n(\nhumanReadableAmount\n*\nparseFloat\n(\ntokenInfo\n.\nfromToken\n.\nprice\n)\n)\n.\ntoFixed\n(\n2\n)\n}\n`\n)\n;\n// Execute the swap\nconsole\n.\nlog\n(\n\"\\nExecuting swap...\"\n)\n;\nconst\nswapResult\n=\nawait\nclient\n.\ndex\n.\nexecuteSwap\n(\n{\nchainId\n:\n'501'\n,\n// Solana chain ID\nfromTokenAddress\n:\n'11111111111111111111111111111111'\n,\n// SOL\ntoTokenAddress\n:\n'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'\n,\n// USDC\namount\n:\nrawAmount\n,\nslippage\n:\n'0.5'\n,\n// 0.5% slippage\nuserWalletAddress\n:\nprocess\n.\nenv\n.\nSOLANA_WALLET_ADDRESS\n!\n}\n)\n;\nconsole\n.\nlog\n(\n'Swap executed successfully:'\n)\n;\nconsole\n.\nlog\n(\nJSON\n.\nstringify\n(\nswapResult\n,\nnull\n,\n2\n)\n)\n;\nreturn\nswapResult\n;\n}\ncatch\n(\nerror\n)\n{\nif\n(\nerror\ninstanceof\nError\n)\n{\nconsole\n.\nerror\n(\n'Error executing swap:'\n,\nerror\n.\nmessage\n)\n;\n// API errors include details in the message\nif\n(\nerror\n.\nmessage\n.\nincludes\n(\n'API Error:'\n)\n)\n{\nconst\nmatch\n=\nerror\n.\nmessage\n.\nmatch\n(\n/\nAPI Error:\n(\n.\n*\n)\n/\n)\n;\nif\n(\nmatch\n)\nconsole\n.\nerror\n(\n'API Error Details:'\n,\nmatch\n[\n1\n]\n)\n;\n}\n}\nthrow\nerror\n;\n}\n}\n// Run if this file is executed directly\nif\n(\nrequire\n.\nmain\n===\nmodule\n)\n{\nexecuteSwap\n(\n)\n.\nthen\n(\n(\n)\n=>\nprocess\n.\nexit\n(\n0\n)\n)\n.\ncatch\n(\n(\nerror\n)\n=>\n{\nconsole\n.\nerror\n(\n'Error:'\n,\nerror\n)\n;\nprocess\n.\nexit\n(\n1\n)\n;\n}\n)\n;\n}\nexport\n{\nexecuteSwap\n}\n;\n5.附加SDK功能\n#\nSDK提供了简化开发的附加方法：\n获取代币对的报价\nconst\nquote\n=\nawait\nclient\n.\ndex\n.\ngetQuote\n(\n{\nchainId\n:\n'501'\n,\n// Solana\nfromTokenAddress\n:\n'11111111111111111111111111111111'\n,\n// SOL\ntoTokenAddress\n:\n'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'\n,\n// USDC\namount\n:\n'100000000'\n,\n// 0.1 SOL (in lamports)\nslippage\n:\n'0.5'\n// 0.5%\n}\n)\n;",
  "html": "<div class=\"routes_md__xWlGF\"><!--$--><h1 id=\"在-solana-链上搭建兑换应用\">在 Solana 链上搭建兑换应用<a class=\"index_header-anchor__Xqb+L\" href=\"#在-solana-链上搭建兑换应用\" style=\"opacity:0\">#</a></h1>\n<p>在 Solana 上使用OKX DEX构建兑换应用程序有两种方法：</p>\n<ol>\n<li>API的方法-直接与OKX DEX API交互</li>\n<li>SDK方法-使用 <code>@okx-dex/okx-dex-sdk</code>简化开发人员体验</li>\n</ol>\n<p>本指南涵盖了这两种方法，以帮助你选择最适合你需求的方法。</p>\n<h2 data-content=\"方法1：API方法\" id=\"方法1：api方法\">方法1：API方法<a class=\"index_header-anchor__Xqb+L\" href=\"#方法1：api方法\" style=\"opacity:0\">#</a></h2>\n<p>在本指南中，我们将提供通过OKX DEX进行Solana代币兑换的用例。</p>\n<h2 data-content=\"1.设置环境\" id=\"1.设置环境\">1.设置环境<a class=\"index_header-anchor__Xqb+L\" href=\"#1.设置环境\" style=\"opacity:0\">#</a></h2>\n<p>导入必要的Node. js库并设置环境变量：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// Required libraries</span>\n<span class=\"token keyword\">import</span> base58 <span class=\"token keyword\">from</span> <span class=\"token string\">\"bs58\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token constant\">BN</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"bn.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> solanaWeb3 <span class=\"token keyword\">from</span> <span class=\"token string\">\"@solana/web3.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Connection <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@solana/web3.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> cryptoJS <span class=\"token keyword\">from</span> <span class=\"token string\">\"crypto-js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">\"axios\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> dotenv <span class=\"token keyword\">from</span> <span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">;</span>\n\ndotenv<span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Environment variables</span>\n<span class=\"token keyword\">const</span> apiKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_KEY</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> secretKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_SECRET_KEY</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> apiPassphrase <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_PASSPHRASE</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> projectId <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_PROJECT_ID</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> userAddress <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> userPrivateKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PRIVATE_KEY</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> solanaRpcUrl <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_RPC_URL</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Constants</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"501\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">COMPUTE_UNITS</span> <span class=\"token operator\">=</span> <span class=\"token number\">300000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_RETRIES</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Initialize Solana connection</span>\n<span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>solanaRpcUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    confirmTransactionInitialTimeout<span class=\"token operator\">:</span> <span class=\"token number\">5000</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// Utility function for OKX API authentication</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> method<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> body <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">const</span> stringToSign <span class=\"token operator\">=</span> timestamp <span class=\"token operator\">+</span> method <span class=\"token operator\">+</span> requestPath <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>queryString <span class=\"token operator\">||</span> body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string-property property\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-KEY\"</span><span class=\"token operator\">:</span> apiKey<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-SIGN\"</span><span class=\"token operator\">:</span> cryptoJS<span class=\"token punctuation\">.</span>enc<span class=\"token punctuation\">.</span>Base64<span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>\n            cryptoJS<span class=\"token punctuation\">.</span><span class=\"token function\">HmacSHA256</span><span class=\"token punctuation\">(</span>stringToSign<span class=\"token punctuation\">,</span> secretKey<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-TIMESTAMP\"</span><span class=\"token operator\">:</span> timestamp<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-PASSPHRASE\"</span><span class=\"token operator\">:</span> apiPassphrase<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-PROJECT\"</span><span class=\"token operator\">:</span> projectId<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"2.获取兑换数据\" id=\"2.获取兑换数据\">2.获取兑换数据<a class=\"index_header-anchor__Xqb+L\" href=\"#2.获取兑换数据\" style=\"opacity:0\">#</a></h2>\n<p>Solana的本机令牌地址11111111111111111111111111111111。使用/swap端点检索详细的兑换信息：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSwapData</span><span class=\"token punctuation\">(</span>\n    fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> \n    toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> \n    amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> \n    slippage <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token string\">\"/api/v5/dex/aggregator/swap\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        amount<span class=\"token operator\">:</span> amount<span class=\"token punctuation\">,</span>\n        chainId<span class=\"token operator\">:</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span><span class=\"token punctuation\">,</span>\n        fromTokenAddress<span class=\"token operator\">:</span> fromTokenAddress<span class=\"token punctuation\">,</span>\n        toTokenAddress<span class=\"token operator\">:</span> toTokenAddress<span class=\"token punctuation\">,</span>\n        userWalletAddress<span class=\"token operator\">:</span> userAddress<span class=\"token punctuation\">,</span>\n        slippage<span class=\"token operator\">:</span> slippage\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\n            <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>requestPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>queryString<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">!==</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token operator\">?.</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">\"Failed to get swap data\"</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error fetching swap data:\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"3.准备交易\" id=\"3.准备交易\">3.准备交易<a class=\"index_header-anchor__Xqb+L\" href=\"#3.准备交易\" style=\"opacity:0\">#</a></h2>\n<p>从 /swap 获得callData后，你需要反序列化并签名交易：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">prepareTransaction</span><span class=\"token punctuation\">(</span>callData<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Decode the base58 encoded transaction data</span>\n        <span class=\"token keyword\">const</span> decodedTransaction <span class=\"token operator\">=</span> base58<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>callData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Get the latest blockhash</span>\n        <span class=\"token keyword\">const</span> recentBlockHash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">getLatestBlockhash</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Got blockhash:\"</span><span class=\"token punctuation\">,</span> recentBlockHash<span class=\"token punctuation\">.</span>blockhash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">let</span> tx<span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Try to deserialize as a versioned transaction first</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            tx <span class=\"token operator\">=</span> solanaWeb3<span class=\"token punctuation\">.</span>VersionedTransaction<span class=\"token punctuation\">.</span><span class=\"token function\">deserialize</span><span class=\"token punctuation\">(</span>decodedTransaction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Successfully created versioned transaction\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            tx<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>recentBlockhash <span class=\"token operator\">=</span> recentBlockHash<span class=\"token punctuation\">.</span>blockhash<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// Fall back to legacy transaction if versioned fails</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Versioned transaction failed, trying legacy:\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            tx <span class=\"token operator\">=</span> solanaWeb3<span class=\"token punctuation\">.</span>Transaction<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>decodedTransaction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Successfully created legacy transaction\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            tx<span class=\"token punctuation\">.</span>recentBlockhash <span class=\"token operator\">=</span> recentBlockHash<span class=\"token punctuation\">.</span>blockhash<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            transaction<span class=\"token operator\">:</span> tx<span class=\"token punctuation\">,</span>\n            recentBlockHash\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error preparing transaction:\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">signTransaction</span><span class=\"token punctuation\">(</span>tx<span class=\"token operator\">:</span> solanaWeb3<span class=\"token punctuation\">.</span>Transaction <span class=\"token operator\">|</span> solanaWeb3<span class=\"token punctuation\">.</span>VersionedTransaction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>userPrivateKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Private key not found\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">const</span> feePayer <span class=\"token operator\">=</span> solanaWeb3<span class=\"token punctuation\">.</span>Keypair<span class=\"token punctuation\">.</span><span class=\"token function\">fromSecretKey</span><span class=\"token punctuation\">(</span>\n        base58<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>userPrivateKey<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tx <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">solanaWeb3</span><span class=\"token punctuation\">.</span>VersionedTransaction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        tx<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>feePayer<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        tx<span class=\"token punctuation\">.</span><span class=\"token function\">partialSign</span><span class=\"token punctuation\">(</span>feePayer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"4. 广播交易\" id=\"4.-广播交易\">4. 广播交易<a class=\"index_header-anchor__Xqb+L\" href=\"#4.-广播交易\" style=\"opacity:0\">#</a></h2>\n<p>4.1 使用 <code>RPC</code> 广播交易</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> txId <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">sendRawTransaction</span><span class=\"token punctuation\">(</span>tx<span class=\"token punctuation\">.</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Transaction ID:'</span><span class=\"token punctuation\">,</span> txId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Wait for confirmation</span>\n    <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">confirmTransaction</span><span class=\"token punctuation\">(</span>txId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction confirmed: https://solscan.io/tx/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>4.2 使用<code>交易上链 API</code>广播交易</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">broadcastTransaction</span><span class=\"token punctuation\">(</span>\n    signedTx<span class=\"token operator\">:</span> solanaWeb3<span class=\"token punctuation\">.</span>Transaction <span class=\"token operator\">|</span> solanaWeb3<span class=\"token punctuation\">.</span>VersionedTransaction\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> serializedTx <span class=\"token operator\">=</span> signedTx<span class=\"token punctuation\">.</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> encodedTx <span class=\"token operator\">=</span> base58<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>serializedTx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">\"dex/pre-transaction/broadcast-transaction\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">const</span> broadcastData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            signedTx<span class=\"token operator\">:</span> encodedTx<span class=\"token punctuation\">,</span>\n            chainIndex<span class=\"token operator\">:</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span><span class=\"token punctuation\">,</span>\n            address<span class=\"token operator\">:</span> userAddress\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Prepare authentication with body included in signature</span>\n        <span class=\"token keyword\">const</span> bodyString <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>broadcastData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> bodyString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> broadcastData<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> orderId <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orderId<span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction broadcast successfully, Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> orderId<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to broadcast transaction:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"5.追踪交易\" id=\"5.追踪交易\">5.追踪交易<a class=\"index_header-anchor__Xqb+L\" href=\"#5.追踪交易\" style=\"opacity:0\">#</a></h2>\n<p>使用<code>交易上链 API</code></p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// Define transaction status interface</span>\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">TxErrorInfo</span> <span class=\"token punctuation\">{</span>\n    error<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n    message<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n    action<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Tracking transaction confirmation status using the Onchain gateway API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">orderId</span> - Order ID from broadcast response\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">intervalMs</span> - Polling interval in milliseconds\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">timeoutMs</span> - Maximum time to wait\n * <span class=\"token keyword\">@returns</span> Final transaction confirmation status\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">trackTransaction</span><span class=\"token punctuation\">(</span>\n    orderId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    intervalMs<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">,</span>\n    timeoutMs<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">300000</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Tracking transaction with Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> startTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> lastStatus <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime <span class=\"token operator\">&lt;</span> timeoutMs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Get transaction status</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/post-transaction/orders'</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                orderId<span class=\"token operator\">:</span> orderId<span class=\"token punctuation\">,</span>\n                chainIndex<span class=\"token operator\">:</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span><span class=\"token punctuation\">,</span>\n                address<span class=\"token operator\">:</span> userAddress<span class=\"token punctuation\">,</span>\n                limit<span class=\"token operator\">:</span> <span class=\"token string\">'1'</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// Prepare authentication</span>\n            <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            \n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span> <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">const</span> txData <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                    \n                    <span class=\"token comment\">// Use txStatus to match the API response</span>\n                    <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>txStatus<span class=\"token punctuation\">;</span>\n\n                    <span class=\"token comment\">// Only log when status changes</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!==</span> lastStatus<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        lastStatus <span class=\"token operator\">=</span> status<span class=\"token punctuation\">;</span>\n\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction pending: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txHash <span class=\"token operator\">||</span> <span class=\"token string\">'Hash not available yet'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'2'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction successful: https://solscan.io/tx/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txHash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">return</span> txData<span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'3'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token keyword\">const</span> failReason <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>failReason <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">const</span> errorMessage <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>failReason<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                            <span class=\"token keyword\">const</span> errorInfo <span class=\"token operator\">=</span> <span class=\"token function\">handleTransactionError</span><span class=\"token punctuation\">(</span>txData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Error type: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>errorInfo<span class=\"token punctuation\">.</span>error<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Suggested action: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>errorInfo<span class=\"token punctuation\">.</span>action<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">No orders found for Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error checking transaction status:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">\"Unknown error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// Wait before next check</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span>resolve <span class=\"token operator\">=&gt;</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> intervalMs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Transaction tracking timed out'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Comprehensive error handling with failReason\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">txData</span> - Transaction data from post-transaction/orders\n * <span class=\"token keyword\">@returns</span> Structured error information\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleTransactionError</span><span class=\"token punctuation\">(</span>txData<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> TxErrorInfo <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> failReason <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>failReason <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Log the detailed error</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed with reason: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>failReason<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Default error info</span>\n    <span class=\"token keyword\">let</span> errorInfo<span class=\"token operator\">:</span> TxErrorInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        error<span class=\"token operator\">:</span> <span class=\"token string\">'TRANSACTION_FAILED'</span><span class=\"token punctuation\">,</span>\n        message<span class=\"token operator\">:</span> failReason<span class=\"token punctuation\">,</span>\n        action<span class=\"token operator\">:</span> <span class=\"token string\">'Try again or contact support'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// More specific error handling based on the failure reason</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>failReason<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'insufficient funds'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        errorInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            error<span class=\"token operator\">:</span> <span class=\"token string\">'INSUFFICIENT_FUNDS'</span><span class=\"token punctuation\">,</span>\n            message<span class=\"token operator\">:</span> <span class=\"token string\">'Your wallet does not have enough funds to complete this transaction'</span><span class=\"token punctuation\">,</span>\n            action<span class=\"token operator\">:</span> <span class=\"token string\">'Add more SOL to your wallet to cover the transaction'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>failReason<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'blockhash'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        errorInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            error<span class=\"token operator\">:</span> <span class=\"token string\">'BLOCKHASH_EXPIRED'</span><span class=\"token punctuation\">,</span>\n            message<span class=\"token operator\">:</span> <span class=\"token string\">'The transaction blockhash has expired'</span><span class=\"token punctuation\">,</span>\n            action<span class=\"token operator\">:</span> <span class=\"token string\">'Try again with a fresh transaction'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>failReason<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'compute budget'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        errorInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            error<span class=\"token operator\">:</span> <span class=\"token string\">'COMPUTE_BUDGET_EXCEEDED'</span><span class=\"token punctuation\">,</span>\n            message<span class=\"token operator\">:</span> <span class=\"token string\">'Transaction exceeded compute budget'</span><span class=\"token punctuation\">,</span>\n            action<span class=\"token operator\">:</span> <span class=\"token string\">'Increase compute units or simplify the transaction'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> errorInfo<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>详细的兑换信息，我们可以使用 Swap API</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token doc-comment comment\">/**\n * Track transaction using SWAP API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">chainId</span> - Chain ID (e.g., 501 for Solana)\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">txHash</span> - Transaction hash\n * <span class=\"token keyword\">@returns</span> Transaction details\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">trackTransactionWithSwapAPI</span><span class=\"token punctuation\">(</span>\n    txHash<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/aggregator/history'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            chainId<span class=\"token operator\">:</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span><span class=\"token punctuation\">,</span>\n            txHash<span class=\"token operator\">:</span> txHash<span class=\"token punctuation\">,</span>\n            isFromMyProject<span class=\"token operator\">:</span> <span class=\"token string\">'true'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Prepare authentication</span>\n        <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> txData <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction is still pending: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txHash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">,</span> details<span class=\"token operator\">:</span> txData <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction successful!</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">From: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>fromTokenDetails<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> - Amount: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>fromTokenDetails<span class=\"token punctuation\">.</span>amount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">To: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>toTokenDetails<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> - Amount: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>toTokenDetails<span class=\"token punctuation\">.</span>amount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction Fee: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txFee<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Explorer URL: https://solscan.io/tx/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txHash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">'success'</span><span class=\"token punctuation\">,</span> details<span class=\"token operator\">:</span> txData <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'failure'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>errorMsg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">'failure'</span><span class=\"token punctuation\">,</span> details<span class=\"token operator\">:</span> txData <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            \n            <span class=\"token keyword\">return</span> txData<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to track transaction status:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">\"Unknown error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>交易上链 API 监控使用 /dex/post-transaction/orders 跟踪内部订单处理状态。它有助于监控交易在 OKX 系统中的移动情况，并提供订单 ID 和基本状态（1：待处理，2：成功，3：失败）。</p>\n<p>Swap API 交易跟踪使用 /dex/aggregator/history 提供全面的兑换执行详情。它提供特定于代币的信息（代码、金额）、已支付的费用以及详细的区块链数据。如果您需要完整的兑换验证并提供代币级详细信息，请使用此选项。</p>\n<p>选择前者用于基本交易状态更新，而选择后者用于获取兑换执行本身的详细信息。</p>\n<h2 data-content=\"6.完整实现\" id=\"6.完整实现\">6.完整实现<a class=\"index_header-anchor__Xqb+L\" href=\"#6.完整实现\" style=\"opacity:0\">#</a></h2>\n<p>这是一个完整的实现示例：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// solana-swap.ts</span>\n<span class=\"token keyword\">import</span> base58 <span class=\"token keyword\">from</span> <span class=\"token string\">\"bs58\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token constant\">BN</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"bn.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> solanaWeb3 <span class=\"token keyword\">from</span> <span class=\"token string\">\"@solana/web3.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Connection <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@solana/web3.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> cryptoJS <span class=\"token keyword\">from</span> <span class=\"token string\">\"crypto-js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">\"axios\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> dotenv <span class=\"token keyword\">from</span> <span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">;</span>\n\ndotenv<span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Environment variables</span>\n<span class=\"token keyword\">const</span> apiKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_KEY</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> secretKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_SECRET_KEY</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> apiPassphrase <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_PASSPHRASE</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> projectId <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_PROJECT_ID</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> userAddress <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> userPrivateKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PRIVATE_KEY</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> solanaRpcUrl <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_RPC_URL</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Constants</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"501\"</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Solana Mainnet</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">COMPUTE_UNITS</span> <span class=\"token operator\">=</span> <span class=\"token number\">300000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_RETRIES</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">CONFIRMATION_TIMEOUT</span> <span class=\"token operator\">=</span> <span class=\"token number\">60000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">POLLING_INTERVAL</span> <span class=\"token operator\">=</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">BASE_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://web3.okx.com\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">DEX_PATH</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"api/v5/dex\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Initialize Solana connection</span>\n<span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>solanaRpcUrl <span class=\"token operator\">||</span> <span class=\"token string\">\"https://api.mainnet-beta.solana.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    confirmTransactionInitialTimeout<span class=\"token operator\">:</span> <span class=\"token number\">30000</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ======== Utility Functions ========</span>\n\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Generate API authentication headers</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> method<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> body <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>apiKey <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>secretKey <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>apiPassphrase <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>projectId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Missing required environment variables for API authentication\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">const</span> stringToSign <span class=\"token operator\">=</span> timestamp <span class=\"token operator\">+</span> method <span class=\"token operator\">+</span> requestPath <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>queryString <span class=\"token operator\">||</span> body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string-property property\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-KEY\"</span><span class=\"token operator\">:</span> apiKey<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-SIGN\"</span><span class=\"token operator\">:</span> cryptoJS<span class=\"token punctuation\">.</span>enc<span class=\"token punctuation\">.</span>Base64<span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>\n            cryptoJS<span class=\"token punctuation\">.</span><span class=\"token function\">HmacSHA256</span><span class=\"token punctuation\">(</span>stringToSign<span class=\"token punctuation\">,</span> secretKey<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-TIMESTAMP\"</span><span class=\"token operator\">:</span> timestamp<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-PASSPHRASE\"</span><span class=\"token operator\">:</span> apiPassphrase<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-PROJECT\"</span><span class=\"token operator\">:</span> projectId<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Convert human-readable amount to the smallest token units</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">convertAmount</span><span class=\"token punctuation\">(</span>amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> decimals<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>amount <span class=\"token operator\">||</span> <span class=\"token function\">isNaN</span><span class=\"token punctuation\">(</span><span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid amount\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Amount must be greater than 0\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token constant\">BN</span></span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">*</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> decimals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Amount conversion error:\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid amount format\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Get token information from the API</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getTokenInfo</span><span class=\"token punctuation\">(</span>fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">DEX_PATH</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/aggregator/quote</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">const</span> params<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">string</span><span class=\"token operator\">&gt;</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        chainId<span class=\"token operator\">:</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span><span class=\"token punctuation\">,</span>\n        fromTokenAddress<span class=\"token punctuation\">,</span>\n        toTokenAddress<span class=\"token punctuation\">,</span>\n        amount<span class=\"token operator\">:</span> <span class=\"token string\">\"1000000\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Small amount just to get token info</span>\n        slippage<span class=\"token operator\">:</span> <span class=\"token string\">\"0.5\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\n            <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">BASE_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>requestPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>queryString<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">!==</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token operator\">?.</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to get token information\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">const</span> quoteData <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            fromToken<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin\">symbol</span><span class=\"token operator\">:</span> quoteData<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>tokenSymbol<span class=\"token punctuation\">,</span>\n                decimals<span class=\"token operator\">:</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>quoteData<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>decimal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                price<span class=\"token operator\">:</span> quoteData<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>tokenUnitPrice\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            toToken<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin\">symbol</span><span class=\"token operator\">:</span> quoteData<span class=\"token punctuation\">.</span>toToken<span class=\"token punctuation\">.</span>tokenSymbol<span class=\"token punctuation\">,</span>\n                decimals<span class=\"token operator\">:</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>quoteData<span class=\"token punctuation\">.</span>toToken<span class=\"token punctuation\">.</span>decimal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                price<span class=\"token operator\">:</span> quoteData<span class=\"token punctuation\">.</span>toToken<span class=\"token punctuation\">.</span>tokenUnitPrice\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error fetching token information:\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ======== Pre-Transaction Functionality ========</span>\n\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Get swap data from the API</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSwapData</span><span class=\"token punctuation\">(</span>\n    fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    slippage <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">DEX_PATH</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/aggregator/swap</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// Ensure all parameters are defined before creating URLSearchParams</span>\n    <span class=\"token keyword\">const</span> params<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">string</span><span class=\"token operator\">&gt;</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        amount<span class=\"token punctuation\">,</span>\n        chainId<span class=\"token operator\">:</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span><span class=\"token punctuation\">,</span>\n        fromTokenAddress<span class=\"token punctuation\">,</span>\n        toTokenAddress<span class=\"token punctuation\">,</span>\n        slippage\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token comment\">// Only add userWalletAddress if it's defined</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userAddress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        params<span class=\"token punctuation\">.</span>userWalletAddress <span class=\"token operator\">=</span> userAddress<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\n            <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">BASE_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>requestPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>queryString<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">!==</span> <span class=\"token string\">\"0\"</span> <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token operator\">?.</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">\"Failed to get swap data\"</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error fetching swap data:\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Prepare the transaction with the latest blockhash and compute units</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">prepareTransaction</span><span class=\"token punctuation\">(</span>callData<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Decode the base58 encoded transaction data</span>\n        <span class=\"token keyword\">const</span> decodedTransaction <span class=\"token operator\">=</span> base58<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>callData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Get the latest blockhash for transaction freshness</span>\n        <span class=\"token keyword\">const</span> recentBlockHash <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">getLatestBlockhash</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Got blockhash:\"</span><span class=\"token punctuation\">,</span> recentBlockHash<span class=\"token punctuation\">.</span>blockhash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">let</span> tx<span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Try to deserialize as a versioned transaction first (Solana v0 transaction format)</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            tx <span class=\"token operator\">=</span> solanaWeb3<span class=\"token punctuation\">.</span>VersionedTransaction<span class=\"token punctuation\">.</span><span class=\"token function\">deserialize</span><span class=\"token punctuation\">(</span>decodedTransaction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Successfully created versioned transaction\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            tx<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>recentBlockhash <span class=\"token operator\">=</span> recentBlockHash<span class=\"token punctuation\">.</span>blockhash<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// Fall back to legacy transaction if versioned fails</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Versioned transaction failed, trying legacy format\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            tx <span class=\"token operator\">=</span> solanaWeb3<span class=\"token punctuation\">.</span>Transaction<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>decodedTransaction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Successfully created legacy transaction\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            tx<span class=\"token punctuation\">.</span>recentBlockhash <span class=\"token operator\">=</span> recentBlockHash<span class=\"token punctuation\">.</span>blockhash<span class=\"token punctuation\">;</span>\n            \n            <span class=\"token comment\">// Add compute budget instruction for complex swaps (only for legacy transactions)</span>\n            <span class=\"token comment\">// For versioned transactions, this would already be included in the message</span>\n            <span class=\"token keyword\">const</span> computeBudgetIx <span class=\"token operator\">=</span> solanaWeb3<span class=\"token punctuation\">.</span>ComputeBudgetProgram<span class=\"token punctuation\">.</span><span class=\"token function\">setComputeUnitLimit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                units<span class=\"token operator\">:</span> <span class=\"token constant\">COMPUTE_UNITS</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            \n            tx<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>computeBudgetIx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            transaction<span class=\"token operator\">:</span> tx<span class=\"token punctuation\">,</span>\n            recentBlockHash\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error preparing transaction:\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Sign the transaction with user's private key</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">signTransaction</span><span class=\"token punctuation\">(</span>tx<span class=\"token operator\">:</span> solanaWeb3<span class=\"token punctuation\">.</span>Transaction <span class=\"token operator\">|</span> solanaWeb3<span class=\"token punctuation\">.</span>VersionedTransaction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>userPrivateKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Private key not found\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">const</span> feePayer <span class=\"token operator\">=</span> solanaWeb3<span class=\"token punctuation\">.</span>Keypair<span class=\"token punctuation\">.</span><span class=\"token function\">fromSecretKey</span><span class=\"token punctuation\">(</span>\n        base58<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>userPrivateKey<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tx <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">solanaWeb3</span><span class=\"token punctuation\">.</span>VersionedTransaction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        tx<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>feePayer<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        tx<span class=\"token punctuation\">.</span><span class=\"token function\">partialSign</span><span class=\"token punctuation\">(</span>feePayer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">return</span> tx<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Broadcast transaction using Onchain gateway API</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">broadcastTransaction</span><span class=\"token punctuation\">(</span>\n    signedTx<span class=\"token operator\">:</span> solanaWeb3<span class=\"token punctuation\">.</span>Transaction <span class=\"token operator\">|</span> solanaWeb3<span class=\"token punctuation\">.</span>VersionedTransaction\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> serializedTx <span class=\"token operator\">=</span> signedTx<span class=\"token punctuation\">.</span><span class=\"token function\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> encodedTx <span class=\"token operator\">=</span> base58<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>serializedTx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">DEX_PATH</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/pre-transaction/broadcast-transaction</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Ensure all parameters are defined</span>\n        <span class=\"token keyword\">const</span> broadcastData<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">string</span><span class=\"token operator\">&gt;</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n            signedTx<span class=\"token operator\">:</span> encodedTx<span class=\"token punctuation\">,</span>\n            chainIndex<span class=\"token operator\">:</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Only add address if it's defined</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userAddress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            broadcastData<span class=\"token punctuation\">.</span>address <span class=\"token operator\">=</span> userAddress<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token comment\">// Prepare authentication with body included in signature</span>\n        <span class=\"token keyword\">const</span> bodyString <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>broadcastData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> bodyString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">BASE_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>requestPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> broadcastData<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> orderId <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orderId<span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction broadcast successfully, Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> orderId<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to broadcast transaction:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ======== Post-Transaction Monitoring ========</span>\n\n<span class=\"token comment\">// Define error info interface</span>\n<span class=\"token class-name\"><span class=\"token keyword\">interface</span></span> TxErrorInfo <span class=\"token punctuation\">{</span>\n    error<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n    message<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n    action<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Monitor transaction status using Onchain gateway API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">orderId</span> - Order ID from broadcast response\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">intervalMs</span> - Polling interval in milliseconds\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">timeoutMs</span> - Maximum time to wait\n * <span class=\"token keyword\">@returns</span> Final transaction status\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">trackTransaction</span><span class=\"token punctuation\">(</span>\n    orderId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    intervalMs<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token constant\">POLLING_INTERVAL</span><span class=\"token punctuation\">,</span>\n    timeoutMs<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token constant\">CONFIRMATION_TIMEOUT</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Monitoring transaction with Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> startTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> lastStatus <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime <span class=\"token operator\">&lt;</span> timeoutMs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Get transaction status</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">DEX_PATH</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/post-transaction/orders</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n            \n            <span class=\"token comment\">// Ensure all parameters are defined before creating URLSearchParams</span>\n            <span class=\"token keyword\">const</span> params<span class=\"token operator\">:</span> Record<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">string</span><span class=\"token operator\">&gt;</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n                orderId<span class=\"token operator\">:</span> orderId<span class=\"token punctuation\">,</span>\n                chainIndex<span class=\"token operator\">:</span> <span class=\"token constant\">SOLANA_CHAIN_ID</span><span class=\"token punctuation\">,</span>\n                limit<span class=\"token operator\">:</span> <span class=\"token string\">'1'</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            \n            <span class=\"token comment\">// Only add address if it's defined</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>userAddress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                params<span class=\"token punctuation\">.</span>address <span class=\"token operator\">=</span> userAddress<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\">// Prepare authentication</span>\n            <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">BASE_URL</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>requestPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>queryString<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            \n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span> <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">const</span> txData <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n                    \n                    <span class=\"token comment\">// Use txStatus to match the API response</span>\n                    <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>txStatus<span class=\"token punctuation\">;</span>\n\n                    <span class=\"token comment\">// Only log when status changes</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!==</span> lastStatus<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        lastStatus <span class=\"token operator\">=</span> status<span class=\"token punctuation\">;</span>\n\n                        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction pending: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txHash <span class=\"token operator\">||</span> <span class=\"token string\">'Hash not available yet'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'2'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction successful: https://solscan.io/tx/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txHash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">return</span> txData<span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'3'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token keyword\">const</span> failReason <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>failReason <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token keyword\">const</span> errorMessage <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>failReason<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                            <span class=\"token keyword\">const</span> errorInfo <span class=\"token operator\">=</span> <span class=\"token function\">handleTransactionError</span><span class=\"token punctuation\">(</span>txData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Error type: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>errorInfo<span class=\"token punctuation\">.</span>error<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Suggested action: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>errorInfo<span class=\"token punctuation\">.</span>action<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">No orders found for Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error checking transaction status:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">\"Unknown error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// Wait before next check</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span>resolve <span class=\"token operator\">=&gt;</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> intervalMs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Transaction monitoring timed out'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * error handling with failReason\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">txData</span> - Transaction data from post-transaction/orders\n * <span class=\"token keyword\">@returns</span> Structured error information\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleTransactionError</span><span class=\"token punctuation\">(</span>txData<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> TxErrorInfo <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">const</span> failReason <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>failReason <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Log the detailed error</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed with reason: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>failReason<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Default error handling</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    error<span class=\"token operator\">:</span> <span class=\"token string\">'TRANSACTION_FAILED'</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> failReason<span class=\"token punctuation\">,</span>\n    action<span class=\"token operator\">:</span> <span class=\"token string\">'Try again or contact support'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ======== Main Swap Execution Function ========</span>\n\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Execute a token swap on Solana</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span>\n    fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    slippage<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Validate inputs</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>userPrivateKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Missing private key\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>userAddress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Missing wallet address\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token comment\">// Step 1: Get swap data from OKX DEX API</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Getting swap data...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> swapData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getSwapData</span><span class=\"token punctuation\">(</span>fromTokenAddress<span class=\"token punctuation\">,</span> toTokenAddress<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> slippage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Swap route obtained\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Step 2: Get the transaction data</span>\n        <span class=\"token keyword\">const</span> callData <span class=\"token operator\">=</span> swapData<span class=\"token punctuation\">.</span>tx<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>callData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Invalid transaction data received from API\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// Step 3: Prepare the transaction with compute units</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> transaction<span class=\"token punctuation\">,</span> recentBlockHash <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">prepareTransaction</span><span class=\"token punctuation\">(</span>callData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Transaction prepared with compute unit limit:\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">COMPUTE_UNITS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Step 4: Sign the transaction</span>\n        <span class=\"token keyword\">const</span> signedTx <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">signTransaction</span><span class=\"token punctuation\">(</span>transaction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Transaction signed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Step 5: Broadcast the transaction using Onchain gateway API</span>\n        <span class=\"token keyword\">const</span> orderId <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">broadcastTransaction</span><span class=\"token punctuation\">(</span>signedTx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction broadcast successful with order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Step 6: Monitor the transaction status</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Monitoring transaction status...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> txStatus <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">trackTransaction</span><span class=\"token punctuation\">(</span>orderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            success<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            orderId<span class=\"token punctuation\">,</span>\n            txHash<span class=\"token operator\">:</span> txStatus<span class=\"token punctuation\">.</span>txHash<span class=\"token punctuation\">,</span>\n            status<span class=\"token operator\">:</span> txStatus<span class=\"token punctuation\">.</span>txStatus <span class=\"token operator\">===</span> <span class=\"token string\">'2'</span> <span class=\"token operator\">?</span> <span class=\"token string\">'SUCCESS'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'PENDING'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error during swap:\"</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            success<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n            error<span class=\"token operator\">:</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">\"Unknown error\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ======== Command Line Interface ========</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> args <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Usage: ts-node solana-swap.ts &lt;amount&gt; &lt;fromTokenAddress&gt; &lt;toTokenAddress&gt; [&lt;slippage&gt;]\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Example: ts-node solana-swap.ts 0.1 11111111111111111111111111111111 EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v 0.5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>amountStr<span class=\"token punctuation\">,</span> fromTokenAddress<span class=\"token punctuation\">,</span> toTokenAddress<span class=\"token punctuation\">,</span> slippage <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args<span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Get token information</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Getting token information...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> tokenInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getTokenInfo</span><span class=\"token punctuation\">(</span>fromTokenAddress<span class=\"token punctuation\">,</span> toTokenAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">From: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>decimals<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> decimals)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">To: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>toToken<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>toToken<span class=\"token punctuation\">.</span>decimals<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> decimals)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Convert amount using fetched decimals</span>\n        <span class=\"token keyword\">const</span> rawAmount <span class=\"token operator\">=</span> <span class=\"token function\">convertAmount</span><span class=\"token punctuation\">(</span>amountStr<span class=\"token punctuation\">,</span> tokenInfo<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>decimals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Amount in </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> base units:</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> rawAmount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token comment\">// Execute swap</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nExecuting swap...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span>fromTokenAddress<span class=\"token punctuation\">,</span> toTokenAddress<span class=\"token punctuation\">,</span> rawAmount<span class=\"token punctuation\">,</span> slippage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>success<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nSwap completed successfully!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Order ID:\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>orderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>txHash<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Transaction ID:\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>txHash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Explorer URL:\"</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://solscan.io/tx/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>result<span class=\"token punctuation\">.</span>txHash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nSwap failed:\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        \n        process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>success <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error:\"</span><span class=\"token punctuation\">,</span> error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span> <span class=\"token operator\">?</span> error<span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">\"Unknown error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Execute main function if run directly</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">require</span><span class=\"token punctuation\">.</span>main <span class=\"token operator\">===</span> module<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Export functions for modular usage</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span>\n    executeSwap<span class=\"token punctuation\">,</span>\n    broadcastTransaction<span class=\"token punctuation\">,</span>\n    trackTransaction<span class=\"token punctuation\">,</span>\n    prepareTransaction\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"7. MEV保护\" id=\"7.-mev保护\">7. MEV保护<a class=\"index_header-anchor__Xqb+L\" href=\"#7.-mev保护\" style=\"opacity:0\">#</a></h2>\n<p>Solana交易存在MEV（最大可提取价值）风险。虽然MEV保护不直接包含在SDK中，但您可以使用API优先的方法自行实施。</p>\n<p>第一道防线使用动态优先级费用-将其视为您在拍卖中对抗MEV机器人的出价。</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">MEV_PROTECTION</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Trade Protection</span>\n    <span class=\"token constant\">MAX_PRICE_IMPACT</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.05\"</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// 5% max price impact</span>\n    <span class=\"token constant\">SLIPPAGE</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.05\"</span><span class=\"token punctuation\">,</span>                <span class=\"token comment\">// 5% slippage tolerance</span>\n    <span class=\"token constant\">MIN_ROUTES</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>                   <span class=\"token comment\">// Minimum DEX routes</span>\n\n    <span class=\"token comment\">// Priority Fees</span>\n    <span class=\"token constant\">MIN_PRIORITY_FEE</span><span class=\"token operator\">:</span> <span class=\"token number\">10_000</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">MAX_PRIORITY_FEE</span><span class=\"token operator\">:</span> <span class=\"token number\">1_000_000</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">PRIORITY_MULTIPLIER</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// TWAP Settings</span>\n    <span class=\"token constant\">TWAP_ENABLED</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">TWAP_INTERVALS</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>               <span class=\"token comment\">// Split into 4 parts</span>\n    <span class=\"token constant\">TWAP_DELAY_MS</span><span class=\"token operator\">:</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">,</span>            <span class=\"token comment\">// 2s between trades</span>\n\n    <span class=\"token comment\">// Transaction Settings</span>\n    <span class=\"token constant\">COMPUTE_UNITS</span><span class=\"token operator\">:</span> <span class=\"token number\">300_000</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">MAX_RETRIES</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">CONFIRMATION_TIMEOUT</span><span class=\"token operator\">:</span> <span class=\"token number\">60_000</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token comment\">// Block Targeting</span>\n    <span class=\"token constant\">TARGET_SPECIFIC_BLOCKS</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">PREFERRED_SLOT_OFFSET</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// Target blocks with slot % 4 == 2</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">async</span> <span class=\"token function\">getPriorityFee</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> recentFees <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token function\">getRecentPrioritizationFees</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> maxFee <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>recentFees<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>fee <span class=\"token operator\">=&gt;</span> fee<span class=\"token punctuation\">.</span>prioritizationFee<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>maxFee <span class=\"token operator\">*</span> <span class=\"token number\">1.5</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">MEV_PROTECTION</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MAX_PRIORITY_FEE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>对于较大的交易，您可以启用TWAP（时间加权平均价格）。您的交易将被分成更小的部分，而不是MEV机器人喜欢瞄准的一个大的飞溅。</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// Define the TWAPExecution class outside of the if block</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TWAPExecution</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">async</span> <span class=\"token function\">splitTrade</span><span class=\"token punctuation\">(</span>\n        totalAmount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n        fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n        toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n    <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>TradeChunk<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> amount <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token constant\">BN</span></span><span class=\"token punctuation\">(</span>totalAmount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> chunkSize <span class=\"token operator\">=</span> amount<span class=\"token punctuation\">.</span><span class=\"token function\">divn</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEV_PROTECTION</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TWAP_INTERVALS</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token function\">Array</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEV_PROTECTION</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TWAP_INTERVALS</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                amount<span class=\"token operator\">:</span> chunkSize<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                fromTokenAddress<span class=\"token punctuation\">,</span>\n                toTokenAddress<span class=\"token punctuation\">,</span>\n                minAmountOut<span class=\"token operator\">:</span> <span class=\"token string\">\"0\"</span> <span class=\"token comment\">// Will be calculated per chunk</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Then use it in the if block</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token constant\">MEV_PROTECTION</span><span class=\"token punctuation\">.</span><span class=\"token constant\">TWAP_ENABLED</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> chunks <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> TWAPExecution<span class=\"token punctuation\">.</span><span class=\"token function\">splitTrade</span><span class=\"token punctuation\">(</span>\n        rawAmount<span class=\"token punctuation\">,</span>\n        fromTokenAddress<span class=\"token punctuation\">,</span>\n        toTokenAddress\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h3 id=\"运行中防护\">运行中防护<a class=\"index_header-anchor__Xqb+L\" href=\"#运行中防护\" style=\"opacity:0\">#</a></h3>\n<p>当您使用<a class=\"items-center\" href=\"https://github.com/okx/dex-api-library/blob/main/lib/solana/swap/solana-swap-mev.ts\" rel=\"nofollow noreferrer\" style=\"display:inline-flex;line-height:16px\" target=\"_blank\">此实现<i aria-hidden=\"true\" class=\"icon iconfont doc-ssr-okds-open-link\" role=\"img\" style=\"font-size:24px;color:#0569FF;margin-left:2px\"></i></a>执行交易时，会发生几件事情：</p>\n<ol>\n<li>交易前检查：</li>\n</ol>\n<ul>\n<li>购买的代币会被检查是否存在貔貅盘特征</li>\n<li>检查你的网络费用来设置有竞争力的优先费用</li>\n<li>查看你的交易额度来确认是否要拆单</li>\n</ul>\n<ol start=\"2\">\n<li>在交易期间：</li>\n</ol>\n<ul>\n<li>大额交易将拆分成不同金额的单子，并在随机时间发出</li>\n<li>每单将根据市场条件设置优先费用</li>\n<li>特定的区块来减少暴露风险</li>\n</ul>\n<ol start=\"3\">\n<li>交易的安全性保障：</li>\n</ol>\n<ul>\n<li>每笔交易都将进行预执行模拟</li>\n<li>对区块确认状态进行内置的追踪</li>\n<li>出现问题自动重试逻辑</li>\n</ul>\n<p>虽然Solana上的MEV不能完全消除，但这些保护措施使MEV机器人的生活更加困难。</p>\n<h2 data-content=\"方法2：SDK方法\" id=\"方法2：sdk方法\">方法2：SDK方法<a class=\"index_header-anchor__Xqb+L\" href=\"#方法2：sdk方法\" style=\"opacity:0\">#</a></h2>\n<p>使用OKX DEXSDK提供了更简单的开发人员体验，同时保留了API方法的所有功能。SDK为您处理许多实现细节，包括重试逻辑、错误处理和事务管理。</p>\n<h2 data-content=\"1.安装SDK\" id=\"1.安装sdk\">1.安装SDK<a class=\"index_header-anchor__Xqb+L\" href=\"#1.安装sdk\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> @okx-dex/okx-dex-sdk\n<span class=\"token comment\"># or</span>\n<span class=\"token function\">yarn</span> <span class=\"token function\">add</span> @okx-dex/okx-dex-sdk\n<span class=\"token comment\"># or</span>\n<span class=\"token function\">pnpm</span> <span class=\"token function\">add</span> @okx-dex/okx-dex-sdk\n</code></pre></div>\n<h2 data-content=\"2.设置环境\" id=\"2.设置环境\">2.设置环境<a class=\"index_header-anchor__Xqb+L\" href=\"#2.设置环境\" style=\"opacity:0\">#</a></h2>\n<p>使用您的API凭据和钱包信息创建一个. env文件：</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># OKX API Credentials</span>\n<span class=\"token assign-left variable\">OKX_API_KEY</span><span class=\"token operator\">=</span>your_api_key\n<span class=\"token assign-left variable\">OKX_SECRET_KEY</span><span class=\"token operator\">=</span>your_secret_key\n<span class=\"token assign-left variable\">OKX_API_PASSPHRASE</span><span class=\"token operator\">=</span>your_passphrase\n<span class=\"token assign-left variable\">OKX_PROJECT_ID</span><span class=\"token operator\">=</span>your_project_id\n<span class=\"token comment\"># Solana Configuration</span>\n<span class=\"token assign-left variable\">SOLANA_RPC_URL</span><span class=\"token operator\">=</span>your_solana_rpc_url\n<span class=\"token assign-left variable\">SOLANA_WALLET_ADDRESS</span><span class=\"token operator\">=</span>your_solana_wallet_address\n<span class=\"token assign-left variable\">SOLANA_PRIVATE_KEY</span><span class=\"token operator\">=</span>your_solana_private_key\n</code></pre></div>\n<h2 data-content=\"3.初始化客户端\" id=\"3.初始化客户端\">3.初始化客户端<a class=\"index_header-anchor__Xqb+L\" href=\"#3.初始化客户端\" style=\"opacity:0\">#</a></h2>\n<p>为您的DEX客户端创建一个文件（例如，DexClient. ts）：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// DexClient.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> OKXDexClient <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@okx-dex/okx-dex-sdk'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">'dotenv/config'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Validate environment variables</span>\n<span class=\"token keyword\">const</span> requiredEnvVars <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'OKX_API_KEY'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'OKX_SECRET_KEY'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'OKX_API_PASSPHRASE'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'OKX_PROJECT_ID'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'SOLANA_WALLET_ADDRESS'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'SOLANA_PRIVATE_KEY'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'SOLANA_RPC_URL'</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> envVar <span class=\"token keyword\">of</span> requiredEnvVars<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">[</span>envVar<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Missing required environment variable: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>envVar<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Initialize the client</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OKXDexClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    apiKey<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_KEY</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    secretKey<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_SECRET_KEY</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    apiPassphrase<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_PASSPHRASE</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    projectId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_PROJECT_ID</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    solana<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        connection<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            rpcUrl<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_RPC_URL</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n            wsEndpoint<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_WS_URL</span><span class=\"token punctuation\">,</span>\n            confirmTransactionInitialTimeout<span class=\"token operator\">:</span> <span class=\"token number\">5000</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        walletAddress<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_WALLET_ADDRESS</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n        privateKey<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_PRIVATE_KEY</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n        computeUnits<span class=\"token operator\">:</span> <span class=\"token number\">300000</span><span class=\"token punctuation\">,</span>\n        maxRetries<span class=\"token operator\">:</span> <span class=\"token number\">3</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"4.调用SDK执行兑换\" id=\"4.调用sdk执行兑换\">4.调用SDK执行兑换<a class=\"index_header-anchor__Xqb+L\" href=\"#4.调用sdk执行兑换\" style=\"opacity:0\">#</a></h2>\n<p>创建兑换执行的文件：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// swap.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> client <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./DexClient'</span><span class=\"token punctuation\">;</span>\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Example: Execute a swap from SOL to USDC</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_PRIVATE_KEY</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Missing SOLANA_PRIVATE_KEY in .env file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// Get quote to fetch token information</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Getting token information...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> quote <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>dex<span class=\"token punctuation\">.</span><span class=\"token function\">getQuote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        chainId<span class=\"token operator\">:</span> <span class=\"token string\">'501'</span><span class=\"token punctuation\">,</span>\n        fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'11111111111111111111111111111111'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// SOL</span>\n        toTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// USDC</span>\n        amount<span class=\"token operator\">:</span> <span class=\"token string\">'1000000'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Small amount for quote</span>\n        slippage<span class=\"token operator\">:</span> <span class=\"token string\">'0.5'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> tokenInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        fromToken<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">symbol</span><span class=\"token operator\">:</span> quote<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>tokenSymbol<span class=\"token punctuation\">,</span>\n            decimals<span class=\"token operator\">:</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>quote<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>decimal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            price<span class=\"token operator\">:</span> quote<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>tokenUnitPrice\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        toToken<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">symbol</span><span class=\"token operator\">:</span> quote<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>toToken<span class=\"token punctuation\">.</span>tokenSymbol<span class=\"token punctuation\">,</span>\n            decimals<span class=\"token operator\">:</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>quote<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>toToken<span class=\"token punctuation\">.</span>decimal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            price<span class=\"token operator\">:</span> quote<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>toToken<span class=\"token punctuation\">.</span>tokenUnitPrice\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Convert amount to base units (for display purposes)</span>\n    <span class=\"token keyword\">const</span> humanReadableAmount <span class=\"token operator\">=</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 0.1 SOL</span>\n    <span class=\"token keyword\">const</span> rawAmount <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>humanReadableAmount <span class=\"token operator\">*</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">pow</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> tokenInfo<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>decimals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nSwap Details:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"--------------------\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">From: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">To: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>toToken<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Amount: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>humanReadableAmount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Amount in base units: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rawAmount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Approximate USD value: $</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span>humanReadableAmount <span class=\"token operator\">*</span> <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span>tokenInfo<span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>price<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Execute the swap</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nExecuting swap...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> swapResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>dex<span class=\"token punctuation\">.</span><span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> <span class=\"token string\">'501'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Solana chain ID</span>\n      fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'11111111111111111111111111111111'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// SOL</span>\n      toTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// USDC</span>\n      amount<span class=\"token operator\">:</span> rawAmount<span class=\"token punctuation\">,</span>\n      slippage<span class=\"token operator\">:</span> <span class=\"token string\">'0.5'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 0.5% slippage</span>\n      userWalletAddress<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_WALLET_ADDRESS</span><span class=\"token operator\">!</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Swap executed successfully:'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>swapResult<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> swapResult<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error executing swap:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// API errors include details in the message</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'API Error:'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> match <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">API Error: <span class=\"token group punctuation\">(</span><span class=\"token char-set class-name\">.</span><span class=\"token quantifier number\">*</span><span class=\"token group punctuation\">)</span></span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>match<span class=\"token punctuation\">)</span> <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'API Error Details:'</span><span class=\"token punctuation\">,</span> match<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Run if this file is executed directly</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">require</span><span class=\"token punctuation\">.</span>main <span class=\"token operator\">===</span> module<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> executeSwap <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"5.附加SDK功能\" id=\"5.附加sdk功能\">5.附加SDK功能<a class=\"index_header-anchor__Xqb+L\" href=\"#5.附加sdk功能\" style=\"opacity:0\">#</a></h2>\n<p>SDK提供了简化开发的附加方法：\n获取代币对的报价</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> quote <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>dex<span class=\"token punctuation\">.</span><span class=\"token function\">getQuote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    chainId<span class=\"token operator\">:</span> <span class=\"token string\">'501'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Solana</span>\n    fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'11111111111111111111111111111111'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// SOL</span>\n    toTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// USDC</span>\n    amount<span class=\"token operator\">:</span> <span class=\"token string\">'100000000'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 0.1 SOL (in lamports)</span>\n    slippage<span class=\"token operator\">:</span> <span class=\"token string\">'0.5'</span>     <span class=\"token comment\">// 0.5%</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div><!--/$--></div>",
  "url": "https://web3.okx.com/zh-hans/build/dev-docs/dex-api/dex-use-swap-solana-quick-start#2.设置环境",
  "navigation": {
    "breadcrumbs": [
      "DEX API",
      "交易 API",
      "搭建兑换应用",
      "在 Solana 链上搭建兑换应用"
    ],
    "sidebar_links": [
      "搭建兑换应用",
      "在 Solana 链上搭建兑换应用",
      "在 Solana 链上兑换的高级用法",
      "在 EVM 链上搭建兑换应用",
      "在 Sui 链上搭建兑换应用",
      "在 Ton 链上搭建兑换应用",
      "搭建跨链应用",
      "介绍",
      "API 参考",
      "设置分佣",
      "DEX 集成",
      "智能合约",
      "错误码",
      "FAQ",
      "介绍",
      "API 参考",
      "支持的跨链桥",
      "智能合约",
      "错误码",
      "FAQ"
    ],
    "toc": [
      "方法1：API方法",
      "1.设置环境",
      "2.获取兑换数据",
      "3.准备交易",
      "4. 广播交易",
      "5.追踪交易",
      "6.完整实现",
      "7. MEV保护",
      "方法2：SDK方法",
      "1.安装SDK",
      "2.设置环境",
      "3.初始化客户端",
      "4.调用SDK执行兑换",
      "5.附加SDK功能"
    ]
  },
  "word_count": 6501,
  "extract_time": "2025-05-27 05:13:23"
}