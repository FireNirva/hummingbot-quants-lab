{
  "title": "在 EVM 链上搭建兑换应用 | 搭建兑换应用 | 指南 | 交易 API | DEX API | DEX API 文档 | 欧易",
  "text": "在 EVM 链上搭建兑换应用\n#\n在EVM网络上使用OKX DEX构建兑换应用程序有两种方法：\nAPI 方法-直接调用 OKX DEX API\nSDK 方法-使用\n@okx-dex/okx-dex-sdk\n简化开发人员体验\n本指南涵盖了这两种方法，以帮助您选择最适合您需求的方法。\n方法1：API方法\n#\n在这种方法中，我们将直接使用OKX DEX API演示代币兑换。我们将在以太坊网络上将USDC兑换为ETH。\n1.设置环境\n#\n// --------------------- npm package ---------------------\nimport\n{\nWeb3\n}\nfrom\n'web3'\n;\nimport\naxios\nfrom\n'axios'\n;\nimport\n*\nas\ndotenv\nfrom\n'dotenv'\n;\nimport\nCryptoJS\nfrom\n'crypto-js'\n;\n// The URL for the Ethereum node you want to connect to\nconst\nweb3\n=\nnew\nWeb3\n(\n'https://......com'\n)\n;\n// --------------------- environment variable ---------------------\n// Load hidden environment variables\ndotenv\n.\nconfig\n(\n)\n;\n// Your wallet information - REPLACE WITH YOUR OWN VALUES\nconst\nWALLET_ADDRESS\n:\nstring\n=\nprocess\n.\nenv\n.\nEVM_WALLET_ADDRESS\n||\n'0xYourWalletAddress'\n;\nconst\nPRIVATE_KEY\n:\nstring\n=\nprocess\n.\nenv\n.\nEVM_PRIVATE_KEY\n||\n'YourPrivateKey'\n;\n// Token addresses for swap on Ethereum Mainnet\nconst\nETH_ADDRESS\n:\nstring\n=\n'0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'\n;\n// Native ETH\nconst\nUSDC_ADDRESS\n:\nstring\n=\n'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'\n;\n// USDC\n// Chain ID for Ethereum Mainnet\nconst\nchainId\n:\nstring\n=\n'1'\n;\n// API URL\nconst\nbaseUrl\n:\nstring\n=\n'https://web3.okx.com/api/v5/'\n;\n// Amount to swap in smallest unit (approx $1 of ETH)\n// 1 ETH = 10^18 wei, so 0.0005 ETH\nconst\nSWAP_AMOUNT\n:\nstring\n=\n'500000000000000'\n;\n// 0.0005 ETH (approx $1)\nconst\nSLIPPAGE\n:\nstring\n=\n'0.5'\n;\n// 0.5% slippage tolerance\n// --------------------- util function ---------------------\nexport\nfunction\ngetHeaders\n(\ntimestamp\n:\nstring\n,\nmethod\n:\nstring\n,\nrequestPath\n:\nstring\n,\nqueryString\n=\n\"\"\n)\n{\n// Check https://web3.okx.com/zh-hans/web3/build/docs/waas/rest-authentication for api-key\nconst\napiKey\n=\nprocess\n.\nenv\n.\nOKX_API_KEY\n;\nconst\nsecretKey\n=\nprocess\n.\nenv\n.\nOKX_SECRET_KEY\n;\nconst\napiPassphrase\n=\nprocess\n.\nenv\n.\nOKX_API_PASSPHRASE\n;\nconst\nprojectId\n=\nprocess\n.\nenv\n.\nOKX_PROJECT_ID\n;\nif\n(\n!\napiKey\n||\n!\nsecretKey\n||\n!\napiPassphrase\n||\n!\nprojectId\n)\n{\nthrow\nnew\nError\n(\n\"Missing required environment variables\"\n)\n;\n}\nconst\nstringToSign\n=\ntimestamp\n+\nmethod\n+\nrequestPath\n+\nqueryString\n;\nreturn\n{\n\"Content-Type\"\n:\n\"application/json\"\n,\n\"OK-ACCESS-KEY\"\n:\napiKey\n,\n\"OK-ACCESS-SIGN\"\n:\nCryptoJS\n.\nenc\n.\nBase64\n.\nstringify\n(\nCryptoJS\n.\nHmacSHA256\n(\nstringToSign\n,\nsecretKey\n)\n)\n,\n\"OK-ACCESS-TIMESTAMP\"\n:\ntimestamp\n,\n\"OK-ACCESS-PASSPHRASE\"\n:\napiPassphrase\n,\n\"OK-ACCESS-PROJECT\"\n:\nprojectId\n,\n}\n;\n}\n;\n2.检查授权额度\n#\n您需要检查代币是否已批准DEX进行支出。此步骤仅适用于ERC20代币，而不是像ETH这样的本地代币。\n/**\n * Check token allowance for DEX\n *\n@param\ntokenAddress\n- Token contract address\n *\n@param\nownerAddress\n- Your wallet address\n *\n@param\nspenderAddress\n- DEX spender address\n *\n@returns\nAllowance amount\n */\nasync\nfunction\ncheckAllowance\n(\ntokenAddress\n:\nstring\n,\nownerAddress\n:\nstring\n,\nspenderAddress\n:\nstring\n)\n:\nPromise\n<\nbigint\n>\n{\nconst\ntokenABI\n=\n[\n{\n\"constant\"\n:\ntrue\n,\n\"inputs\"\n:\n[\n{\n\"name\"\n:\n\"_owner\"\n,\n\"type\"\n:\n\"address\"\n}\n,\n{\n\"name\"\n:\n\"_spender\"\n,\n\"type\"\n:\n\"address\"\n}\n]\n,\n\"name\"\n:\n\"allowance\"\n,\n\"outputs\"\n:\n[\n{\n\"name\"\n:\n\"\"\n,\n\"type\"\n:\n\"uint256\"\n}\n]\n,\n\"payable\"\n:\nfalse\n,\n\"stateMutability\"\n:\n\"view\"\n,\n\"type\"\n:\n\"function\"\n}\n]\n;\nconst\ntokenContract\n=\nnew\nweb3\n.\neth\n.\nContract\n(\ntokenABI\n,\ntokenAddress\n)\n;\ntry\n{\nconst\nallowance\n=\nawait\ntokenContract\n.\nmethods\n.\nallowance\n(\nownerAddress\n,\nspenderAddress\n)\n.\ncall\n(\n)\n;\nreturn\nBigInt\n(\nString\n(\nallowance\n)\n)\n;\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to query allowance:'\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n3.检查授权交易参数并发起授权\n#\n由于 allowanceAmount 小于 fromTokenAmount，你需要对该币种进行授权。\n3.1 定义授权交易参数\nconst\ngetApproveTransactionParams\n=\n{\nchainId\n:\nchainId\n,\ntokenContractAddress\n:\ntokenAddress\n,\napproveAmount\n:\namount\n}\n;\n3.2 定义辅助函数\nasync\nfunction\ngetApproveTransaction\n(\ntokenAddress\n:\nstring\n,\namount\n:\nstring\n)\n:\nPromise\n<\nany\n>\n{\ntry\n{\nconst\npath\n=\n'dex/aggregator/approve-transaction'\n;\nconst\nurl\n=\n`\n${\nbaseUrl\n}\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\nchainId\n:\nchainId\n,\ntokenContractAddress\n:\ntokenAddress\n,\napproveAmount\n:\namount\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to get approval transaction data:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\nthrow\nerror\n;\n}\n}\n3.3 计算 gasLimit\n/**\n * Get transaction gas limit from Onchain gateway API\n *\n@param\nfromAddress\n- Sender address\n *\n@param\ntoAddress\n- Target contract address\n *\n@param\ntxAmount\n- Transaction amount (0 for approvals)\n *\n@param\ninputData\n- Transaction calldata\n *\n@returns\nEstimated gas limit\n */\nasync\nfunction\ngetGasLimit\n(\nfromAddress\n:\nstring\n,\ntoAddress\n:\nstring\n,\ntxAmount\n:\nstring\n=\n'0'\n,\ninputData\n:\nstring\n=\n''\n)\n:\nPromise\n<\nstring\n>\n{\ntry\n{\nconst\npath\n=\n'dex/pre-transaction/gas-limit'\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconst\nbody\n=\n{\nchainIndex\n:\nchainId\n,\nfromAddress\n:\nfromAddress\n,\ntoAddress\n:\ntoAddress\n,\ntxAmount\n:\ntxAmount\n,\nextJson\n:\n{\ninputData\n:\ninputData\n}\n}\n;\n// Prepare authentication with body included in signature\nconst\nbodyString\n=\nJSON\n.\nstringify\n(\nbody\n)\n;\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'POST'\n,\nrequestPath\n,\nbodyString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\npost\n(\nurl\n,\nbody\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\ngasLimit\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to get gas limit:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\nthrow\nerror\n;\n}\n}\n3.4 获取授权交易 tx 并且发送授权请求\n/**\n * Sign and send approve transaction\n *\n@param\ntokenAddress\n- Token to approve\n *\n@param\namount\n- Amount to approve\n *\n@returns\nOrder ID of the approval transaction\n */\nasync\nfunction\napproveToken\n(\ntokenAddress\n:\nstring\n,\namount\n:\nstring\n)\n:\nPromise\n<\nstring\n|\nnull\n>\n{\nconst\nspenderAddress\n=\n'0x3b3ae790Df4F312e745D270119c6052904FB6790'\n;\n// Ethereum Mainnet DEX spender\n// See Router addresses at: https://web3.okx.com/build/docs/waas/dex-smart-contract\nconst\ncurrentAllowance\n=\nawait\ncheckAllowance\n(\ntokenAddress\n,\nWALLET_ADDRESS\n,\nspenderAddress\n)\n;\nif\n(\ncurrentAllowance\n>=\nBigInt\n(\namount\n)\n)\n{\nconsole\n.\nlog\n(\n'Sufficient allowance already exists'\n)\n;\nreturn\nnull\n;\n}\nconsole\n.\nlog\n(\n'Insufficient allowance, approving tokens...'\n)\n;\n// Get approve transaction data from OKX DEX API\nconst\napproveData\n=\nawait\ngetApproveTransaction\n(\ntokenAddress\n,\namount\n)\n;\n// Get accurate gas limit using Onchain gateway API\nconst\ngasLimit\n=\nawait\ngetGasLimit\n(\nWALLET_ADDRESS\n,\ntokenAddress\n,\n'0'\n,\napproveData\n.\ndata\n)\n;\n// Get current gas price (can also use Onchain gateway API)\nconst\ngasPrice\n=\nawait\nweb3\n.\neth\n.\ngetGasPrice\n(\n)\n;\nconst\nadjustedGasPrice\n=\nBigInt\n(\ngasPrice\n)\n*\nBigInt\n(\n15\n)\n/\nBigInt\n(\n10\n)\n;\n// 1.5x for faster confirmation\n// Get current nonce\nconst\nnonce\n=\nawait\nweb3\n.\neth\n.\ngetTransactionCount\n(\nWALLET_ADDRESS\n,\n'latest'\n)\n;\n// Create transaction object\nconst\ntxObject\n=\n{\nfrom\n:\nWALLET_ADDRESS\n,\nto\n:\ntokenAddress\n,\ndata\n:\napproveData\n.\ndata\n,\nvalue\n:\n'0'\n,\ngas\n:\ngasLimit\n,\ngasPrice\n:\nadjustedGasPrice\n.\ntoString\n(\n)\n,\nnonce\n:\nnonce\n}\n;\n// Sign transaction\nconst\n{\nsignedTx\n}\n=\nawait\nweb3\n.\neth\n.\naccounts\n.\nsignTransaction\n(\ntxObject\n,\nPRIVATE_KEY\n)\n;\nawait\nweb3\n.\neth\n.\nsendSignedTransaction\n(\nsignedTx\n)\n;\n}\n4.请求询价接口，拿到询价数据\n#\n4.1定义报价参数\nconst\nquoteParams\n=\n{\namount\n:\nfromAmount\n,\nchainId\n:\nchainId\n,\ntoTokenAddress\n:\ntoTokenAddress\n,\nfromTokenAddress\n:\nfromTokenAddress\n,\n}\n;\n4.2 定义辅助函数\n/**\n * Get swap quote from DEX API\n *\n@param\nfromTokenAddress\n- Source token address\n *\n@param\ntoTokenAddress\n- Destination token address\n *\n@param\namount\n- Amount to swap\n *\n@param\nslippage\n- Maximum slippage (e.g., \"0.5\" for 0.5%)\n *\n@returns\nSwap quote\n */\nasync\nfunction\ngetSwapQuote\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n,\namount\n:\nstring\n,\nslippage\n:\nstring\n=\n'0.5'\n)\n:\nPromise\n<\nany\n>\n{\ntry\n{\nconst\npath\n=\n'dex/aggregator/quote'\n;\nconst\nurl\n=\n`\n${\nbaseUrl\n}\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\nchainId\n:\nchainId\n,\nfromTokenAddress\n,\ntoTokenAddress\n,\namount\n,\nslippage\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to get swap quote:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\nthrow\nerror\n;\n}\n}\n5.请求兑换接口，发起交易\n#\n5.1 定义兑换参数\nconst\nswapParams\n=\n{\nchainId\n:\nchainId\n,\nfromTokenAddress\n,\ntoTokenAddress\n,\namount\n,\nuserWalletAddress\n:\nuserAddress\n,\nslippage\n}\n;\n5.2 定义辅助函数\n/**\n * Get swap quote from DEX API\n *\n@param\nfromTokenAddress\n- Source token address\n *\n@param\ntoTokenAddress\n- Destination token address\n *\n@param\namount\n- Amount to swap\n *\n@param\nuserAddress\n- User wallet address\n *\n@param\nslippage\n- Maximum slippage (e.g., \"0.5\" for 0.5%)\n *\n@returns\nSwap quote\n */\nasync\nfunction\ngetSwapQuote\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n,\namount\n:\nstring\n,\nuserAddress\n:\nstring\n,\nslippage\n:\nstring\n=\n'0.5'\n)\n:\nPromise\n<\nany\n>\n{\ntry\n{\nconst\npath\n=\n'dex/aggregator/swap'\n;\nconst\nurl\n=\n`\n${\nbaseUrl\n}\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\nchainId\n:\nchainId\n,\nfromTokenAddress\n,\ntoTokenAddress\n,\namount\n,\nuserWalletAddress\n:\nuserAddress\n,\nslippage\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to get swap quote:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\nthrow\nerror\n;\n}\n}\n5.3 请求兑换接口拿到 tx 信息\n/**\n * Execute token swap\n *\n@param\nfromTokenAddress\n- Source token address\n *\n@param\ntoTokenAddress\n- Destination token address\n *\n@param\namount\n- Amount to swap\n *\n@param\nslippage\n- Maximum slippage\n */\nasync\nfunction\nexecuteSwap\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n,\namount\n:\nstring\n,\nslippage\n:\nstring\n=\n'0.5'\n)\n:\nPromise\n<\nstring\n>\n{\n// 1. Check allowance and approve if necessary (skip for native token)\nif\n(\nfromTokenAddress\n!==\nETH_ADDRESS\n)\n{\nawait\napproveToken\n(\nfromTokenAddress\n,\namount\n)\n;\n}\n// 2. Get swap transaction data\nconst\nswapData\n=\nawait\ngetSwapTransaction\n(\nfromTokenAddress\n,\ntoTokenAddress\n,\namount\n,\nWALLET_ADDRESS\n,\nslippage\n)\n;\nconst\ntxData\n=\nswapData\n.\ntx\n;\nconsole\n.\nlog\n(\n\"Swap TX data received\"\n)\n;\n// 3. Get accurate gas limit using Onchain gateway API\nconst\ngasLimit\n=\nawait\ngetGasLimit\n(\nWALLET_ADDRESS\n,\ntxData\n.\nto\n,\ntxData\n.\nvalue\n||\n'0'\n,\ntxData\n.\ndata\n)\n;\nconsole\n.\nlog\n(\n\"Gas limit received\"\n)\n;\n// 4. Get current nonce\nconst\nnonce\n=\nawait\nweb3\n.\neth\n.\ngetTransactionCount\n(\nWALLET_ADDRESS\n,\n'latest'\n)\n;\nconsole\n.\nlog\n(\n\"Nonce received\"\n)\n;\n// 5. Get current gas price and adjust for faster confirmation\nconst\ngasPrice\n=\nawait\nweb3\n.\neth\n.\ngetGasPrice\n(\n)\n;\nconst\nadjustedGasPrice\n=\nBigInt\n(\ngasPrice\n)\n*\nBigInt\n(\n15\n)\n/\nBigInt\n(\n10\n)\n;\n// 1.5x for faster confirmation\nconsole\n.\nlog\n(\n\"Gas price received\"\n)\n;\n// 6. Create transaction object\nconst\ntxObject\n=\n{\nfrom\n:\nWALLET_ADDRESS\n,\nto\n:\ntxData\n.\nto\n,\ndata\n:\ntxData\n.\ndata\n,\nvalue\n:\ntxData\n.\nvalue\n||\n'0'\n,\ngas\n:\ngasLimit\n,\ngasPrice\n:\nadjustedGasPrice\n.\ntoString\n(\n)\n,\nnonce\n:\nnonce\n}\n;\nconsole\n.\nlog\n(\n\"TX build complete\"\n)\n;\n// 7. Sign transaction\nconst\n{\nsignedTx\n}\n=\nawait\nweb3\n.\neth\n.\naccounts\n.\nsignTransaction\n(\ntxObject\n,\nPRIVATE_KEY\n)\n;\nconsole\n.\nlog\n(\n\"TX signed\"\n)\n;\nconst\nchainTxInfo\n=\nawait\nweb3\n.\neth\n.\nsendSignedTransaction\n(\nsignedTx\n)\n;\nconsole\n.\nlog\n(\n'chainTxInfo:'\n,\nchainTxInfo\n)\n;\n}\n6. 广播交易\n#\n6.1 用\nRPC\n广播交易\nconst\nchainTxInfo\n=\nawait\nweb3\n.\neth\n.\nsendSignedTransaction\n(\nsignedTx\n)\n;\nconsole\n.\nlog\n(\n'chainTxInfo:'\n,\nchainTxInfo\n)\n;\n6.2 用\n交易上链 API\n广播交易\ntry\n{\nconst\npath\n=\n'dex/pre-transaction/broadcast-transaction'\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconst\nbroadcastData\n=\n{\nsignedTx\n:\nsignedTx\n.\nrawTransaction\n,\nchainIndex\n:\nchainId\n,\naddress\n:\nWALLET_ADDRESS\n}\n;\n// Prepare authentication with body included in signature\nconst\nbodyString\n=\nJSON\n.\nstringify\n(\nbroadcastData\n)\n;\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'POST'\n,\nrequestPath\n,\nbodyString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\npost\n(\nurl\n,\nbroadcastData\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nconst\norderId\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norderId\n;\nconsole\n.\nlog\n(\n`\nSwap transaction broadcast successfully, Order ID:\n${\norderId\n}\n`\n)\n;\n// 9. Monitor transaction status\nawait\ntrackTransaction\n(\norderId\n)\n;\nreturn\norderId\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to broadcast swap transaction:'\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n7. 追踪交易\n#\n使用\n交易上链 API\n// Define error info interface\ninterface\nTxErrorInfo\n{\nerror\n:\nstring\n;\nmessage\n:\nstring\n;\naction\n:\nstring\n;\n}\n/**\n * Monitor transaction status\n *\n@param\norderId\n- Order ID from broadcast response\n *\n@param\nintervalMs\n- Polling interval in milliseconds\n *\n@param\ntimeoutMs\n- Maximum time to wait\n *\n@returns\nFinal transaction status\n */\nasync\nfunction\ntrackTransaction\n(\norderId\n:\nstring\n,\nintervalMs\n:\nnumber\n=\n5000\n,\ntimeoutMs\n:\nnumber\n=\n300000\n)\n:\nPromise\n<\nany\n>\n{\nconsole\n.\nlog\n(\n`\nMonitoring transaction with Order ID:\n${\norderId\n}\n`\n)\n;\nconst\nstartTime\n=\nDate\n.\nnow\n(\n)\n;\nlet\nlastStatus\n=\n''\n;\nwhile\n(\nDate\n.\nnow\n(\n)\n-\nstartTime\n<\ntimeoutMs\n)\n{\n// Get transaction status\ntry\n{\nconst\npath\n=\n'dex/post-transaction/orders'\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\norderId\n:\norderId\n,\nchainIndex\n:\nchainId\n,\naddress\n:\nWALLET_ADDRESS\n,\nlimit\n:\n'1'\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n&&\nresponse\n.\ndata\n.\ndata\n&&\nresponse\n.\ndata\n.\ndata\n.\nlength\n>\n0\n)\n{\nif\n(\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n&&\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n.\nlength\n>\n0\n)\n{\nconst\ntxData\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n[\n0\n]\n;\n// Use txStatus to match the API response\nconst\nstatus\n=\ntxData\n.\ntxStatus\n;\n// Only log when status changes\nif\n(\nstatus\n!==\nlastStatus\n)\n{\nlastStatus\n=\nstatus\n;\nif\n(\nstatus\n===\n'1'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction pending:\n${\ntxData\n.\ntxHash\n||\n'Hash not available yet'\n}\n`\n)\n;\n}\nelse\nif\n(\nstatus\n===\n'2'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction successful: https://web3.okx.com/explorer/base/tx/\n${\ntxData\n.\ntxHash\n}\n`\n)\n;\nreturn\ntxData\n;\n}\nelse\nif\n(\nstatus\n===\n'3'\n)\n{\nconst\nfailReason\n=\ntxData\n.\nfailReason\n||\n'Unknown reason'\n;\nconst\nerrorMessage\n=\n`\nTransaction failed:\n${\nfailReason\n}\n`\n;\nconsole\n.\nerror\n(\nerrorMessage\n)\n;\nconst\nerrorInfo\n=\nhandleTransactionError\n(\ntxData\n)\n;\nconsole\n.\nlog\n(\n`\nError type:\n${\nerrorInfo\n.\nerror\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nSuggested action:\n${\nerrorInfo\n.\naction\n}\n`\n)\n;\nthrow\nnew\nError\n(\nerrorMessage\n)\n;\n}\n}\n}\nelse\n{\nconsole\n.\nlog\n(\n`\nNo orders found for Order ID:\n${\norderId\n}\n`\n)\n;\n}\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nwarn\n(\n'Error checking transaction status:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\n}\n// Wait before next check\nawait\nnew\nPromise\n(\nresolve\n=>\nsetTimeout\n(\nresolve\n,\nintervalMs\n)\n)\n;\n}\nthrow\nnew\nError\n(\n'Transaction monitoring timed out'\n)\n;\n}\n/**\n * Comprehensive error handling with failReason\n *\n@param\ntxData\n- Transaction data from post-transaction/orders\n *\n@returns\nStructured error information\n */\nfunction\nhandleTransactionError\n(\ntxData\n:\nany\n)\n:\nTxErrorInfo\n{\nconst\nfailReason\n=\ntxData\n.\nfailReason\n||\n'Unknown reason'\n;\n// Log the detailed error\nconsole\n.\nerror\n(\n`\nTransaction failed with reason:\n${\nfailReason\n}\n`\n)\n;\n// Default error handling\nreturn\n{\nerror\n:\n'TRANSACTION_FAILED'\n,\nmessage\n:\nfailReason\n,\naction\n:\n'Try again or contact support'\n}\n;\n}\n使用\n查询 Dex 交易状态 API\n/**\n * Track transaction status using DEX API\n *\n@param\nchainId\n- Chain ID (e.g., 1 for Ethereum Mainnet)\n *\n@param\ntxHash\n- Transaction hash\n *\n@returns\nTransaction details\n */\nasync\nfunction\ntrackTransactionStatus\n(\nchainId\n:\nstring\n,\ntxHash\n:\nstring\n)\n:\nPromise\n<\nany\n>\n{\ntry\n{\nconst\npath\n=\n'dex/aggregator/history'\n;\nconst\nurl\n=\n`\n${\nbaseUrl\n}\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\nchainId\n:\nchainId\n,\ntxHash\n:\ntxHash\n,\nisFromMyProject\n:\n'true'\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nconst\ntxData\n=\nresponse\n.\ndata\n.\ndata\n;\nconst\nstatus\n=\ntxData\n.\nstatus\n;\nif\n(\nstatus\n===\n'pending'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction is still pending:\n${\ntxHash\n}\n`\n)\n;\nreturn\n{\nstatus\n:\n'pending'\n,\ndetails\n:\ntxData\n}\n;\n}\nelse\nif\n(\nstatus\n===\n'success'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction successful!\n`\n)\n;\nconsole\n.\nlog\n(\n`\nFrom:\n${\ntxData\n.\nfromTokenDetails\n.\nsymbol\n}\n- Amount:\n${\ntxData\n.\nfromTokenDetails\n.\namount\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nTo:\n${\ntxData\n.\ntoTokenDetails\n.\nsymbol\n}\n- Amount:\n${\ntxData\n.\ntoTokenDetails\n.\namount\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nTransaction Fee:\n${\ntxData\n.\ntxFee\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nExplorer URL: https://web3.okx.com/explorer/base/tx/\n${\ntxHash\n}\n`\n)\n;\nreturn\n{\nstatus\n:\n'success'\n,\ndetails\n:\ntxData\n}\n;\n}\nelse\nif\n(\nstatus\n===\n'failure'\n)\n{\nconsole\n.\nerror\n(\n`\nTransaction failed:\n${\ntxData\n.\nerrorMsg\n||\n'Unknown reason'\n}\n`\n)\n;\nreturn\n{\nstatus\n:\n'failure'\n,\ndetails\n:\ntxData\n}\n;\n}\nreturn\ntxData\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to track transaction status:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\nthrow\nerror\n;\n}\n}\n交易上链 API 监控使用 /dex/post-transaction/orders 跟踪内部订单处理状态。它有助于监控交易在 OKX 系统中的移动情况，并提供订单 ID 和 基本状态（1：待处理，2：成功，3：失败）。\nSwap API 交易跟踪使用 /dex/aggregator/history 提供全面的兑换执行详情。它提供特定于代币的信息（代码、金额）、已支付的费用以及详细的区块链数据。如果您需要完整的兑换验证并提供代币级详细信息，请使用此选项。\n选择前者用于基本交易状态更新，而选择后者用于获取兑换执行本身的详细信息。\n8. 完整实现\n#\n这是一个完整的实现示例：\n// Token Swap using OKX Onchain gateway API on Base\n// Required packages\nimport\n{\nWeb3\n}\nfrom\n'web3'\n;\nimport\naxios\nfrom\n'axios'\n;\nimport\n*\nas\ndotenv\nfrom\n'dotenv'\n;\nimport\nCryptoJS\nfrom\n'crypto-js'\n;\n// Load environment variables\ndotenv\n.\nconfig\n(\n)\n;\n// Connect to Base network\nconst\nweb3\n=\nnew\nWeb3\n(\n'https://mainnet.base.org'\n)\n;\n// Your wallet information - REPLACE WITH YOUR OWN VALUES\nconst\nWALLET_ADDRESS\n:\nstring\n=\nprocess\n.\nenv\n.\nEVM_WALLET_ADDRESS\n||\n'0xYourWalletAddress'\n;\nconst\nPRIVATE_KEY\n:\nstring\n=\nprocess\n.\nenv\n.\nEVM_PRIVATE_KEY\n||\n'YourPrivateKey'\n;\n// Without 0x prefix\n// Token addresses for swap on Base\nconst\nETH_ADDRESS\n:\nstring\n=\n'0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'\n;\n// Native ETH\nconst\nUSDC_ADDRESS\n:\nstring\n=\n'0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'\n;\n// Base USDC\n// Chain ID for Base\nconst\nchainId\n:\nstring\n=\n'8453'\n;\n// API URL\n// const baseUrl: string = 'https://web3.okx.com/api/v5/';\nconst\nbaseUrl\n:\nstring\n=\n'https://beta.okex.org/api/v5/'\n// Amount to swap in smallest unit (approx $1 of ETH)\n// 1 ETH = 10^18 wei, so 0.0005 ETH = 5 * 10^14 wei at ~$2000/ETH\nconst\nSWAP_AMOUNT\n:\nstring\n=\n'500000000000000'\n;\n// 0.0005 ETH (approx $1)\nconst\nSLIPPAGE\n:\nstring\n=\n'0.5'\n;\n// 0.5% slippage tolerance\n// Define type for error handling\ninterface\nTxErrorInfo\n{\nerror\n:\nstring\n;\nmessage\n:\nstring\n;\naction\n:\nstring\n;\n}\n// ===== Get Header Function =====\nexport\nfunction\ngetHeaders\n(\ntimestamp\n:\nstring\n,\nmethod\n:\nstring\n,\nrequestPath\n:\nstring\n,\nqueryString\n=\n\"\"\n)\n{\nconst\napiKey\n=\nprocess\n.\nenv\n.\nOKX_API_KEY\n;\nconst\nsecretKey\n=\nprocess\n.\nenv\n.\nOKX_SECRET_KEY\n;\nconst\napiPassphrase\n=\nprocess\n.\nenv\n.\nOKX_API_PASSPHRASE\n;\nconst\nprojectId\n=\nprocess\n.\nenv\n.\nOKX_PROJECT_ID\n;\nif\n(\n!\napiKey\n||\n!\nsecretKey\n||\n!\napiPassphrase\n||\n!\nprojectId\n)\n{\nthrow\nnew\nError\n(\n\"Missing required environment variables\"\n)\n;\n}\nconst\nstringToSign\n=\ntimestamp\n+\nmethod\n+\nrequestPath\n+\nqueryString\n;\nreturn\n{\n\"Content-Type\"\n:\n\"application/json\"\n,\n\"OK-ACCESS-KEY\"\n:\napiKey\n,\n\"OK-ACCESS-SIGN\"\n:\nCryptoJS\n.\nenc\n.\nBase64\n.\nstringify\n(\nCryptoJS\n.\nHmacSHA256\n(\nstringToSign\n,\nsecretKey\n)\n)\n,\n\"OK-ACCESS-TIMESTAMP\"\n:\ntimestamp\n,\n\"OK-ACCESS-PASSPHRASE\"\n:\napiPassphrase\n,\n\"OK-ACCESS-PROJECT\"\n:\nprojectId\n,\n}\n;\n}\n// ===== Token Approval Functions =====\n/**\n * Check token allowance for DEX\n *\n@param\ntokenAddress\n- Token contract address\n *\n@param\nownerAddress\n- Your wallet address\n *\n@param\nspenderAddress\n- DEX spender address\n *\n@returns\nAllowance amount\n */\nasync\nfunction\ncheckAllowance\n(\ntokenAddress\n:\nstring\n,\nownerAddress\n:\nstring\n,\nspenderAddress\n:\nstring\n)\n:\nPromise\n<\nbigint\n>\n{\nconst\ntokenABI\n=\n[\n{\n\"constant\"\n:\ntrue\n,\n\"inputs\"\n:\n[\n{\n\"name\"\n:\n\"_owner\"\n,\n\"type\"\n:\n\"address\"\n}\n,\n{\n\"name\"\n:\n\"_spender\"\n,\n\"type\"\n:\n\"address\"\n}\n]\n,\n\"name\"\n:\n\"allowance\"\n,\n\"outputs\"\n:\n[\n{\n\"name\"\n:\n\"\"\n,\n\"type\"\n:\n\"uint256\"\n}\n]\n,\n\"payable\"\n:\nfalse\n,\n\"stateMutability\"\n:\n\"view\"\n,\n\"type\"\n:\n\"function\"\n}\n]\n;\nconst\ntokenContract\n=\nnew\nweb3\n.\neth\n.\nContract\n(\ntokenABI\n,\ntokenAddress\n)\n;\ntry\n{\nconst\nallowance\n=\nawait\ntokenContract\n.\nmethods\n.\nallowance\n(\nownerAddress\n,\nspenderAddress\n)\n.\ncall\n(\n)\n;\nreturn\nBigInt\n(\nString\n(\nallowance\n)\n)\n;\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to query allowance:'\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n/**\n * Get approve transaction data from OKX DEX API\n *\n@param\ntokenAddress\n- Token contract address\n *\n@param\namount\n- Amount to approve\n *\n@returns\nApproval transaction data\n */\nasync\nfunction\ngetApproveTransaction\n(\ntokenAddress\n:\nstring\n,\namount\n:\nstring\n)\n:\nPromise\n<\nany\n>\n{\ntry\n{\nconst\npath\n=\n'dex/aggregator/approve-transaction'\n;\nconst\nurl\n=\n`\n${\nbaseUrl\n}\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\nchainId\n:\nchainId\n,\ntokenContractAddress\n:\ntokenAddress\n,\napproveAmount\n:\namount\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to get approval transaction data:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\nthrow\nerror\n;\n}\n}\n/**\n * Get transaction gas limit from Onchain gateway API\n *\n@param\nfromAddress\n- Sender address\n *\n@param\ntoAddress\n- Target contract address\n *\n@param\ntxAmount\n- Transaction amount (0 for approvals)\n *\n@param\ninputData\n- Transaction calldata\n *\n@returns\nEstimated gas limit\n */\nasync\nfunction\ngetGasLimit\n(\nfromAddress\n:\nstring\n,\ntoAddress\n:\nstring\n,\ntxAmount\n:\nstring\n=\n'0'\n,\ninputData\n:\nstring\n=\n''\n)\n:\nPromise\n<\nstring\n>\n{\ntry\n{\nconst\npath\n=\n'dex/pre-transaction/gas-limit'\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconsole\n.\nlog\n(\n{\npath\n:\npath\n,\nurl\n:\nurl\n}\n)\nconst\nbody\n=\n{\nchainIndex\n:\nchainId\n,\nfromAddress\n:\nfromAddress\n,\ntoAddress\n:\ntoAddress\n,\ntxAmount\n:\ntxAmount\n,\nextJson\n:\n{\ninputData\n:\ninputData\n}\n}\n;\n// Prepare authentication with body included in signature\nconst\nbodyString\n=\nJSON\n.\nstringify\n(\nbody\n)\n;\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'POST'\n,\nrequestPath\n,\nbodyString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\npost\n(\nurl\n,\nbody\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\ngasLimit\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to get gas limit:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\nthrow\nerror\n;\n}\n}\n/**\n * Sign and send approve transaction\n *\n@param\ntokenAddress\n- Token to approve\n *\n@param\namount\n- Amount to approve\n *\n@returns\nOrder ID of the approval transaction\n */\nasync\nfunction\napproveToken\n(\ntokenAddress\n:\nstring\n,\namount\n:\nstring\n)\n:\nPromise\n<\nstring\n|\nnull\n>\n{\nconst\nspenderAddress\n=\n'0x6b2C0c7be2048Daa9b5527982C29f48062B34D58'\n;\n// Base DEX spender\nconst\ncurrentAllowance\n=\nawait\ncheckAllowance\n(\ntokenAddress\n,\nWALLET_ADDRESS\n,\nspenderAddress\n)\n;\nif\n(\ncurrentAllowance\n>=\nBigInt\n(\namount\n)\n)\n{\nconsole\n.\nlog\n(\n'Sufficient allowance already exists'\n)\n;\nreturn\nnull\n;\n}\nconsole\n.\nlog\n(\n'Insufficient allowance, approving tokens...'\n)\n;\n// Get approve transaction data from OKX DEX API\nconst\napproveData\n=\nawait\ngetApproveTransaction\n(\ntokenAddress\n,\namount\n)\n;\n// Get accurate gas limit using Onchain gateway API\nconst\ngasLimit\n=\nawait\ngetGasLimit\n(\nWALLET_ADDRESS\n,\ntokenAddress\n,\n'0'\n,\napproveData\n.\ndata\n)\n;\n// Get current gas price (can also use Onchain gateway API)\nconst\ngasPrice\n=\nawait\nweb3\n.\neth\n.\ngetGasPrice\n(\n)\n;\nconst\nadjustedGasPrice\n=\nBigInt\n(\ngasPrice\n)\n*\nBigInt\n(\n15\n)\n/\nBigInt\n(\n10\n)\n;\n// 1.5x for faster confirmation\n// Get current nonce\nconst\nnonce\n=\nawait\nweb3\n.\neth\n.\ngetTransactionCount\n(\nWALLET_ADDRESS\n,\n'latest'\n)\n;\n// Create transaction object\nconst\ntxObject\n=\n{\nfrom\n:\nWALLET_ADDRESS\n,\nto\n:\ntokenAddress\n,\ndata\n:\napproveData\n.\ndata\n,\nvalue\n:\n'0'\n,\ngas\n:\ngasLimit\n,\ngasPrice\n:\nadjustedGasPrice\n.\ntoString\n(\n)\n,\nnonce\n:\nnonce\n}\n;\n// Sign transaction\nconst\nsignedTx\n=\nawait\nweb3\n.\neth\n.\naccounts\n.\nsignTransaction\n(\ntxObject\n,\nPRIVATE_KEY\n)\n;\n// Broadcast transaction using Onchain gateway API\ntry\n{\nconst\npath\n=\n'dex/pre-transaction/broadcast-transaction'\n;\nconst\nurl\n=\n`\n${\nbaseUrl\n}\n${\npath\n}\n`\n;\nconst\nbroadcastData\n=\n{\nsignedTx\n:\nsignedTx\n.\nrawTransaction\n,\nchainIndex\n:\nchainId\n,\naddress\n:\nWALLET_ADDRESS\n}\n;\n// Prepare authentication with body included in signature\nconst\nbodyString\n=\nJSON\n.\nstringify\n(\nbroadcastData\n)\n;\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'POST'\n,\nrequestPath\n,\nbodyString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\npost\n(\nurl\n,\nbroadcastData\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nconst\norderId\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norderId\n;\nconsole\n.\nlog\n(\n`\nApproval transaction broadcast successfully, Order ID:\n${\norderId\n}\n`\n)\n;\n// Monitor transaction status\nawait\ntrackTransaction\n(\norderId\n)\n;\nreturn\norderId\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to broadcast approval transaction:'\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n// ===== Swap Functions =====\n/**\n * Get swap quote from DEX API\n *\n@param\nfromTokenAddress\n- Source token address\n *\n@param\ntoTokenAddress\n- Destination token address\n *\n@param\namount\n- Amount to swap\n *\n@param\nuserAddress\n- User wallet address\n *\n@param\nslippage\n- Maximum slippage (e.g., \"0.5\" for 0.5%)\n *\n@returns\nSwap quote\n */\nasync\nfunction\ngetSwapQuote\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n,\namount\n:\nstring\n,\nuserAddress\n:\nstring\n,\nslippage\n:\nstring\n=\n'0.5'\n)\n:\nPromise\n<\nany\n>\n{\ntry\n{\nconst\npath\n=\n'dex/aggregator/swap'\n;\nconst\nurl\n=\n`\n${\nbaseUrl\n}\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\nchainId\n:\nchainId\n,\nfromTokenAddress\n,\ntoTokenAddress\n,\namount\n,\nuserWalletAddress\n:\nuserAddress\n,\nslippage\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to get swap quote:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\nthrow\nerror\n;\n}\n}\n/**\n * Get swap transaction data from DEX API\n *\n@param\nfromTokenAddress\n- Source token address\n *\n@param\ntoTokenAddress\n- Destination token address\n *\n@param\namount\n- Amount to swap\n *\n@param\nuserAddress\n- User wallet address\n *\n@param\nslippage\n- Maximum slippage\n *\n@returns\nSwap transaction data\n */\nasync\nfunction\ngetSwapTransaction\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n,\namount\n:\nstring\n,\nuserAddress\n:\nstring\n,\nslippage\n:\nstring\n=\n'0.5'\n)\n:\nPromise\n<\nany\n>\n{\ntry\n{\nconst\npath\n=\n'dex/aggregator/swap'\n;\nconst\nurl\n=\n`\n${\nbaseUrl\n}\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\nchainId\n:\nchainId\n,\nfromTokenAddress\n,\ntoTokenAddress\n,\namount\n,\nuserWalletAddress\n:\nuserAddress\n,\nslippage\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nreturn\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to get swap transaction data:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\nthrow\nerror\n;\n}\n}\n/**\n * Execute token swap\n *\n@param\nfromTokenAddress\n- Source token address\n *\n@param\ntoTokenAddress\n- Destination token address\n *\n@param\namount\n- Amount to swap\n *\n@param\nslippage\n- Maximum slippage\n *\n@returns\nOrder ID of the swap transaction\n */\nasync\nfunction\nexecuteSwap\n(\nfromTokenAddress\n:\nstring\n,\ntoTokenAddress\n:\nstring\n,\namount\n:\nstring\n,\nslippage\n:\nstring\n=\n'0.5'\n)\n:\nPromise\n<\nstring\n>\n{\n// 1. Check allowance and approve if necessary (skip for native token)\nif\n(\nfromTokenAddress\n!==\nETH_ADDRESS\n)\n{\nawait\napproveToken\n(\nfromTokenAddress\n,\namount\n)\n;\n}\n// 2. Get swap transaction data\nconst\nswapData\n=\nawait\ngetSwapTransaction\n(\nfromTokenAddress\n,\ntoTokenAddress\n,\namount\n,\nWALLET_ADDRESS\n,\nslippage\n)\n;\nconst\ntxData\n=\nswapData\n.\ntx\n;\nconsole\n.\nlog\n(\n\"Swap TX data received\"\n)\n;\n// 3. Get accurate gas limit using Onchain gateway API\nconst\ngasLimit\n=\nawait\ngetGasLimit\n(\nWALLET_ADDRESS\n,\ntxData\n.\nto\n,\ntxData\n.\nvalue\n||\n'0'\n,\ntxData\n.\ndata\n)\n;\nconsole\n.\nlog\n(\n\"Gas limit received\"\n)\n;\n// 4. Get current nonce\nconst\nnonce\n=\nawait\nweb3\n.\neth\n.\ngetTransactionCount\n(\nWALLET_ADDRESS\n,\n'latest'\n)\n;\nconsole\n.\nlog\n(\n\"Nonce received\"\n)\n;\n// 5. Get current gas price and adjust for faster confirmation\nconst\ngasPrice\n=\nawait\nweb3\n.\neth\n.\ngetGasPrice\n(\n)\n;\nconst\nadjustedGasPrice\n=\nBigInt\n(\ngasPrice\n)\n*\nBigInt\n(\n15\n)\n/\nBigInt\n(\n10\n)\n;\n// 1.5x for faster confirmation\nconsole\n.\nlog\n(\n\"Gas price received\"\n)\n;\n// 6. Create transaction object\nconst\ntxObject\n=\n{\nfrom\n:\nWALLET_ADDRESS\n,\nto\n:\ntxData\n.\nto\n,\ndata\n:\ntxData\n.\ndata\n,\nvalue\n:\ntxData\n.\nvalue\n||\n'0'\n,\ngas\n:\ngasLimit\n,\ngasPrice\n:\nadjustedGasPrice\n.\ntoString\n(\n)\n,\nnonce\n:\nnonce\n}\n;\nconsole\n.\nlog\n(\n\"TX build complete\"\n)\n;\n// 7. Sign transaction\nconst\nsignedTx\n=\nawait\nweb3\n.\neth\n.\naccounts\n.\nsignTransaction\n(\ntxObject\n,\nPRIVATE_KEY\n)\n;\nconsole\n.\nlog\n(\n\"TX signed\"\n)\n;\n// 8. Broadcast transaction using Onchain gateway API\ntry\n{\nconst\npath\n=\n'dex/pre-transaction/broadcast-transaction'\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconst\nbroadcastData\n=\n{\nsignedTx\n:\nsignedTx\n.\nrawTransaction\n,\nchainIndex\n:\nchainId\n,\naddress\n:\nWALLET_ADDRESS\n}\n;\n// Prepare authentication with body included in signature\nconst\nbodyString\n=\nJSON\n.\nstringify\n(\nbroadcastData\n)\n;\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'POST'\n,\nrequestPath\n,\nbodyString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\npost\n(\nurl\n,\nbroadcastData\n,\n{\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n)\n{\nconst\norderId\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norderId\n;\nconsole\n.\nlog\n(\n`\nSwap transaction broadcast successfully, Order ID:\n${\norderId\n}\n`\n)\n;\n// 9. Monitor transaction status\nawait\ntrackTransaction\n(\norderId\n)\n;\nreturn\norderId\n;\n}\nelse\n{\nthrow\nnew\nError\n(\n`\nAPI Error:\n${\nresponse\n.\ndata\n.\nmsg\n||\n'Unknown error'\n}\n`\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to broadcast swap transaction:'\n,\nerror\n)\n;\nthrow\nerror\n;\n}\n}\n// ===== Transaction Monitoring =====\n/**\n * Monitor transaction status\n *\n@param\norderId\n- Order ID from broadcast response\n *\n@param\nintervalMs\n- Polling interval in milliseconds\n *\n@param\ntimeoutMs\n- Maximum time to wait\n *\n@returns\nFinal transaction status\n */\nasync\nfunction\ntrackTransaction\n(\norderId\n:\nstring\n,\nintervalMs\n:\nnumber\n=\n5000\n,\ntimeoutMs\n:\nnumber\n=\n300000\n)\n:\nPromise\n<\nany\n>\n{\nconsole\n.\nlog\n(\n`\nMonitoring transaction with Order ID:\n${\norderId\n}\n`\n)\n;\nconst\nstartTime\n=\nDate\n.\nnow\n(\n)\n;\nlet\nlastStatus\n=\n''\n;\nwhile\n(\nDate\n.\nnow\n(\n)\n-\nstartTime\n<\ntimeoutMs\n)\n{\n// Get transaction status\ntry\n{\nconst\npath\n=\n'dex/post-transaction/orders'\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\norderId\n:\norderId\n,\nchainIndex\n:\nchainId\n,\naddress\n:\nWALLET_ADDRESS\n,\nlimit\n:\n'1'\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n&&\nresponse\n.\ndata\n.\ndata\n&&\nresponse\n.\ndata\n.\ndata\n.\nlength\n>\n0\n)\n{\nif\n(\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n&&\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n.\nlength\n>\n0\n)\n{\nconst\ntxData\n=\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\norders\n[\n0\n]\n;\n// Use txStatus to match the API response\nconst\nstatus\n=\ntxData\n.\ntxStatus\n;\n// Only log when status changes\nif\n(\nstatus\n!==\nlastStatus\n)\n{\nlastStatus\n=\nstatus\n;\nif\n(\nstatus\n===\n'1'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction pending:\n${\ntxData\n.\ntxHash\n||\n'Hash not available yet'\n}\n`\n)\n;\n}\nelse\nif\n(\nstatus\n===\n'2'\n)\n{\nconsole\n.\nlog\n(\n`\nTransaction successful: https://web3.okx.com/explorer/base/tx/\n${\ntxData\n.\ntxHash\n}\n`\n)\n;\nreturn\ntxData\n;\n}\nelse\nif\n(\nstatus\n===\n'3'\n)\n{\nconst\nfailReason\n=\ntxData\n.\nfailReason\n||\n'Unknown reason'\n;\nconst\nerrorMessage\n=\n`\nTransaction failed:\n${\nfailReason\n}\n`\n;\nconsole\n.\nerror\n(\nerrorMessage\n)\n;\nconst\nerrorInfo\n=\nhandleTransactionError\n(\ntxData\n)\n;\nconsole\n.\nlog\n(\n`\nError type:\n${\nerrorInfo\n.\nerror\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nSuggested action:\n${\nerrorInfo\n.\naction\n}\n`\n)\n;\nthrow\nnew\nError\n(\nerrorMessage\n)\n;\n}\n}\n}\nelse\n{\nconsole\n.\nlog\n(\n`\nNo orders found for Order ID:\n${\norderId\n}\n`\n)\n;\n}\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nwarn\n(\n'Error checking transaction status:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\n}\n// Wait before next check\nawait\nnew\nPromise\n(\nresolve\n=>\nsetTimeout\n(\nresolve\n,\nintervalMs\n)\n)\n;\n}\nthrow\nnew\nError\n(\n'Transaction monitoring timed out'\n)\n;\n}\n/**\n * Comprehensive error handling with failReason\n *\n@param\ntxData\n- Transaction data from post-transaction/orders\n *\n@returns\nStructured error information\n */\nfunction\nhandleTransactionError\n(\ntxData\n:\nany\n)\n:\nTxErrorInfo\n{\nconst\nfailReason\n=\ntxData\n.\nfailReason\n||\n'Unknown reason'\n;\n// Log the detailed error\nconsole\n.\nerror\n(\n`\nTransaction failed with reason:\n${\nfailReason\n}\n`\n)\n;\n// Default error handling\nreturn\n{\nerror\n:\n'TRANSACTION_FAILED'\n,\nmessage\n:\nfailReason\n,\naction\n:\n'Try again or contact support'\n}\n;\n}\n// ===== Main Function =====\n/**\n* Main function to execute ETH to USDC swap on Base\n*/\nasync\nfunction\nmain\n(\n)\n:\nPromise\n<\nvoid\n>\n{\ntry\n{\nconsole\n.\nlog\n(\n'Starting ETH to USDC swap on Base using Onchain gateway API'\n)\n;\n// Execute swap from ETH to USDC on Base\nconst\norderId\n=\nawait\nexecuteSwap\n(\nETH_ADDRESS\n,\n// From ETH on Base\nUSDC_ADDRESS\n,\n// To USDC on Base\nSWAP_AMOUNT\n,\n// Amount in ETH's smallest unit (0.0005 ETH ≈ $1)\nSLIPPAGE\n// 0.5% slippage\n)\n;\n// Get final transaction details\ntry\n{\nconst\npath\n=\n'dex/post-transaction/orders'\n;\nconst\nurl\n=\n`\nhttps://web3.okx.com/api/v5/\n${\npath\n}\n`\n;\nconst\nparams\n=\n{\norderId\n:\norderId\n,\nchainIndex\n:\nchainId\n}\n;\n// Prepare authentication\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n`\n/api/v5/\n${\npath\n}\n`\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n'GET'\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\naxios\n.\nget\n(\nurl\n,\n{\nparams\n,\nheaders\n}\n)\n;\nif\n(\nresponse\n.\ndata\n.\ncode\n===\n'0'\n&&\nresponse\n.\ndata\n.\ndata\n&&\nresponse\n.\ndata\n.\ndata\n.\nlength\n>\n0\n)\n{\nconsole\n.\nlog\n(\n'Transaction Hash:'\n,\nresponse\n.\ndata\n.\ndata\n[\n0\n]\n.\ntxHash\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Failed to get final transaction details:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\n}\n}\ncatch\n(\nerror\n)\n{\nconsole\n.\nerror\n(\n'Swap failed:'\n,\n(\nerror\nas\nError\n)\n.\nmessage\n)\n;\n}\n}\n// Execute the main function\nmain\n(\n)\n;\n方法2：SDK方法\n#\n使用OKX DEX SDK提供了更简单的开发人员体验，同时保留了API方法的所有功能。SDK为您处理许多实现细节，包括重试逻辑、错误处理和交易管理。\n1.安装SDK\n#\nnpm\ninstall\n@okx-dex/okx-dex-sdk\n# or\nyarn\nadd\n@okx-dex/okx-dex-sdk\n# or\npnpm\nadd\n@okx-dex/okx-dex-sdk\n2.设置环境\n#\n使用您的API凭据和钱包信息创建一个. env文件：\n# OKX API Credentials\nOKX_API_KEY\n=\nyour_api_key\nOKX_SECRET_KEY\n=\nyour_secret_key\nOKX_API_PASSPHRASE\n=\nyour_passphrase\nOKX_PROJECT_ID\n=\nyour_project_id\n# EVM Configuration\nEVM_RPC_URL\n=\nyour_evm_rpc_url\nEVM_WALLET_ADDRESS\n=\nyour_evm_wallet_address\nEVM_PRIVATE_KEY\n=\nyour_evm_private_key\n3.初始化客户端\n#\n为您的DEX客户端创建一个文件（例如，DexClient. ts）：\n// DexClient.ts\nimport\n{\nOKXDexClient\n}\nfrom\n'@okx-dex/okx-dex-sdk'\n;\nimport\n'dotenv/config'\n;\n// Validate environment variables\nconst\nrequiredEnvVars\n=\n[\n'OKX_API_KEY'\n,\n'OKX_SECRET_KEY'\n,\n'OKX_API_PASSPHRASE'\n,\n'OKX_PROJECT_ID'\n,\n'EVM_WALLET_ADDRESS'\n,\n'EVM_PRIVATE_KEY'\n,\n'EVM_RPC_URL'\n]\n;\nfor\n(\nconst\nenvVar\nof\nrequiredEnvVars\n)\n{\nif\n(\n!\nprocess\n.\nenv\n[\nenvVar\n]\n)\n{\nthrow\nnew\nError\n(\n`\nMissing required environment variable:\n${\nenvVar\n}\n`\n)\n;\n}\n}\n// Initialize the client\nexport\nconst\nclient\n=\nnew\nOKXDexClient\n(\n{\napiKey\n:\nprocess\n.\nenv\n.\nOKX_API_KEY\n!\n,\nsecretKey\n:\nprocess\n.\nenv\n.\nOKX_SECRET_KEY\n!\n,\napiPassphrase\n:\nprocess\n.\nenv\n.\nOKX_API_PASSPHRASE\n!\n,\nprojectId\n:\nprocess\n.\nenv\n.\nOKX_PROJECT_ID\n!\n,\nevm\n:\n{\nconnection\n:\n{\nrpcUrl\n:\nprocess\n.\nenv\n.\nEVM_RPC_URL\n!\n,\n}\n,\nwalletAddress\n:\nprocess\n.\nenv\n.\nEVM_WALLET_ADDRESS\n!\n,\nprivateKey\n:\nprocess\n.\nenv\n.\nEVM_PRIVATE_KEY\n!\n,\n}\n}\n)\n;\n4.调用SDK执行代币授权\n#\n创建代币授权工具的功能：\n// approval.ts\nimport\n{\nclient\n}\nfrom\n'./DexClient'\n;\n// Helper function to convert human-readable amounts to base units\nexport\nfunction\ntoBaseUnits\n(\namount\n:\nstring\n,\ndecimals\n:\nnumber\n)\n:\nstring\n{\n// Remove any decimal point and count the decimal places\nconst\n[\nintegerPart\n,\ndecimalPart\n=\n''\n]\n=\namount\n.\nsplit\n(\n'.'\n)\n;\nconst\ncurrentDecimals\n=\ndecimalPart\n.\nlength\n;\n// Combine integer and decimal parts, removing the decimal point\nlet\nresult\n=\nintegerPart\n+\ndecimalPart\n;\n// Add zeros if we need more decimal places\nif\n(\ncurrentDecimals\n<\ndecimals\n)\n{\nresult\n=\nresult\n+\n'0'\n.\nrepeat\n(\ndecimals\n-\ncurrentDecimals\n)\n;\n}\n// Remove digits if we have too many decimal places\nelse\nif\n(\ncurrentDecimals\n>\ndecimals\n)\n{\nresult\n=\nresult\n.\nslice\n(\n0\n,\nresult\n.\nlength\n-\n(\ncurrentDecimals\n-\ndecimals\n)\n)\n;\n}\n// Remove leading zeros\nresult\n=\nresult\n.\nreplace\n(\n/\n^\n0\n+\n/\n,\n''\n)\n||\n'0'\n;\nreturn\nresult\n;\n}\n/**\n* Example: Approve a token for swapping\n*/\nasync\nfunction\nexecuteApproval\n(\ntokenAddress\n:\nstring\n,\namount\n:\nstring\n)\n{\ntry\n{\n// Get token information using quote\nconsole\n.\nlog\n(\n\"Getting token information...\"\n)\n;\nconst\ntokenInfo\n=\nawait\nclient\n.\ndex\n.\ngetQuote\n(\n{\nchainId\n:\n'8453'\n,\n// Base Chain\nfromTokenAddress\n:\ntokenAddress\n,\ntoTokenAddress\n:\n'0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'\n,\n// Native token\namount\n:\n'1000000'\n,\n// Use a reasonable amount for quote\nslippage\n:\n'0.5'\n}\n)\n;\nconst\ntokenDecimals\n=\nparseInt\n(\ntokenInfo\n.\ndata\n[\n0\n]\n.\nfromToken\n.\ndecimal\n)\n;\nconst\nrawAmount\n=\ntoBaseUnits\n(\namount\n,\ntokenDecimals\n)\n;\nconsole\n.\nlog\n(\n`\n\\nApproval Details:\n`\n)\n;\nconsole\n.\nlog\n(\n`\n--------------------\n`\n)\n;\nconsole\n.\nlog\n(\n`\nToken:\n${\ntokenInfo\n.\ndata\n[\n0\n]\n.\nfromToken\n.\ntokenSymbol\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nAmount:\n${\namount\n}\n${\ntokenInfo\n.\ndata\n[\n0\n]\n.\nfromToken\n.\ntokenSymbol\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nAmount in base units:\n${\nrawAmount\n}\n`\n)\n;\n// Execute the approval\nconsole\n.\nlog\n(\n\"\\nExecuting approval...\"\n)\n;\nconst\nresult\n=\nawait\nclient\n.\ndex\n.\nexecuteApproval\n(\n{\nchainId\n:\n'8453'\n,\n// Base Chain\ntokenContractAddress\n:\ntokenAddress\n,\napproveAmount\n:\nrawAmount\n}\n)\n;\nif\n(\n'alreadyApproved'\nin\nresult\n)\n{\nconsole\n.\nlog\n(\n\"\\nToken already approved for the requested amount!\"\n)\n;\nreturn\n{\nsuccess\n:\ntrue\n,\nalreadyApproved\n:\ntrue\n}\n;\n}\nelse\n{\nconsole\n.\nlog\n(\n\"\\nApproval completed successfully!\"\n)\n;\nconsole\n.\nlog\n(\n\"Transaction Hash:\"\n,\nresult\n.\ntransactionHash\n)\n;\nconsole\n.\nlog\n(\n\"Explorer URL:\"\n,\nresult\n.\nexplorerUrl\n)\n;\nreturn\nresult\n;\n}\n}\ncatch\n(\nerror\n)\n{\nif\n(\nerror\ninstanceof\nError\n)\n{\nconsole\n.\nerror\n(\n'Error executing approval:'\n,\nerror\n.\nmessage\n)\n;\n}\nthrow\nerror\n;\n}\n}\n// Run if this file is executed directly\nif\n(\nrequire\n.\nmain\n===\nmodule\n)\n{\n// Example usage: ts-node approval.ts 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 1000\nconst\nargs\n=\nprocess\n.\nargv\n.\nslice\n(\n2\n)\n;\nif\n(\nargs\n.\nlength\n!==\n2\n)\n{\nconsole\n.\nlog\n(\n\"Usage: ts-node approval.ts <tokenAddress> <amountToApprove>\"\n)\n;\nconsole\n.\nlog\n(\n\"\\nExamples:\"\n)\n;\nconsole\n.\nlog\n(\n\" # Approve 1000 USDC\"\n)\n;\nconsole\n.\nlog\n(\n`\nts-node approval.ts 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 1000\n`\n)\n;\nprocess\n.\nexit\n(\n1\n)\n;\n}\nconst\n[\ntokenAddress\n,\namount\n]\n=\nargs\n;\nexecuteApproval\n(\ntokenAddress\n,\namount\n)\n.\nthen\n(\n(\n)\n=>\nprocess\n.\nexit\n(\n0\n)\n)\n.\ncatch\n(\n(\nerror\n)\n=>\n{\nconsole\n.\nerror\n(\n'Error:'\n,\nerror\n)\n;\nprocess\n.\nexit\n(\n1\n)\n;\n}\n)\n;\n}\nexport\n{\nexecuteApproval\n}\n;\n5.调用SDK执行兑换\n#\n创建兑换执行的文件：\n// swap.ts\nimport\n{\nclient\n}\nfrom\n'./DexClient'\n;\n/**\n* Example: Execute a swap from ETH to USDC on Base chain\n*/\nasync\nfunction\nexecuteSwap\n(\n)\n{\ntry\n{\nif\n(\n!\nprocess\n.\nenv\n.\nEVM_PRIVATE_KEY\n)\n{\nthrow\nnew\nError\n(\n'Missing EVM_PRIVATE_KEY in .env file'\n)\n;\n}\n// You can change this to any EVM chain\n// For example, for Base, use chainId: '8453'\n// For example, for baseSepolia, use chainId: '84532'\n// You can also use SUI, use chainId: '784'\n// When using another Chain, you need to change the fromTokenAddress and toTokenAddress to the correct addresses for that chain\nconst\nswapResult\n=\nawait\nclient\n.\ndex\n.\nexecuteSwap\n(\n{\nchainId\n:\n'8453'\n,\n// Base chain ID\nfromTokenAddress\n:\n'0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'\n,\n// Native ETH\ntoTokenAddress\n:\n'0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'\n,\n// USDC on Base\namount\n:\nString\n(\n10\n*\n10\n**\n14\n)\n,\n// .0001 ETH\nslippage\n:\n'0.5'\n,\n// 0.5% slippage\nuserWalletAddress\n:\nprocess\n.\nenv\n.\nEVM_WALLET_ADDRESS\n!\n}\n)\n;\nconsole\n.\nlog\n(\n'Swap executed successfully:'\n)\n;\nconsole\n.\nlog\n(\nJSON\n.\nstringify\n(\nswapResult\n,\nnull\n,\n2\n)\n)\n;\nreturn\nswapResult\n;\n}\ncatch\n(\nerror\n)\n{\nif\n(\nerror\ninstanceof\nError\n)\n{\nconsole\n.\nerror\n(\n'Error executing swap:'\n,\nerror\n.\nmessage\n)\n;\n// API errors include details in the message\nif\n(\nerror\n.\nmessage\n.\nincludes\n(\n'API Error:'\n)\n)\n{\nconst\nmatch\n=\nerror\n.\nmessage\n.\nmatch\n(\n/\nAPI Error:\n(\n.\n*\n)\n/\n)\n;\nif\n(\nmatch\n)\nconsole\n.\nerror\n(\n'API Error Details:'\n,\nmatch\n[\n1\n]\n)\n;\n}\n}\nthrow\nerror\n;\n}\n}\n// Run if this file is executed directly\nif\n(\nrequire\n.\nmain\n===\nmodule\n)\n{\nexecuteSwap\n(\n)\n.\nthen\n(\n(\n)\n=>\nprocess\n.\nexit\n(\n0\n)\n)\n.\ncatch\n(\n(\nerror\n)\n=>\n{\nconsole\n.\nerror\n(\n'Error:'\n,\nerror\n)\n;\nprocess\n.\nexit\n(\n1\n)\n;\n}\n)\n;\n}\nexport\n{\nexecuteSwap\n}\n;\n6.附加的SDK功能\n#\nSDK提供了简化开发的附加方法：\n获取代币对的报价\nconst\nquote\n=\nawait\nclient\n.\ndex\n.\ngetQuote\n(\n{\nchainId\n:\n'8453'\n,\n// Base Chain\nfromTokenAddress\n:\n'0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'\n,\n// USDC\ntoTokenAddress\n:\n'0x4200000000000000000000000000000000000006'\n,\n// WETH\namount\n:\n'1000000'\n,\n// 1 USDC (in smallest units)\nslippage\n:\n'0.5'\n// 0.5%\n}\n)\n;",
  "html": "<div class=\"routes_md__xWlGF\"><h1 id=\"在-evm-链上搭建兑换应用\">在 EVM 链上搭建兑换应用<a class=\"index_header-anchor__Xqb+L\" href=\"#在-evm-链上搭建兑换应用\" style=\"opacity: 0;\">#</a></h1>\n<p>在EVM网络上使用OKX DEX构建兑换应用程序有两种方法：</p>\n<ol>\n<li>API 方法-直接调用 OKX DEX API</li>\n<li>SDK 方法-使用 <code>@okx-dex/okx-dex-sdk</code> 简化开发人员体验</li>\n</ol>\n<p>本指南涵盖了这两种方法，以帮助您选择最适合您需求的方法。</p>\n<h2 data-content=\"方法1：API方法\" id=\"方法1：api方法\">方法1：API方法<a class=\"index_header-anchor__Xqb+L\" href=\"#方法1：api方法\" style=\"opacity: 0;\">#</a></h2>\n<p>在这种方法中，我们将直接使用OKX DEX API演示代币兑换。我们将在以太坊网络上将USDC兑换为ETH。</p>\n<h2 data-content=\"1.设置环境\" id=\"1.设置环境\">1.设置环境<a class=\"index_header-anchor__Xqb+L\" href=\"#1.设置环境\" style=\"opacity: 0;\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// --------------------- npm package ---------------------</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Web3 <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'web3'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> dotenv <span class=\"token keyword\">from</span> <span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> CryptoJS <span class=\"token keyword\">from</span> <span class=\"token string\">'crypto-js'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// The URL for the Ethereum node you want to connect to</span>\n<span class=\"token keyword\">const</span> web3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Web3</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://......com'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// --------------------- environment variable ---------------------</span>\n\n<span class=\"token comment\">// Load hidden environment variables</span>\ndotenv<span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Your wallet information - REPLACE WITH YOUR OWN VALUES</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EVM_WALLET_ADDRESS</span> <span class=\"token operator\">||</span> <span class=\"token string\">'0xYourWalletAddress'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PRIVATE_KEY</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EVM_PRIVATE_KEY</span> <span class=\"token operator\">||</span> <span class=\"token string\">'YourPrivateKey'</span><span class=\"token punctuation\">;</span> \n\n<span class=\"token comment\">// Token addresses for swap on Ethereum Mainnet</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">ETH_ADDRESS</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Native ETH</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">USDC_ADDRESS</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// USDC</span>\n\n<span class=\"token comment\">// Chain ID for Ethereum Mainnet</span>\n<span class=\"token keyword\">const</span> chainId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// API URL</span>\n<span class=\"token keyword\">const</span> baseUrl<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'https://web3.okx.com/api/v5/'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Amount to swap in smallest unit (approx $1 of ETH)</span>\n<span class=\"token comment\">// 1 ETH = 10^18 wei, so 0.0005 ETH</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SWAP_AMOUNT</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'500000000000000'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 0.0005 ETH (approx $1)</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SLIPPAGE</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 0.5% slippage tolerance</span>\n\n<span class=\"token comment\">// --------------------- util function ---------------------</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> method<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">// Check https://web3.okx.com/zh-hans/web3/build/docs/waas/rest-authentication for api-key</span>\n    <span class=\"token keyword\">const</span> apiKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_KEY</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> secretKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_SECRET_KEY</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> apiPassphrase <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_PASSPHRASE</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> projectId <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_PROJECT_ID</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>apiKey <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>secretKey <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>apiPassphrase <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>projectId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Missing required environment variables\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> stringToSign <span class=\"token operator\">=</span> timestamp <span class=\"token operator\">+</span> method <span class=\"token operator\">+</span> requestPath <span class=\"token operator\">+</span> queryString<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string-property property\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-KEY\"</span><span class=\"token operator\">:</span> apiKey<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-SIGN\"</span><span class=\"token operator\">:</span> CryptoJS<span class=\"token punctuation\">.</span>enc<span class=\"token punctuation\">.</span>Base64<span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>\n            CryptoJS<span class=\"token punctuation\">.</span><span class=\"token function\">HmacSHA256</span><span class=\"token punctuation\">(</span>stringToSign<span class=\"token punctuation\">,</span> secretKey<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-TIMESTAMP\"</span><span class=\"token operator\">:</span> timestamp<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-PASSPHRASE\"</span><span class=\"token operator\">:</span> apiPassphrase<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-PROJECT\"</span><span class=\"token operator\">:</span> projectId<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"2.检查授权额度\" id=\"2.检查授权额度\">2.检查授权额度<a class=\"index_header-anchor__Xqb+L\" href=\"#2.检查授权额度\" style=\"opacity: 0;\">#</a></h2>\n<p>您需要检查代币是否已批准DEX进行支出。此步骤仅适用于ERC20代币，而不是像ETH这样的本地代币。</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token doc-comment comment\">/**\n * Check token allowance for DEX\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">tokenAddress</span> - Token contract address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">ownerAddress</span> - Your wallet address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">spenderAddress</span> - DEX spender address\n * <span class=\"token keyword\">@returns</span> Allowance amount\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">checkAllowance</span><span class=\"token punctuation\">(</span>\n  tokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  ownerAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  spenderAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>bigint<span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> tokenABI <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">\"constant\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"inputs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"_owner\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"address\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"_spender\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"address\"</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"allowance\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"outputs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"uint256\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"payable\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"stateMutability\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"view\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"function\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> tokenContract <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">web3</span><span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">Contract</span><span class=\"token punctuation\">(</span>tokenABI<span class=\"token punctuation\">,</span> tokenAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> allowance <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> tokenContract<span class=\"token punctuation\">.</span>methods<span class=\"token punctuation\">.</span><span class=\"token function\">allowance</span><span class=\"token punctuation\">(</span>ownerAddress<span class=\"token punctuation\">,</span> spenderAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>allowance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to query allowance:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"3.检查授权交易参数并发起授权\" id=\"3.检查授权交易参数并发起授权\">3.检查授权交易参数并发起授权<a class=\"index_header-anchor__Xqb+L\" href=\"#3.检查授权交易参数并发起授权\" style=\"opacity: 0;\">#</a></h2>\n<p>由于 allowanceAmount 小于 fromTokenAmount，你需要对该币种进行授权。</p>\n<p>3.1 定义授权交易参数</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> getApproveTransactionParams <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n  tokenContractAddress<span class=\"token operator\">:</span> tokenAddress<span class=\"token punctuation\">,</span>\n  approveAmount<span class=\"token operator\">:</span> amount\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>3.2 定义辅助函数</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getApproveTransaction</span><span class=\"token punctuation\">(</span>\n  tokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/aggregator/approve-transaction'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>baseUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      tokenContractAddress<span class=\"token operator\">:</span> tokenAddress<span class=\"token punctuation\">,</span>\n      approveAmount<span class=\"token operator\">:</span> amount\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to get approval transaction data:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>3.3 计算 gasLimit</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token doc-comment comment\">/**\n * Get transaction gas limit from Onchain gateway API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">fromAddress</span> - Sender address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">toAddress</span> - Target contract address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">txAmount</span> - Transaction amount (0 for approvals)\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">inputData</span> - Transaction calldata\n * <span class=\"token keyword\">@returns</span> Estimated gas limit\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getGasLimit</span><span class=\"token punctuation\">(</span>\n  fromAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  toAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  txAmount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n  inputData<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/pre-transaction/gas-limit'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainIndex<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      fromAddress<span class=\"token operator\">:</span> fromAddress<span class=\"token punctuation\">,</span>\n      toAddress<span class=\"token operator\">:</span> toAddress<span class=\"token punctuation\">,</span>\n      txAmount<span class=\"token operator\">:</span> txAmount<span class=\"token punctuation\">,</span>\n      extJson<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        inputData<span class=\"token operator\">:</span> inputData\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication with body included in signature</span>\n    <span class=\"token keyword\">const</span> bodyString <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> bodyString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> body<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>gasLimit<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to get gas limit:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>3.4 获取授权交易 tx 并且发送授权请求</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token doc-comment comment\">/**\n * Sign and send approve transaction\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">tokenAddress</span> - Token to approve\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">amount</span> - Amount to approve\n * <span class=\"token keyword\">@returns</span> Order ID of the approval transaction\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">approveToken</span><span class=\"token punctuation\">(</span>tokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> spenderAddress <span class=\"token operator\">=</span> <span class=\"token string\">'0x3b3ae790Df4F312e745D270119c6052904FB6790'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Ethereum Mainnet DEX spender</span>\n  <span class=\"token comment\">// See Router addresses at:  https://web3.okx.com/build/docs/waas/dex-smart-contract</span>\n  <span class=\"token keyword\">const</span> currentAllowance <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">checkAllowance</span><span class=\"token punctuation\">(</span>tokenAddress<span class=\"token punctuation\">,</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> spenderAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentAllowance <span class=\"token operator\">&gt;=</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Sufficient allowance already exists'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Insufficient allowance, approving tokens...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Get approve transaction data from OKX DEX API</span>\n  <span class=\"token keyword\">const</span> approveData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getApproveTransaction</span><span class=\"token punctuation\">(</span>tokenAddress<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Get accurate gas limit using Onchain gateway API</span>\n  <span class=\"token keyword\">const</span> gasLimit <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getGasLimit</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> tokenAddress<span class=\"token punctuation\">,</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span> approveData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Get current gas price (can also use Onchain gateway API)</span>\n  <span class=\"token keyword\">const</span> gasPrice <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">getGasPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> adjustedGasPrice <span class=\"token operator\">=</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span>gasPrice<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1.5x for faster confirmation</span>\n\n  <span class=\"token comment\">// Get current nonce</span>\n  <span class=\"token keyword\">const</span> nonce <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">getTransactionCount</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'latest'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Create transaction object</span>\n  <span class=\"token keyword\">const</span> txObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    from<span class=\"token operator\">:</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span>\n    to<span class=\"token operator\">:</span> tokenAddress<span class=\"token punctuation\">,</span>\n    data<span class=\"token operator\">:</span> approveData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n    value<span class=\"token operator\">:</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n    gas<span class=\"token operator\">:</span> gasLimit<span class=\"token punctuation\">,</span>\n    gasPrice<span class=\"token operator\">:</span> adjustedGasPrice<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    nonce<span class=\"token operator\">:</span> nonce\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Sign transaction</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>signedTx<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span>accounts<span class=\"token punctuation\">.</span><span class=\"token function\">signTransaction</span><span class=\"token punctuation\">(</span>txObject<span class=\"token punctuation\">,</span> <span class=\"token constant\">PRIVATE_KEY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">sendSignedTransaction</span><span class=\"token punctuation\">(</span>signedTx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"4.请求询价接口，拿到询价数据\" id=\"4.请求询价接口，拿到询价数据\">4.请求询价接口，拿到询价数据<a class=\"index_header-anchor__Xqb+L\" href=\"#4.请求询价接口，拿到询价数据\" style=\"opacity: 0;\">#</a></h2>\n<p>4.1定义报价参数</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> quoteParams <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  amount<span class=\"token operator\">:</span> fromAmount<span class=\"token punctuation\">,</span>\n  chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n  toTokenAddress<span class=\"token operator\">:</span> toTokenAddress<span class=\"token punctuation\">,</span>\n  fromTokenAddress<span class=\"token operator\">:</span> fromTokenAddress<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>4.2 定义辅助函数</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token doc-comment comment\">/**\n * Get swap quote from DEX API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">fromTokenAddress</span> - Source token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">toTokenAddress</span> - Destination token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">amount</span> - Amount to swap\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">slippage</span> - Maximum slippage (e.g., \"0.5\" for 0.5%)\n * <span class=\"token keyword\">@returns</span> Swap quote\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSwapQuote</span><span class=\"token punctuation\">(</span>\n  fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  slippage<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/aggregator/quote'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>baseUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      fromTokenAddress<span class=\"token punctuation\">,</span>\n      toTokenAddress<span class=\"token punctuation\">,</span>\n      amount<span class=\"token punctuation\">,</span>\n      slippage\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to get swap quote:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"5.请求兑换接口，发起交易\" id=\"5.请求兑换接口，发起交易\">5.请求兑换接口，发起交易<a class=\"index_header-anchor__Xqb+L\" href=\"#5.请求兑换接口，发起交易\" style=\"opacity: 0;\">#</a></h2>\n<p>5.1 定义兑换参数</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> swapParams <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      fromTokenAddress<span class=\"token punctuation\">,</span>\n      toTokenAddress<span class=\"token punctuation\">,</span>\n      amount<span class=\"token punctuation\">,</span>\n      userWalletAddress<span class=\"token operator\">:</span> userAddress<span class=\"token punctuation\">,</span>\n      slippage\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>5.2 定义辅助函数</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token doc-comment comment\">/**\n * Get swap quote from DEX API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">fromTokenAddress</span> - Source token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">toTokenAddress</span> - Destination token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">amount</span> - Amount to swap\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">userAddress</span> - User wallet address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">slippage</span> - Maximum slippage (e.g., \"0.5\" for 0.5%)\n * <span class=\"token keyword\">@returns</span> Swap quote\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSwapQuote</span><span class=\"token punctuation\">(</span>\n  fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  userAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  slippage<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/aggregator/swap'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>baseUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      fromTokenAddress<span class=\"token punctuation\">,</span>\n      toTokenAddress<span class=\"token punctuation\">,</span>\n      amount<span class=\"token punctuation\">,</span>\n      userWalletAddress<span class=\"token operator\">:</span> userAddress<span class=\"token punctuation\">,</span>\n      slippage\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to get swap quote:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>5.3 请求兑换接口拿到 tx 信息</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token doc-comment comment\">/**\n * Execute token swap\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">fromTokenAddress</span> - Source token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">toTokenAddress</span> - Destination token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">amount</span> - Amount to swap\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">slippage</span> - Maximum slippage\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span>\n  fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  slippage<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 1. Check allowance and approve if necessary (skip for native token)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fromTokenAddress <span class=\"token operator\">!==</span> <span class=\"token constant\">ETH_ADDRESS</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">approveToken</span><span class=\"token punctuation\">(</span>fromTokenAddress<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 2. Get swap transaction data</span>\n  <span class=\"token keyword\">const</span> swapData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getSwapTransaction</span><span class=\"token punctuation\">(</span>fromTokenAddress<span class=\"token punctuation\">,</span> toTokenAddress<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> slippage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> txData <span class=\"token operator\">=</span> swapData<span class=\"token punctuation\">.</span>tx<span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Swap TX data received\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 3. Get accurate gas limit using Onchain gateway API</span>\n  <span class=\"token keyword\">const</span> gasLimit <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getGasLimit</span><span class=\"token punctuation\">(</span>\n    <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span>\n    txData<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">,</span>\n    txData<span class=\"token punctuation\">.</span>value <span class=\"token operator\">||</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n    txData<span class=\"token punctuation\">.</span>data\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Gas limit received\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 4. Get current nonce</span>\n  <span class=\"token keyword\">const</span> nonce <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">getTransactionCount</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'latest'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Nonce received\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 5. Get current gas price and adjust for faster confirmation</span>\n  <span class=\"token keyword\">const</span> gasPrice <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">getGasPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> adjustedGasPrice <span class=\"token operator\">=</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span>gasPrice<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1.5x for faster confirmation</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Gas price received\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 6. Create transaction object</span>\n  <span class=\"token keyword\">const</span> txObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    from<span class=\"token operator\">:</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span>\n    to<span class=\"token operator\">:</span> txData<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">,</span>\n    data<span class=\"token operator\">:</span> txData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n    value<span class=\"token operator\">:</span> txData<span class=\"token punctuation\">.</span>value <span class=\"token operator\">||</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n    gas<span class=\"token operator\">:</span> gasLimit<span class=\"token punctuation\">,</span>\n    gasPrice<span class=\"token operator\">:</span> adjustedGasPrice<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    nonce<span class=\"token operator\">:</span> nonce\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TX build complete\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 7. Sign transaction</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>signedTx<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span>accounts<span class=\"token punctuation\">.</span><span class=\"token function\">signTransaction</span><span class=\"token punctuation\">(</span>txObject<span class=\"token punctuation\">,</span> <span class=\"token constant\">PRIVATE_KEY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TX signed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> chainTxInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">sendSignedTransaction</span><span class=\"token punctuation\">(</span>signedTx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chainTxInfo:'</span><span class=\"token punctuation\">,</span> chainTxInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"6. 广播交易\" id=\"6.-广播交易\">6. 广播交易<a class=\"index_header-anchor__Xqb+L\" href=\"#6.-广播交易\" style=\"opacity: 0;\">#</a></h2>\n<p>6.1 用 <code>RPC</code> 广播交易</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> chainTxInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">sendSignedTransaction</span><span class=\"token punctuation\">(</span>signedTx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'chainTxInfo:'</span><span class=\"token punctuation\">,</span> chainTxInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>6.2 用<code>交易上链 API</code>广播交易</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/pre-transaction/broadcast-transaction'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> broadcastData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      signedTx<span class=\"token operator\">:</span> signedTx<span class=\"token punctuation\">.</span>rawTransaction<span class=\"token punctuation\">,</span>\n      chainIndex<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      address<span class=\"token operator\">:</span> <span class=\"token constant\">WALLET_ADDRESS</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication with body included in signature</span>\n    <span class=\"token keyword\">const</span> bodyString <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>broadcastData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> bodyString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> broadcastData<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> orderId <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orderId<span class=\"token punctuation\">;</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Swap transaction broadcast successfully, Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// 9. Monitor transaction status</span>\n      <span class=\"token keyword\">await</span> <span class=\"token function\">trackTransaction</span><span class=\"token punctuation\">(</span>orderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> orderId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to broadcast swap transaction:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"7. 追踪交易\" id=\"7.-追踪交易\">7. 追踪交易<a class=\"index_header-anchor__Xqb+L\" href=\"#7.-追踪交易\" style=\"opacity: 0;\">#</a></h2>\n<p>使用<code>交易上链 API</code></p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// Define error info interface</span>\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">TxErrorInfo</span> <span class=\"token punctuation\">{</span>\n  error<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  message<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  action<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Monitor transaction status\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">orderId</span> - Order ID from broadcast response\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">intervalMs</span> - Polling interval in milliseconds\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">timeoutMs</span> - Maximum time to wait\n * <span class=\"token keyword\">@returns</span> Final transaction status\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">trackTransaction</span><span class=\"token punctuation\">(</span>\n  orderId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  intervalMs<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">,</span>\n  timeoutMs<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">300000</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Monitoring transaction with Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> startTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> lastStatus <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime <span class=\"token operator\">&lt;</span> timeoutMs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Get transaction status</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/post-transaction/orders'</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        orderId<span class=\"token operator\">:</span> orderId<span class=\"token punctuation\">,</span>\n        chainIndex<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n        address<span class=\"token operator\">:</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span>\n        limit<span class=\"token operator\">:</span> <span class=\"token string\">'1'</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// Prepare authentication</span>\n      <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      \n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span> <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> txData <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n          \n          <span class=\"token comment\">// Use txStatus to match the API response</span>\n          <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>txStatus<span class=\"token punctuation\">;</span>\n\n          <span class=\"token comment\">// Only log when status changes</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!==</span> lastStatus<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            lastStatus <span class=\"token operator\">=</span> status<span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction pending: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txHash <span class=\"token operator\">||</span> <span class=\"token string\">'Hash not available yet'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'2'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction successful: https://web3.okx.com/explorer/base/tx/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txHash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">return</span> txData<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'3'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">const</span> failReason <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>failReason <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">const</span> errorMessage <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>failReason<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n              <span class=\"token keyword\">const</span> errorInfo <span class=\"token operator\">=</span> <span class=\"token function\">handleTransactionError</span><span class=\"token punctuation\">(</span>txData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Error type: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>errorInfo<span class=\"token punctuation\">.</span>error<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Suggested action: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>errorInfo<span class=\"token punctuation\">.</span>action<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n              <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">No orders found for Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error checking transaction status:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Wait before next check</span>\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span>resolve <span class=\"token operator\">=&gt;</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> intervalMs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Transaction monitoring timed out'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Comprehensive error handling with failReason\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">txData</span> - Transaction data from post-transaction/orders\n * <span class=\"token keyword\">@returns</span> Structured error information\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleTransactionError</span><span class=\"token punctuation\">(</span>txData<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> TxErrorInfo <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> failReason <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>failReason <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Log the detailed error</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed with reason: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>failReason<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Default error handling</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    error<span class=\"token operator\">:</span> <span class=\"token string\">'TRANSACTION_FAILED'</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> failReason<span class=\"token punctuation\">,</span>\n    action<span class=\"token operator\">:</span> <span class=\"token string\">'Try again or contact support'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>使用 <code>查询 Dex 交易状态 API</code></p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token doc-comment comment\">/**\n * Track transaction status using DEX API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">chainId</span> - Chain ID (e.g., 1 for Ethereum Mainnet)\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">txHash</span> - Transaction hash\n * <span class=\"token keyword\">@returns</span> Transaction details\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">trackTransactionStatus</span><span class=\"token punctuation\">(</span>chainId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> txHash<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/aggregator/history'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>baseUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      txHash<span class=\"token operator\">:</span> txHash<span class=\"token punctuation\">,</span>\n      isFromMyProject<span class=\"token operator\">:</span> <span class=\"token string\">'true'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> txData <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction is still pending: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txHash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">,</span> details<span class=\"token operator\">:</span> txData <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'success'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction successful!</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">From: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>fromTokenDetails<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> - Amount: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>fromTokenDetails<span class=\"token punctuation\">.</span>amount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">To: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>toTokenDetails<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> - Amount: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>toTokenDetails<span class=\"token punctuation\">.</span>amount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction Fee: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txFee<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Explorer URL: https://web3.okx.com/explorer/base/tx/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txHash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">'success'</span><span class=\"token punctuation\">,</span> details<span class=\"token operator\">:</span> txData <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'failure'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>errorMsg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">'failure'</span><span class=\"token punctuation\">,</span> details<span class=\"token operator\">:</span> txData <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      \n      <span class=\"token keyword\">return</span> txData<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to track transaction status:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p><p>交易上链 API 监控使用 /dex/post-transaction/orders 跟踪内部订单处理状态。它有助于监控交易在 OKX 系统中的移动情况，并提供订单 ID 和 基本状态（1：待处理，2：成功，3：失败）。<br/>\nSwap API 交易跟踪使用 /dex/aggregator/history  提供全面的兑换执行详情。它提供特定于代币的信息（代码、金额）、已支付的费用以及详细的区块链数据。如果您需要完整的兑换验证并提供代币级详细信息，请使用此选项。\n选择前者用于基本交易状态更新，而选择后者用于获取兑换执行本身的详细信息。</p></p>\n<h2 data-content=\"8. 完整实现\" id=\"8.-完整实现\">8. 完整实现<a class=\"index_header-anchor__Xqb+L\" href=\"#8.-完整实现\" style=\"opacity: 0;\">#</a></h2>\n<p>这是一个完整的实现示例：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// Token Swap using OKX Onchain gateway API on Base</span>\n<span class=\"token comment\">// Required packages</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Web3 <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'web3'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> axios <span class=\"token keyword\">from</span> <span class=\"token string\">'axios'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">as</span> dotenv <span class=\"token keyword\">from</span> <span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> CryptoJS <span class=\"token keyword\">from</span> <span class=\"token string\">'crypto-js'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Load environment variables</span>\ndotenv<span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Connect to Base network</span>\n<span class=\"token keyword\">const</span> web3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Web3</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://mainnet.base.org'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Your wallet information - REPLACE WITH YOUR OWN VALUES</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EVM_WALLET_ADDRESS</span> <span class=\"token operator\">||</span> <span class=\"token string\">'0xYourWalletAddress'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PRIVATE_KEY</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EVM_PRIVATE_KEY</span> <span class=\"token operator\">||</span> <span class=\"token string\">'YourPrivateKey'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Without 0x prefix</span>\n\n<span class=\"token comment\">// Token addresses for swap on Base</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">ETH_ADDRESS</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Native ETH</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">USDC_ADDRESS</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Base USDC</span>\n\n<span class=\"token comment\">// Chain ID for Base</span>\n<span class=\"token keyword\">const</span> chainId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'8453'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// API URL</span>\n<span class=\"token comment\">// const baseUrl: string = 'https://web3.okx.com/api/v5/';</span>\n<span class=\"token keyword\">const</span> baseUrl<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'https://beta.okex.org/api/v5/'</span>\n\n<span class=\"token comment\">// Amount to swap in smallest unit (approx $1 of ETH)</span>\n<span class=\"token comment\">// 1 ETH = 10^18 wei, so 0.0005 ETH = 5 * 10^14 wei at ~$2000/ETH</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SWAP_AMOUNT</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'500000000000000'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 0.0005 ETH (approx $1)</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SLIPPAGE</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 0.5% slippage tolerance</span>\n\n<span class=\"token comment\">// Define type for error handling</span>\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">TxErrorInfo</span> <span class=\"token punctuation\">{</span>\n  error<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  message<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  action<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ===== Get Header Function =====</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> method<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> apiKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_KEY</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> secretKey <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_SECRET_KEY</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> apiPassphrase <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_PASSPHRASE</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> projectId <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_PROJECT_ID</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>apiKey <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>secretKey <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>apiPassphrase <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>projectId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Missing required environment variables\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">const</span> stringToSign <span class=\"token operator\">=</span> timestamp <span class=\"token operator\">+</span> method <span class=\"token operator\">+</span> requestPath <span class=\"token operator\">+</span> queryString<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string-property property\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-KEY\"</span><span class=\"token operator\">:</span> apiKey<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-SIGN\"</span><span class=\"token operator\">:</span> CryptoJS<span class=\"token punctuation\">.</span>enc<span class=\"token punctuation\">.</span>Base64<span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>\n            CryptoJS<span class=\"token punctuation\">.</span><span class=\"token function\">HmacSHA256</span><span class=\"token punctuation\">(</span>stringToSign<span class=\"token punctuation\">,</span> secretKey<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-TIMESTAMP\"</span><span class=\"token operator\">:</span> timestamp<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-PASSPHRASE\"</span><span class=\"token operator\">:</span> apiPassphrase<span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"OK-ACCESS-PROJECT\"</span><span class=\"token operator\">:</span> projectId<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ===== Token Approval Functions =====</span>\n\n<span class=\"token doc-comment comment\">/**\n * Check token allowance for DEX\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">tokenAddress</span> - Token contract address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">ownerAddress</span> - Your wallet address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">spenderAddress</span> - DEX spender address\n * <span class=\"token keyword\">@returns</span> Allowance amount\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">checkAllowance</span><span class=\"token punctuation\">(</span>\n  tokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  ownerAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  spenderAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>bigint<span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> tokenABI <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token string-property property\">\"constant\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"inputs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"_owner\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"address\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"_spender\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"address\"</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"allowance\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"outputs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"uint256\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"payable\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"stateMutability\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"view\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token string-property property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"function\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> tokenContract <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">web3</span><span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">Contract</span><span class=\"token punctuation\">(</span>tokenABI<span class=\"token punctuation\">,</span> tokenAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> allowance <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> tokenContract<span class=\"token punctuation\">.</span>methods<span class=\"token punctuation\">.</span><span class=\"token function\">allowance</span><span class=\"token punctuation\">(</span>ownerAddress<span class=\"token punctuation\">,</span> spenderAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>allowance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to query allowance:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Get approve transaction data from OKX DEX API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">tokenAddress</span> - Token contract address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">amount</span> - Amount to approve\n * <span class=\"token keyword\">@returns</span> Approval transaction data\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getApproveTransaction</span><span class=\"token punctuation\">(</span>\n  tokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/aggregator/approve-transaction'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>baseUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      tokenContractAddress<span class=\"token operator\">:</span> tokenAddress<span class=\"token punctuation\">,</span>\n      approveAmount<span class=\"token operator\">:</span> amount\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to get approval transaction data:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Get transaction gas limit from Onchain gateway API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">fromAddress</span> - Sender address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">toAddress</span> - Target contract address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">txAmount</span> - Transaction amount (0 for approvals)\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">inputData</span> - Transaction calldata\n * <span class=\"token keyword\">@returns</span> Estimated gas limit\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getGasLimit</span><span class=\"token punctuation\">(</span>\n  fromAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  toAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  txAmount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n  inputData<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/pre-transaction/gas-limit'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>path<span class=\"token operator\">:</span> path<span class=\"token punctuation\">,</span> url<span class=\"token operator\">:</span>url<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainIndex<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      fromAddress<span class=\"token operator\">:</span> fromAddress<span class=\"token punctuation\">,</span>\n      toAddress<span class=\"token operator\">:</span> toAddress<span class=\"token punctuation\">,</span>\n      txAmount<span class=\"token operator\">:</span> txAmount<span class=\"token punctuation\">,</span>\n      extJson<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        inputData<span class=\"token operator\">:</span> inputData\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication with body included in signature</span>\n    <span class=\"token keyword\">const</span> bodyString <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> bodyString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> body<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>gasLimit<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to get gas limit:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Sign and send approve transaction\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">tokenAddress</span> - Token to approve\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">amount</span> - Amount to approve\n * <span class=\"token keyword\">@returns</span> Order ID of the approval transaction\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">approveToken</span><span class=\"token punctuation\">(</span>tokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> spenderAddress <span class=\"token operator\">=</span> <span class=\"token string\">'0x6b2C0c7be2048Daa9b5527982C29f48062B34D58'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Base DEX spender</span>\n  <span class=\"token keyword\">const</span> currentAllowance <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">checkAllowance</span><span class=\"token punctuation\">(</span>tokenAddress<span class=\"token punctuation\">,</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> spenderAddress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentAllowance <span class=\"token operator\">&gt;=</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Sufficient allowance already exists'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Insufficient allowance, approving tokens...'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Get approve transaction data from OKX DEX API</span>\n  <span class=\"token keyword\">const</span> approveData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getApproveTransaction</span><span class=\"token punctuation\">(</span>tokenAddress<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Get accurate gas limit using Onchain gateway API</span>\n  <span class=\"token keyword\">const</span> gasLimit <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getGasLimit</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> tokenAddress<span class=\"token punctuation\">,</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span> approveData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Get current gas price (can also use Onchain gateway API)</span>\n  <span class=\"token keyword\">const</span> gasPrice <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">getGasPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> adjustedGasPrice <span class=\"token operator\">=</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span>gasPrice<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1.5x for faster confirmation</span>\n\n  <span class=\"token comment\">// Get current nonce</span>\n  <span class=\"token keyword\">const</span> nonce <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">getTransactionCount</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'latest'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Create transaction object</span>\n  <span class=\"token keyword\">const</span> txObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    from<span class=\"token operator\">:</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span>\n    to<span class=\"token operator\">:</span> tokenAddress<span class=\"token punctuation\">,</span>\n    data<span class=\"token operator\">:</span> approveData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n    value<span class=\"token operator\">:</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n    gas<span class=\"token operator\">:</span> gasLimit<span class=\"token punctuation\">,</span>\n    gasPrice<span class=\"token operator\">:</span> adjustedGasPrice<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    nonce<span class=\"token operator\">:</span> nonce\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Sign transaction</span>\n  <span class=\"token keyword\">const</span> signedTx <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span>accounts<span class=\"token punctuation\">.</span><span class=\"token function\">signTransaction</span><span class=\"token punctuation\">(</span>txObject<span class=\"token punctuation\">,</span> <span class=\"token constant\">PRIVATE_KEY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Broadcast transaction using Onchain gateway API</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/pre-transaction/broadcast-transaction'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>baseUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> broadcastData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      signedTx<span class=\"token operator\">:</span> signedTx<span class=\"token punctuation\">.</span>rawTransaction<span class=\"token punctuation\">,</span>\n      chainIndex<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      address<span class=\"token operator\">:</span> <span class=\"token constant\">WALLET_ADDRESS</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication with body included in signature</span>\n    <span class=\"token keyword\">const</span> bodyString <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>broadcastData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> bodyString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> broadcastData<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> orderId <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orderId<span class=\"token punctuation\">;</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Approval transaction broadcast successfully, Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// Monitor transaction status</span>\n      <span class=\"token keyword\">await</span> <span class=\"token function\">trackTransaction</span><span class=\"token punctuation\">(</span>orderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> orderId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to broadcast approval transaction:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ===== Swap Functions =====</span>\n\n<span class=\"token doc-comment comment\">/**\n * Get swap quote from DEX API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">fromTokenAddress</span> - Source token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">toTokenAddress</span> - Destination token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">amount</span> - Amount to swap\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">userAddress</span> - User wallet address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">slippage</span> - Maximum slippage (e.g., \"0.5\" for 0.5%)\n * <span class=\"token keyword\">@returns</span> Swap quote\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSwapQuote</span><span class=\"token punctuation\">(</span>\n  fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  userAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  slippage<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/aggregator/swap'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>baseUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      fromTokenAddress<span class=\"token punctuation\">,</span>\n      toTokenAddress<span class=\"token punctuation\">,</span>\n      amount<span class=\"token punctuation\">,</span>\n      userWalletAddress<span class=\"token operator\">:</span> userAddress<span class=\"token punctuation\">,</span>\n      slippage\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to get swap quote:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Get swap transaction data from DEX API\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">fromTokenAddress</span> - Source token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">toTokenAddress</span> - Destination token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">amount</span> - Amount to swap\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">userAddress</span> - User wallet address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">slippage</span> - Maximum slippage\n * <span class=\"token keyword\">@returns</span> Swap transaction data\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getSwapTransaction</span><span class=\"token punctuation\">(</span>\n  fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  userAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  slippage<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/aggregator/swap'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>baseUrl<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      fromTokenAddress<span class=\"token punctuation\">,</span>\n      toTokenAddress<span class=\"token punctuation\">,</span>\n      amount<span class=\"token punctuation\">,</span>\n      userWalletAddress<span class=\"token operator\">:</span> userAddress<span class=\"token punctuation\">,</span>\n      slippage\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to get swap transaction data:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Execute token swap\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">fromTokenAddress</span> - Source token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">toTokenAddress</span> - Destination token address\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">amount</span> - Amount to swap\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">slippage</span> - Maximum slippage\n * <span class=\"token keyword\">@returns</span> Order ID of the swap transaction\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span>\n  fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  toTokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  slippage<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'0.5'</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 1. Check allowance and approve if necessary (skip for native token)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fromTokenAddress <span class=\"token operator\">!==</span> <span class=\"token constant\">ETH_ADDRESS</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">approveToken</span><span class=\"token punctuation\">(</span>fromTokenAddress<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 2. Get swap transaction data</span>\n  <span class=\"token keyword\">const</span> swapData <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getSwapTransaction</span><span class=\"token punctuation\">(</span>fromTokenAddress<span class=\"token punctuation\">,</span> toTokenAddress<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">,</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> slippage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> txData <span class=\"token operator\">=</span> swapData<span class=\"token punctuation\">.</span>tx<span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Swap TX data received\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 3. Get accurate gas limit using Onchain gateway API</span>\n  <span class=\"token keyword\">const</span> gasLimit <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getGasLimit</span><span class=\"token punctuation\">(</span>\n    <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span>\n    txData<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">,</span>\n    txData<span class=\"token punctuation\">.</span>value <span class=\"token operator\">||</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n    txData<span class=\"token punctuation\">.</span>data\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Gas limit received\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 4. Get current nonce</span>\n  <span class=\"token keyword\">const</span> nonce <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">getTransactionCount</span><span class=\"token punctuation\">(</span><span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'latest'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Nonce received\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 5. Get current gas price and adjust for faster confirmation</span>\n  <span class=\"token keyword\">const</span> gasPrice <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span><span class=\"token function\">getGasPrice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> adjustedGasPrice <span class=\"token operator\">=</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span>gasPrice<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">15</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token function\">BigInt</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1.5x for faster confirmation</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Gas price received\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 6. Create transaction object</span>\n  <span class=\"token keyword\">const</span> txObject <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    from<span class=\"token operator\">:</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span>\n    to<span class=\"token operator\">:</span> txData<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">,</span>\n    data<span class=\"token operator\">:</span> txData<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\n    value<span class=\"token operator\">:</span> txData<span class=\"token punctuation\">.</span>value <span class=\"token operator\">||</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n    gas<span class=\"token operator\">:</span> gasLimit<span class=\"token punctuation\">,</span>\n    gasPrice<span class=\"token operator\">:</span> adjustedGasPrice<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    nonce<span class=\"token operator\">:</span> nonce\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TX build complete\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 7. Sign transaction</span>\n  <span class=\"token keyword\">const</span> signedTx <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> web3<span class=\"token punctuation\">.</span>eth<span class=\"token punctuation\">.</span>accounts<span class=\"token punctuation\">.</span><span class=\"token function\">signTransaction</span><span class=\"token punctuation\">(</span>txObject<span class=\"token punctuation\">,</span> <span class=\"token constant\">PRIVATE_KEY</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TX signed\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 8. Broadcast transaction using Onchain gateway API</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/pre-transaction/broadcast-transaction'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> broadcastData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      signedTx<span class=\"token operator\">:</span> signedTx<span class=\"token punctuation\">.</span>rawTransaction<span class=\"token punctuation\">,</span>\n      chainIndex<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n      address<span class=\"token operator\">:</span> <span class=\"token constant\">WALLET_ADDRESS</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Prepare authentication with body included in signature</span>\n    <span class=\"token keyword\">const</span> bodyString <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>broadcastData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> bodyString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> broadcastData<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> orderId <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orderId<span class=\"token punctuation\">;</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Swap transaction broadcast successfully, Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// 9. Monitor transaction status</span>\n      <span class=\"token keyword\">await</span> <span class=\"token function\">trackTransaction</span><span class=\"token punctuation\">(</span>orderId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> orderId<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">API Error: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>msg <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown error'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to broadcast swap transaction:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ===== Transaction Monitoring =====</span>\n\n<span class=\"token doc-comment comment\">/**\n * Monitor transaction status\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">orderId</span> - Order ID from broadcast response\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">intervalMs</span> - Polling interval in milliseconds\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">timeoutMs</span> - Maximum time to wait\n * <span class=\"token keyword\">@returns</span> Final transaction status\n */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">trackTransaction</span><span class=\"token punctuation\">(</span>\n  orderId<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n  intervalMs<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">5000</span><span class=\"token punctuation\">,</span>\n  timeoutMs<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">300000</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Monitoring transaction with Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> startTime <span class=\"token operator\">=</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> lastStatus <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime <span class=\"token operator\">&lt;</span> timeoutMs<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Get transaction status</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/post-transaction/orders'</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        orderId<span class=\"token operator\">:</span> orderId<span class=\"token punctuation\">,</span>\n        chainIndex<span class=\"token operator\">:</span> chainId<span class=\"token punctuation\">,</span>\n        address<span class=\"token operator\">:</span> <span class=\"token constant\">WALLET_ADDRESS</span><span class=\"token punctuation\">,</span>\n        limit<span class=\"token operator\">:</span> <span class=\"token string\">'1'</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// Prepare authentication</span>\n      <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      \n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span> <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> txData <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>orders<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n          \n          <span class=\"token comment\">// Use txStatus to match the API response</span>\n          <span class=\"token keyword\">const</span> status <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>txStatus<span class=\"token punctuation\">;</span>\n\n          <span class=\"token comment\">// Only log when status changes</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">!==</span> lastStatus<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            lastStatus <span class=\"token operator\">=</span> status<span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'1'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction pending: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txHash <span class=\"token operator\">||</span> <span class=\"token string\">'Hash not available yet'</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'2'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction successful: https://web3.okx.com/explorer/base/tx/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txData<span class=\"token punctuation\">.</span>txHash<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">return</span> txData<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'3'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">const</span> failReason <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>failReason <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">const</span> errorMessage <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>failReason<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n              <span class=\"token keyword\">const</span> errorInfo <span class=\"token operator\">=</span> <span class=\"token function\">handleTransactionError</span><span class=\"token punctuation\">(</span>txData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Error type: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>errorInfo<span class=\"token punctuation\">.</span>error<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Suggested action: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>errorInfo<span class=\"token punctuation\">.</span>action<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n              <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>errorMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">No orders found for Order ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>orderId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error checking transaction status:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Wait before next check</span>\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span>resolve <span class=\"token operator\">=&gt;</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> intervalMs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Transaction monitoring timed out'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token doc-comment comment\">/**\n * Comprehensive error handling with failReason\n * <span class=\"token keyword\">@param</span> <span class=\"token parameter\">txData</span> - Transaction data from post-transaction/orders\n * <span class=\"token keyword\">@returns</span> Structured error information\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleTransactionError</span><span class=\"token punctuation\">(</span>txData<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> TxErrorInfo <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> failReason <span class=\"token operator\">=</span> txData<span class=\"token punctuation\">.</span>failReason <span class=\"token operator\">||</span> <span class=\"token string\">'Unknown reason'</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Log the detailed error</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Transaction failed with reason: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>failReason<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Default error handling</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    error<span class=\"token operator\">:</span> <span class=\"token string\">'TRANSACTION_FAILED'</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token operator\">:</span> failReason<span class=\"token punctuation\">,</span>\n    action<span class=\"token operator\">:</span> <span class=\"token string\">'Try again or contact support'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ===== Main Function =====</span>\n\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Main function to execute ETH to USDC swap on Base</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Starting ETH to USDC swap on Base using Onchain gateway API'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Execute swap from ETH to USDC on Base</span>\n    <span class=\"token keyword\">const</span> orderId <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span>\n      <span class=\"token constant\">ETH_ADDRESS</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\">// From ETH on Base</span>\n      <span class=\"token constant\">USDC_ADDRESS</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\">// To USDC on Base</span>\n      <span class=\"token constant\">SWAP_AMOUNT</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\">// Amount in ETH's smallest unit (0.0005 ETH ≈ $1)</span>\n      <span class=\"token constant\">SLIPPAGE</span>        <span class=\"token comment\">// 0.5% slippage</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Get final transaction details</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token string\">'dex/post-transaction/orders'</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        orderId<span class=\"token operator\">:</span> orderId<span class=\"token punctuation\">,</span>\n        chainIndex<span class=\"token operator\">:</span> chainId\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// Prepare authentication</span>\n      <span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">/api/v5/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> params<span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'0'</span> <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data <span class=\"token operator\">&amp;&amp;</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Transaction Hash:'</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>txHash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Failed to get final transaction details:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Swap failed:'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">as</span> Error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Execute the main function</span>\n<span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"方法2：SDK方法\" id=\"方法2：sdk方法\">方法2：SDK方法<a class=\"index_header-anchor__Xqb+L\" href=\"#方法2：sdk方法\" style=\"opacity: 0;\">#</a></h2>\n<p>使用OKX DEX SDK提供了更简单的开发人员体验，同时保留了API方法的所有功能。SDK为您处理许多实现细节，包括重试逻辑、错误处理和交易管理。</p>\n<h2 data-content=\"1.安装SDK\" id=\"1.安装sdk\">1.安装SDK<a class=\"index_header-anchor__Xqb+L\" href=\"#1.安装sdk\" style=\"opacity: 0;\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> @okx-dex/okx-dex-sdk\n<span class=\"token comment\"># or</span>\n<span class=\"token function\">yarn</span> <span class=\"token function\">add</span> @okx-dex/okx-dex-sdk\n<span class=\"token comment\"># or</span>\n<span class=\"token function\">pnpm</span> <span class=\"token function\">add</span> @okx-dex/okx-dex-sdk\n</code></pre></div>\n<h2 data-content=\"2.设置环境\" id=\"2.设置环境\">2.设置环境<a class=\"index_header-anchor__Xqb+L\" href=\"#2.设置环境\" style=\"opacity: 0;\">#</a></h2>\n<p>使用您的API凭据和钱包信息创建一个. env文件：</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># OKX API Credentials</span>\n<span class=\"token assign-left variable\">OKX_API_KEY</span><span class=\"token operator\">=</span>your_api_key\n<span class=\"token assign-left variable\">OKX_SECRET_KEY</span><span class=\"token operator\">=</span>your_secret_key\n<span class=\"token assign-left variable\">OKX_API_PASSPHRASE</span><span class=\"token operator\">=</span>your_passphrase\n<span class=\"token assign-left variable\">OKX_PROJECT_ID</span><span class=\"token operator\">=</span>your_project_id\n<span class=\"token comment\"># EVM Configuration</span>\n<span class=\"token assign-left variable\">EVM_RPC_URL</span><span class=\"token operator\">=</span>your_evm_rpc_url\n<span class=\"token assign-left variable\">EVM_WALLET_ADDRESS</span><span class=\"token operator\">=</span>your_evm_wallet_address\n<span class=\"token assign-left variable\">EVM_PRIVATE_KEY</span><span class=\"token operator\">=</span>your_evm_private_key\n</code></pre></div>\n<h2 data-content=\"3.初始化客户端\" id=\"3.初始化客户端\">3.初始化客户端<a class=\"index_header-anchor__Xqb+L\" href=\"#3.初始化客户端\" style=\"opacity: 0;\">#</a></h2>\n<p>为您的DEX客户端创建一个文件（例如，DexClient. ts）：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// DexClient.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> OKXDexClient <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@okx-dex/okx-dex-sdk'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">'dotenv/config'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Validate environment variables</span>\n<span class=\"token keyword\">const</span> requiredEnvVars <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'OKX_API_KEY'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'OKX_SECRET_KEY'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'OKX_API_PASSPHRASE'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'OKX_PROJECT_ID'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'EVM_WALLET_ADDRESS'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'EVM_PRIVATE_KEY'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'EVM_RPC_URL'</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> envVar <span class=\"token keyword\">of</span> requiredEnvVars<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">[</span>envVar<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Missing required environment variable: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>envVar<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Initialize the client</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> client <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OKXDexClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    apiKey<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_KEY</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    secretKey<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_SECRET_KEY</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    apiPassphrase<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_API_PASSPHRASE</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    projectId<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">OKX_PROJECT_ID</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    evm<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        connection<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            rpcUrl<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EVM_RPC_URL</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        walletAddress<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EVM_WALLET_ADDRESS</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n        privateKey<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EVM_PRIVATE_KEY</span><span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"4.调用SDK执行代币授权\" id=\"4.调用sdk执行代币授权\">4.调用SDK执行代币授权<a class=\"index_header-anchor__Xqb+L\" href=\"#4.调用sdk执行代币授权\" style=\"opacity: 0;\">#</a></h2>\n<p>创建代币授权工具的功能：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// approval.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> client <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./DexClient'</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Helper function to convert human-readable amounts to base units</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">toBaseUnits</span><span class=\"token punctuation\">(</span>amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> decimals<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Remove any decimal point and count the decimal places</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>integerPart<span class=\"token punctuation\">,</span> decimalPart <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> amount<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> currentDecimals <span class=\"token operator\">=</span> decimalPart<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Combine integer and decimal parts, removing the decimal point</span>\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> integerPart <span class=\"token operator\">+</span> decimalPart<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Add zeros if we need more decimal places</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentDecimals <span class=\"token operator\">&lt;</span> decimals<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        result <span class=\"token operator\">=</span> result <span class=\"token operator\">+</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">.</span><span class=\"token function\">repeat</span><span class=\"token punctuation\">(</span>decimals <span class=\"token operator\">-</span> currentDecimals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// Remove digits if we have too many decimal places</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentDecimals <span class=\"token operator\">&gt;</span> decimals<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        result <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>currentDecimals <span class=\"token operator\">-</span> decimals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Remove leading zeros</span>\n    result <span class=\"token operator\">=</span> result<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\"><span class=\"token anchor function\">^</span>0<span class=\"token quantifier number\">+</span></span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Example: Approve a token for swapping</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">executeApproval</span><span class=\"token punctuation\">(</span>tokenAddress<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> amount<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Get token information using quote</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Getting token information...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> tokenInfo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>dex<span class=\"token punctuation\">.</span><span class=\"token function\">getQuote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            chainId<span class=\"token operator\">:</span> <span class=\"token string\">'8453'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Base Chain</span>\n            fromTokenAddress<span class=\"token operator\">:</span> tokenAddress<span class=\"token punctuation\">,</span>\n            toTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Native token</span>\n            amount<span class=\"token operator\">:</span> <span class=\"token string\">'1000000'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Use a reasonable amount for quote</span>\n            slippage<span class=\"token operator\">:</span> <span class=\"token string\">'0.5'</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> tokenDecimals <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>tokenInfo<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>decimal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> rawAmount <span class=\"token operator\">=</span> <span class=\"token function\">toBaseUnits</span><span class=\"token punctuation\">(</span>amount<span class=\"token punctuation\">,</span> tokenDecimals<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\\nApproval Details:</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">--------------------</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Token: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>tokenSymbol<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Amount: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>amount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>fromToken<span class=\"token punctuation\">.</span>tokenSymbol<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Amount in base units: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rawAmount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// Execute the approval</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nExecuting approval...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>dex<span class=\"token punctuation\">.</span><span class=\"token function\">executeApproval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            chainId<span class=\"token operator\">:</span> <span class=\"token string\">'8453'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Base Chain</span>\n            tokenContractAddress<span class=\"token operator\">:</span> tokenAddress<span class=\"token punctuation\">,</span>\n            approveAmount<span class=\"token operator\">:</span> rawAmount\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'alreadyApproved'</span> <span class=\"token keyword\">in</span> result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nToken already approved for the requested amount!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> success<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> alreadyApproved<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nApproval completed successfully!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Transaction Hash:\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>transactionHash<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Explorer URL:\"</span><span class=\"token punctuation\">,</span> result<span class=\"token punctuation\">.</span>explorerUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error executing approval:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Run if this file is executed directly</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">require</span><span class=\"token punctuation\">.</span>main <span class=\"token operator\">===</span> module<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Example usage: ts-node approval.ts 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 1000</span>\n    <span class=\"token keyword\">const</span> args <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!==</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Usage: ts-node approval.ts &lt;tokenAddress&gt; &lt;amountToApprove&gt;\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nExamples:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"  # Approve 1000 USDC\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">  ts-node approval.ts 0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913 1000</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>tokenAddress<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">executeApproval</span><span class=\"token punctuation\">(</span>tokenAddress<span class=\"token punctuation\">,</span> amount<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> executeApproval <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"5.调用SDK执行兑换\" id=\"5.调用sdk执行兑换\">5.调用SDK执行兑换<a class=\"index_header-anchor__Xqb+L\" href=\"#5.调用sdk执行兑换\" style=\"opacity: 0;\">#</a></h2>\n<p>创建兑换执行的文件：</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// swap.ts</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> client <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./DexClient'</span><span class=\"token punctuation\">;</span>\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Example: Execute a swap from ETH to USDC on Base chain</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EVM_PRIVATE_KEY</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Missing EVM_PRIVATE_KEY in .env file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// You can change this to any EVM chain</span>\n    <span class=\"token comment\">// For example, for Base, use chainId: '8453'</span>\n    <span class=\"token comment\">// For example, for baseSepolia, use chainId: '84532'</span>\n    <span class=\"token comment\">// You can also use SUI, use chainId: '784'</span>\n    <span class=\"token comment\">// When using another Chain, you need to change the fromTokenAddress and toTokenAddress to the correct addresses for that chain</span>\n\n    <span class=\"token keyword\">const</span> swapResult <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>dex<span class=\"token punctuation\">.</span><span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      chainId<span class=\"token operator\">:</span> <span class=\"token string\">'8453'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Base chain ID</span>\n      fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Native ETH</span>\n      toTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// USDC on Base</span>\n      amount<span class=\"token operator\">:</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span> <span class=\"token operator\">*</span> <span class=\"token number\">10</span> <span class=\"token operator\">**</span> <span class=\"token number\">14</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// .0001 ETH</span>\n      slippage<span class=\"token operator\">:</span> <span class=\"token string\">'0.5'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 0.5% slippage</span>\n      userWalletAddress<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">EVM_WALLET_ADDRESS</span><span class=\"token operator\">!</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Swap executed successfully:'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>swapResult<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> swapResult<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error executing swap:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// API errors include details in the message</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'API Error:'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> match <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">API Error: <span class=\"token group punctuation\">(</span><span class=\"token char-set class-name\">.</span><span class=\"token quantifier number\">*</span><span class=\"token group punctuation\">)</span></span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>match<span class=\"token punctuation\">)</span> <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'API Error Details:'</span><span class=\"token punctuation\">,</span> match<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Run if this file is executed directly</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">require</span><span class=\"token punctuation\">.</span>main <span class=\"token operator\">===</span> module<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> executeSwap <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"6.附加的SDK功能\" id=\"6.附加的sdk功能\">6.附加的SDK功能<a class=\"index_header-anchor__Xqb+L\" href=\"#6.附加的sdk功能\" style=\"opacity: 0;\">#</a></h2>\n<p>SDK提供了简化开发的附加方法：\n获取代币对的报价</p>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> quote <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> client<span class=\"token punctuation\">.</span>dex<span class=\"token punctuation\">.</span><span class=\"token function\">getQuote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    chainId<span class=\"token operator\">:</span> <span class=\"token string\">'8453'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Base Chain</span>\n    fromTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// USDC</span>\n    toTokenAddress<span class=\"token operator\">:</span> <span class=\"token string\">'0x4200000000000000000000000000000000000006'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// WETH</span>\n    amount<span class=\"token operator\">:</span> <span class=\"token string\">'1000000'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 1 USDC (in smallest units)</span>\n    slippage<span class=\"token operator\">:</span> <span class=\"token string\">'0.5'</span>     <span class=\"token comment\">// 0.5%</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div></div>",
  "url": "https://web3.okx.com/zh-hans/build/dev-docs/dex-api/dex-use-swap-quick-start#3.检查授权交易参数并发起授权",
  "navigation": {
    "breadcrumbs": [
      "DEX API",
      "交易 API",
      "搭建兑换应用",
      "在 EVM 链上搭建兑换应用"
    ],
    "sidebar_links": [
      "搭建兑换应用",
      "在 Solana 链上搭建兑换应用",
      "在 Solana 链上兑换的高级用法",
      "在 EVM 链上搭建兑换应用",
      "在 Sui 链上搭建兑换应用",
      "在 Ton 链上搭建兑换应用",
      "搭建跨链应用",
      "介绍",
      "API 参考",
      "设置分佣",
      "DEX 集成",
      "智能合约",
      "错误码",
      "FAQ",
      "介绍",
      "API 参考",
      "支持的跨链桥",
      "智能合约",
      "错误码",
      "FAQ"
    ],
    "toc": [
      "方法1：API方法",
      "1.设置环境",
      "2.检查授权额度",
      "3.检查授权交易参数并发起授权",
      "4.请求询价接口，拿到询价数据",
      "5.请求兑换接口，发起交易",
      "6. 广播交易",
      "7. 追踪交易",
      "8. 完整实现",
      "方法2：SDK方法",
      "1.安装SDK",
      "2.设置环境",
      "3.初始化客户端",
      "4.调用SDK执行代币授权",
      "5.调用SDK执行兑换",
      "6.附加的SDK功能"
    ]
  },
  "word_count": 8574,
  "extract_time": "2025-05-27 01:26:35"
}