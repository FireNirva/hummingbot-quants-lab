{
  "title": "Solana 示例 | DEX SDK  | 资源 | DEX API | DEX API 文档 | 欧易",
  "text": "Solana 示例\n#\n创建兑换指令\n#\n// swap.ts\nimport\n{\nclient\n}\nfrom\n'./DexClient'\n;\n/**\n* Example: Execute a swap from SOL to USDC\n*/\nasync\nfunction\nexecuteSwap\n(\n)\n{\ntry\n{\nif\n(\n!\nprocess\n.\nenv\n.\nSOLANA_PRIVATE_KEY\n)\n{\nthrow\nnew\nError\n(\n'Missing SOLANA_PRIVATE_KEY in .env file'\n)\n;\n}\n// Get quote to fetch token information\nconsole\n.\nlog\n(\n\"Getting token information...\"\n)\n;\nconst\nquote\n=\nawait\nclient\n.\ndex\n.\ngetQuote\n(\n{\nchainId\n:\n'501'\n,\nfromTokenAddress\n:\n'11111111111111111111111111111111'\n,\n// SOL\ntoTokenAddress\n:\n'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'\n,\n// USDC\namount\n:\n'1000000'\n,\n// Small amount for quote\nslippage\n:\n'0.5'\n}\n)\n;\nconst\ntokenInfo\n=\n{\nfromToken\n:\n{\nsymbol\n:\nquote\n.\ndata\n[\n0\n]\n.\nfromToken\n.\ntokenSymbol\n,\ndecimals\n:\nparseInt\n(\nquote\n.\ndata\n[\n0\n]\n.\nfromToken\n.\ndecimal\n)\n,\nprice\n:\nquote\n.\ndata\n[\n0\n]\n.\nfromToken\n.\ntokenUnitPrice\n}\n,\ntoToken\n:\n{\nsymbol\n:\nquote\n.\ndata\n[\n0\n]\n.\ntoToken\n.\ntokenSymbol\n,\ndecimals\n:\nparseInt\n(\nquote\n.\ndata\n[\n0\n]\n.\ntoToken\n.\ndecimal\n)\n,\nprice\n:\nquote\n.\ndata\n[\n0\n]\n.\ntoToken\n.\ntokenUnitPrice\n}\n}\n;\n// Convert amount to base units (for display purposes)\nconst\nhumanReadableAmount\n=\n0.1\n;\n// 0.1 SOL\nconst\nrawAmount\n=\n(\nhumanReadableAmount\n*\nMath\n.\npow\n(\n10\n,\ntokenInfo\n.\nfromToken\n.\ndecimals\n)\n)\n.\ntoString\n(\n)\n;\nconsole\n.\nlog\n(\n\"\\nSwap Details:\"\n)\n;\nconsole\n.\nlog\n(\n\"--------------------\"\n)\n;\nconsole\n.\nlog\n(\n`\nFrom:\n${\ntokenInfo\n.\nfromToken\n.\nsymbol\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nTo:\n${\ntokenInfo\n.\ntoToken\n.\nsymbol\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nAmount:\n${\nhumanReadableAmount\n}\n${\ntokenInfo\n.\nfromToken\n.\nsymbol\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nAmount in base units:\n${\nrawAmount\n}\n`\n)\n;\nconsole\n.\nlog\n(\n`\nApproximate USD value: $\n${\n(\nhumanReadableAmount\n*\nparseFloat\n(\ntokenInfo\n.\nfromToken\n.\nprice\n)\n)\n.\ntoFixed\n(\n2\n)\n}\n`\n)\n;\n// Execute the swap\nconsole\n.\nlog\n(\n\"\\nExecuting swap...\"\n)\n;\nconst\nswapResult\n=\nawait\nclient\n.\ndex\n.\nexecuteSwap\n(\n{\nchainId\n:\n'501'\n,\n// Solana chain ID\nfromTokenAddress\n:\n'11111111111111111111111111111111'\n,\n// SOL\ntoTokenAddress\n:\n'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'\n,\n// USDC\namount\n:\nrawAmount\n,\nslippage\n:\n'0.5'\n,\n// 0.5% slippage\nuserWalletAddress\n:\nprocess\n.\nenv\n.\nSOLANA_WALLET_ADDRESS\n!\n}\n)\n;\nconsole\n.\nlog\n(\n'Swap executed successfully:'\n)\n;\nconsole\n.\nlog\n(\nJSON\n.\nstringify\n(\nswapResult\n,\nnull\n,\n2\n)\n)\n;\nreturn\nswapResult\n;\n}\ncatch\n(\nerror\n)\n{\nif\n(\nerror\ninstanceof\nError\n)\n{\nconsole\n.\nerror\n(\n'Error executing swap:'\n,\nerror\n.\nmessage\n)\n;\n// API errors include details in the message\nif\n(\nerror\n.\nmessage\n.\nincludes\n(\n'API Error:'\n)\n)\n{\nconst\nmatch\n=\nerror\n.\nmessage\n.\nmatch\n(\n/\nAPI Error:\n(\n.\n*\n)\n/\n)\n;\nif\n(\nmatch\n)\nconsole\n.\nerror\n(\n'API Error Details:'\n,\nmatch\n[\n1\n]\n)\n;\n}\n}\nthrow\nerror\n;\n}\n}\n// Run if this file is executed directly\nif\n(\nrequire\n.\nmain\n===\nmodule\n)\n{\nexecuteSwap\n(\n)\n.\nthen\n(\n(\n)\n=>\nprocess\n.\nexit\n(\n0\n)\n)\n.\ncatch\n(\n(\nerror\n)\n=>\n{\nconsole\n.\nerror\n(\n'Error:'\n,\nerror\n)\n;\nprocess\n.\nexit\n(\n1\n)\n;\n}\n)\n;\n}\nexport\n{\nexecuteSwap\n}\n;\n获取报价\n#\nconst\nquote\n=\nawait\nclient\n.\ndex\n.\ngetQuote\n(\n{\nchainId\n:\n'501'\n,\n// Solana\nfromTokenAddress\n:\n'11111111111111111111111111111111'\n,\n// SOL\ntoTokenAddress\n:\n'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'\n,\n// USDC\namount\n:\n'100000000'\n,\n// 0.1 SOL (in lamports)\nslippage\n:\n'0.5'\n// 0.5%\n}\n)\n;\n执行兑换指令\n#\n导入以下代码库\n// Required Solana dependencies for DEX interaction\nimport\n{\nConnection\n,\n// Handles RPC connections to Solana network\nKeypair\n,\n// Manages wallet keypairs for signing\nPublicKey\n,\n// Handles Solana public key conversion and validation\nTransactionInstruction\n,\n// Core transaction instruction type\nTransactionMessage\n,\n// Builds transaction messages (v0 format)\nVersionedTransaction\n,\n// Supports newer transaction format with lookup tables\nRpcResponseAndContext\n,\n// RPC response wrapper type\nSimulatedTransactionResponse\n,\n// Simulation result type\nAddressLookupTableAccount\n,\n// For transaction size optimization\nPublicKeyInitData\n// Public key input type\n}\nfrom\n\"@solana/web3.js\"\n;\nimport\nbase58\nfrom\n\"bs58\"\n;\n// Required for private key decoding\n连线和钱包初始化\n// Note: Consider using a reliable RPC endpoint with high rate limits for production\nconst\nconnection\n=\nnew\nConnection\n(\nprocess\n.\nenv\n.\nSOLANA_RPC_URL\n||\n\"https://api.mainnet-beta.solana.com\"\n)\n;\n// Initialize wallet for signing\n// This wallet will be the fee payer and transaction signer\nconst\nwallet\n=\nKeypair\n.\nfromSecretKey\n(\nUint8Array\n.\nfrom\n(\nbase58\n.\ndecode\n(\nuserPrivateKey\n)\n)\n)\n;\n设置兑换参数\n#\n// Configure swap parameters\nconst\nbaseUrl\n=\n\"https://web3.okx.com/api/v5/dex/aggregator/swap-instruction\"\n;\nconst\nparams\n=\n{\nchainId\n:\n\"501\"\n,\n// Solana mainnet chain ID\nfeePercent\n:\n\"1\"\n,\n// Platform fee percentage\namount\n:\n\"1000000\"\n,\n// Amount in smallest denomination (lamports for SOL)\nfromTokenAddress\n:\n\"11111111111111111111111111111111\"\n,\n// SOL mint address\ntoTokenAddress\n:\n\"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\"\n,\n// USDC mint address\nslippage\n:\n\"0.1\"\n,\n// Slippage tolerance in percentage\nuserWalletAddress\n:\nuserAddress\n,\n// Wallet performing the swap\npriceTolerance\n:\n\"0\"\n,\n// Maximum allowed price impact\nautoSlippage\n:\n\"false\"\n,\n// Use fixed slippage instead of auto\npathNum\n:\n\"3\"\n// Maximum routes to consider\n}\n;\n兑换指令\n#\n// Helper function to convert DEX API instructions to Solana format\nfunction\ncreateTransactionInstruction\n(\ninstruction\n)\n{\nreturn\nnew\nTransactionInstruction\n(\n{\nprogramId\n:\nnew\nPublicKey\n(\ninstruction\n.\nprogramId\n)\n,\n// DEX program ID\nkeys\n:\ninstruction\n.\naccounts\n.\nmap\n(\n(\nkey\n)\n=>\n(\n{\npubkey\n:\nnew\nPublicKey\n(\nkey\n.\npubkey\n)\n,\n// Account address\nisSigner\n:\nkey\n.\nisSigner\n,\n// True if account must sign tx\nisWritable\n:\nkey\n.\nisWritable\n// True if instruction modifies account\n}\n)\n)\n,\ndata\n:\nBuffer\n.\nfrom\n(\ninstruction\n.\ndata\n,\n'base64'\n)\n// Instruction parameters\n}\n)\n;\n}\n// Fetch optimal swap route and instructions from DEX\nconst\ntimestamp\n=\nnew\nDate\n(\n)\n.\ntoISOString\n(\n)\n;\nconst\nrequestPath\n=\n\"/api/v5/dex/aggregator/swap-instruction\"\n;\nconst\nqueryString\n=\n\"?\"\n+\nnew\nURLSearchParams\n(\nparams\n)\n.\ntoString\n(\n)\n;\nconst\nheaders\n=\ngetHeaders\n(\ntimestamp\n,\n\"GET\"\n,\nrequestPath\n,\nqueryString\n)\n;\nconst\nresponse\n=\nawait\nfetch\n(\n`\nhttps://web3.okx.com\n${\nrequestPath\n}\n${\nqueryString\n}\n`\n,\n{\nmethod\n:\n'GET'\n,\nheaders\n}\n)\n;\nconst\n{\ndata\n}\n=\nawait\nresponse\n.\njson\n(\n)\n;\nconst\n{\ninstructionLists\n,\naddressLookupTableAccount\n}\n=\ndata\n;\n// Process DEX instructions into Solana-compatible format\nconst\ninstructions\n=\n[\n]\n;\n// Remove duplicate lookup table addresses returned by DEX\nconst\nuniqueLookupTables\n=\nArray\n.\nfrom\n(\nnew\nSet\n(\naddressLookupTableAccount\n)\n)\n;\nconsole\n.\nlog\n(\n\"Lookup tables to load:\"\n,\nuniqueLookupTables\n)\n;\n// Convert each DEX instruction to Solana format\nif\n(\ninstructionLists\n?.\nlength\n)\n{\ninstructions\n.\npush\n(\n...\ninstructionLists\n.\nmap\n(\ncreateTransactionInstruction\n)\n)\n;\n}\n地址查找表\n#\n// Process lookup tables for transaction optimization\n// Lookup tables are crucial for complex swaps that interact with many accounts\n// They significantly reduce transaction size and cost\nconst\naddressLookupTableAccounts\n=\n[\n]\n;\nif\n(\nuniqueLookupTables\n?.\nlength\n>\n0\n)\n{\nconsole\n.\nlog\n(\n\"Loading address lookup tables...\"\n)\n;\n// Fetch all lookup tables in parallel for better performance\nconst\nlookupTableAccounts\n=\nawait\nPromise\n.\nall\n(\nuniqueLookupTables\n.\nmap\n(\nasync\n(\naddress\n)\n=>\n{\nconst\npubkey\n=\nnew\nPublicKey\n(\naddress\n)\n;\n// Get lookup table account data from Solana\nconst\naccount\n=\nawait\nconnection\n.\ngetAddressLookupTable\n(\npubkey\n)\n.\nthen\n(\n(\nres\n)\n=>\nres\n.\nvalue\n)\n;\nif\n(\n!\naccount\n)\n{\nthrow\nnew\nError\n(\n`\nCould not fetch lookup table account\n${\naddress\n}\n`\n)\n;\n}\nreturn\naccount\n;\n}\n)\n)\n;\naddressLookupTableAccounts\n.\npush\n(\n...\nlookupTableAccounts\n)\n;\n}\n创建并签署交易\n#\n// Get recent blockhash for transaction timing and uniqueness\nconst\nlatestBlockhash\n=\nawait\nconnection\n.\ngetLatestBlockhash\n(\n'finalized'\n)\n;\n// Create versioned transaction message (V0 format required for lookup table support)\nconst\nmessageV0\n=\nnew\nTransactionMessage\n(\n{\npayerKey\n:\nwallet\n.\npublicKey\n,\n// Fee payer address\nrecentBlockhash\n:\nlatestBlockhash\n.\nblockhash\n,\n// Transaction timing\ninstructions\n// Swap instructions from DEX\n}\n)\n.\ncompileToV0Message\n(\naddressLookupTableAccounts\n)\n;\n// Include lookup tables\n// Create new versioned transaction with optimizations\nconst\ntransaction\n=\nnew\nVersionedTransaction\n(\nmessageV0\n)\n;\n// Simulate transaction to check for errors\n// This helps catch issues before paying fees\nconst\nresult\n=\nawait\nconnection\n.\nsimulateTransaction\n(\ntransaction\n)\n;\n// Sign transaction with fee payer wallet\ntransaction\n.\nsign\n(\n[\nwallet\n]\n)\n;\n执行交易\n#\n// Send transaction to Solana\n// skipPreflight=false ensures additional validation\n// maxRetries helps handle network issues\nconst\ntxId\n=\nawait\nconnection\n.\nsendRawTransaction\n(\ntransaction\n.\nserialize\n(\n)\n,\n{\nskipPreflight\n:\nfalse\n,\n// Run preflight validation\nmaxRetries\n:\n5\n// Retry on failure\n}\n)\n;\n// Log transaction results\nconsole\n.\nlog\n(\n\"Transaction ID:\"\n,\ntxId\n)\n;\nconsole\n.\nlog\n(\n\"Explorer URL:\"\n,\n`\nhttps://solscan.io/tx/\n${\ntxId\n}\n`\n)\n;\n// Wait for confirmation\nawait\nconnection\n.\nconfirmTransaction\n(\n{\nsignature\n:\ntxId\n,\nblockhash\n:\nlatestBlockhash\n.\nblockhash\n,\nlastValidBlockHeight\n:\nlatestBlockhash\n.\nlastValidBlockHeight\n}\n)\n;\nconsole\n.\nlog\n(\n\"Transaction confirmed!\"\n)\n;",
  "html": "<div class=\"routes_md__xWlGF\"><!--$--><h1 id=\"solana-示例\">Solana 示例<a class=\"index_header-anchor__Xqb+L\" href=\"#solana-示例\" style=\"opacity:0\">#</a></h1>\n<h2 data-content=\"创建兑换指令\" id=\"创建兑换指令\">创建兑换指令<a class=\"index_header-anchor__Xqb+L\" href=\"#创建兑换指令\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// swap.ts</span>\n<span class=\"token keyword module\">import</span> <span class=\"token imports\"><span class=\"token punctuation\">{</span> client <span class=\"token punctuation\">}</span></span> <span class=\"token keyword module\">from</span> <span class=\"token string\">'./DexClient'</span><span class=\"token punctuation\">;</span>\n<span class=\"token doc-comment comment\">/**</span>\n<span class=\"token doc-comment comment\"> * Example: Execute a swap from SOL to USDC</span>\n<span class=\"token doc-comment comment\"> */</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword control-flow\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>process<span class=\"token punctuation\">.</span><span class=\"token property-access\">env</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_PRIVATE_KEY</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword control-flow\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Missing SOLANA_PRIVATE_KEY in .env file'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// Get quote to fetch token information</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Getting token information...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> quote <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token property-access\">dex</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">getQuote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">chainId</span><span class=\"token operator\">:</span> <span class=\"token string\">'501'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">fromTokenAddress</span><span class=\"token operator\">:</span> <span class=\"token string\">'11111111111111111111111111111111'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// SOL</span>\n        <span class=\"token literal-property property\">toTokenAddress</span><span class=\"token operator\">:</span> <span class=\"token string\">'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// USDC</span>\n        <span class=\"token literal-property property\">amount</span><span class=\"token operator\">:</span> <span class=\"token string\">'1000000'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Small amount for quote</span>\n        <span class=\"token literal-property property\">slippage</span><span class=\"token operator\">:</span> <span class=\"token string\">'0.5'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> tokenInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">fromToken</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">symbol</span><span class=\"token operator\">:</span> quote<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">fromToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">tokenSymbol</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">decimals</span><span class=\"token operator\">:</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>quote<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">fromToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">decimal</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">price</span><span class=\"token operator\">:</span> quote<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">fromToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">tokenUnitPrice</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">toToken</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">symbol</span><span class=\"token operator\">:</span> quote<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">toToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">tokenSymbol</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">decimals</span><span class=\"token operator\">:</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>quote<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">toToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">decimal</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token literal-property property\">price</span><span class=\"token operator\">:</span> quote<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">toToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">tokenUnitPrice</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Convert amount to base units (for display purposes)</span>\n    <span class=\"token keyword\">const</span> humanReadableAmount <span class=\"token operator\">=</span> <span class=\"token number\">0.1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 0.1 SOL</span>\n    <span class=\"token keyword\">const</span> rawAmount <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>humanReadableAmount <span class=\"token operator\">*</span> <span class=\"token known-class-name class-name\">Math</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">pow</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> tokenInfo<span class=\"token punctuation\">.</span><span class=\"token property-access\">fromToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">decimals</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nSwap Details:\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"--------------------\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">From: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span><span class=\"token property-access\">fromToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">To: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span><span class=\"token property-access\">toToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Amount: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>humanReadableAmount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>tokenInfo<span class=\"token punctuation\">.</span><span class=\"token property-access\">fromToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">symbol</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Amount in base units: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>rawAmount<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Approximate USD value: $</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span>humanReadableAmount <span class=\"token operator\">*</span> <span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span>tokenInfo<span class=\"token punctuation\">.</span><span class=\"token property-access\">fromToken</span><span class=\"token punctuation\">.</span><span class=\"token property-access\">price</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Execute the swap</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nExecuting swap...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> swapResult <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token property-access\">dex</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">executeSwap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">chainId</span><span class=\"token operator\">:</span> <span class=\"token string\">'501'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Solana chain ID</span>\n      <span class=\"token literal-property property\">fromTokenAddress</span><span class=\"token operator\">:</span> <span class=\"token string\">'11111111111111111111111111111111'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// SOL</span>\n      <span class=\"token literal-property property\">toTokenAddress</span><span class=\"token operator\">:</span> <span class=\"token string\">'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// USDC</span>\n      <span class=\"token literal-property property\">amount</span><span class=\"token operator\">:</span> rawAmount<span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">slippage</span><span class=\"token operator\">:</span> <span class=\"token string\">'0.5'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 0.5% slippage</span>\n      <span class=\"token literal-property property\">userWalletAddress</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span><span class=\"token property-access\">env</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_WALLET_ADDRESS</span><span class=\"token operator\">!</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Swap executed successfully:'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token known-class-name class-name\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">stringify</span><span class=\"token punctuation\">(</span>swapResult<span class=\"token punctuation\">,</span> <span class=\"token keyword null nil\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword control-flow\">return</span> swapResult<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword control-flow\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>error <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error executing swap:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span><span class=\"token property-access\">message</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// API errors include details in the message</span>\n      <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span><span class=\"token property-access\">message</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'API Error:'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> match <span class=\"token operator\">=</span> error<span class=\"token punctuation\">.</span><span class=\"token property-access\">message</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">API Error: <span class=\"token group punctuation\">(</span><span class=\"token char-set class-name\">.</span><span class=\"token quantifier number\">*</span><span class=\"token group punctuation\">)</span></span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>match<span class=\"token punctuation\">)</span> <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'API Error Details:'</span><span class=\"token punctuation\">,</span> match<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword control-flow\">throw</span> error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Run if this file is executed directly</span>\n<span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>require<span class=\"token punctuation\">.</span><span class=\"token property-access\">main</span> <span class=\"token operator\">===</span> module<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">executeSwap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=&gt;</span> process<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword control-flow\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Error:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      process<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword module\">export</span> <span class=\"token exports\"><span class=\"token punctuation\">{</span> executeSwap <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"获取报价\" id=\"获取报价\">获取报价<a class=\"index_header-anchor__Xqb+L\" href=\"#获取报价\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> quote <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> client<span class=\"token punctuation\">.</span><span class=\"token property-access\">dex</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">getQuote</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">chainId</span><span class=\"token operator\">:</span> <span class=\"token string\">'501'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Solana</span>\n    <span class=\"token literal-property property\">fromTokenAddress</span><span class=\"token operator\">:</span> <span class=\"token string\">'11111111111111111111111111111111'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// SOL</span>\n    <span class=\"token literal-property property\">toTokenAddress</span><span class=\"token operator\">:</span> <span class=\"token string\">'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// USDC</span>\n    <span class=\"token literal-property property\">amount</span><span class=\"token operator\">:</span> <span class=\"token string\">'100000000'</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// 0.1 SOL (in lamports)</span>\n    <span class=\"token literal-property property\">slippage</span><span class=\"token operator\">:</span> <span class=\"token string\">'0.5'</span>     <span class=\"token comment\">// 0.5%</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"执行兑换指令\" id=\"执行兑换指令\">执行兑换指令<a class=\"index_header-anchor__Xqb+L\" href=\"#执行兑换指令\" style=\"opacity:0\">#</a></h2>\n<p>导入以下代码库</p>\n<div class=\"remark-highlight\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Required Solana dependencies for DEX interaction</span>\n<span class=\"token keyword module\">import</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token maybe-class-name\">Connection</span><span class=\"token punctuation\">,</span>          <span class=\"token comment\">// Handles RPC connections to Solana network</span>\n    <span class=\"token maybe-class-name\">Keypair</span><span class=\"token punctuation\">,</span>             <span class=\"token comment\">// Manages wallet keypairs for signing</span>\n    <span class=\"token maybe-class-name\">PublicKey</span><span class=\"token punctuation\">,</span>           <span class=\"token comment\">// Handles Solana public key conversion and validation</span>\n    <span class=\"token maybe-class-name\">TransactionInstruction</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\">// Core transaction instruction type</span>\n    <span class=\"token maybe-class-name\">TransactionMessage</span><span class=\"token punctuation\">,</span>        <span class=\"token comment\">// Builds transaction messages (v0 format)</span>\n    <span class=\"token maybe-class-name\">VersionedTransaction</span><span class=\"token punctuation\">,</span>      <span class=\"token comment\">// Supports newer transaction format with lookup tables</span>\n    <span class=\"token maybe-class-name\">RpcResponseAndContext</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\">// RPC response wrapper type</span>\n    <span class=\"token maybe-class-name\">SimulatedTransactionResponse</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Simulation result type</span>\n    <span class=\"token maybe-class-name\">AddressLookupTableAccount</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\">// For transaction size optimization</span>\n    <span class=\"token maybe-class-name\">PublicKeyInitData</span>              <span class=\"token comment\">// Public key input type</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword module\">from</span> <span class=\"token string\">\"@solana/web3.js\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword module\">import</span> <span class=\"token imports\">base58</span> <span class=\"token keyword module\">from</span> <span class=\"token string\">\"bs58\"</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// Required for private key decoding</span>\n</code></pre></div>\n<p>连线和钱包初始化</p>\n<div class=\"remark-highlight\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Note: Consider using a reliable RPC endpoint with high rate limits for production</span>\n<span class=\"token keyword\">const</span> connection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Connection</span><span class=\"token punctuation\">(</span>\n   process<span class=\"token punctuation\">.</span><span class=\"token property-access\">env</span><span class=\"token punctuation\">.</span><span class=\"token constant\">SOLANA_RPC_URL</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"https://api.mainnet-beta.solana.com\"</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Initialize wallet for signing</span>\n<span class=\"token comment\">// This wallet will be the fee payer and transaction signer</span>\n<span class=\"token keyword\">const</span> wallet <span class=\"token operator\">=</span> <span class=\"token maybe-class-name\">Keypair</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">fromSecretKey</span><span class=\"token punctuation\">(</span>\n   <span class=\"token known-class-name class-name\">Uint8Array</span><span class=\"token punctuation\">.</span><span class=\"token keyword module\">from</span><span class=\"token punctuation\">(</span>base58<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">decode</span><span class=\"token punctuation\">(</span>userPrivateKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"设置兑换参数\" id=\"设置兑换参数\">设置兑换参数<a class=\"index_header-anchor__Xqb+L\" href=\"#设置兑换参数\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Configure swap parameters</span>\n<span class=\"token keyword\">const</span> baseUrl <span class=\"token operator\">=</span> <span class=\"token string\">\"https://web3.okx.com/api/v5/dex/aggregator/swap-instruction\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">chainId</span><span class=\"token operator\">:</span> <span class=\"token string\">\"501\"</span><span class=\"token punctuation\">,</span>              <span class=\"token comment\">// Solana mainnet chain ID</span>\n    <span class=\"token literal-property property\">feePercent</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>             <span class=\"token comment\">// Platform fee percentage</span>\n    <span class=\"token literal-property property\">amount</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1000000\"</span><span class=\"token punctuation\">,</span>           <span class=\"token comment\">// Amount in smallest denomination (lamports for SOL)</span>\n    <span class=\"token literal-property property\">fromTokenAddress</span><span class=\"token operator\">:</span> <span class=\"token string\">\"11111111111111111111111111111111\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// SOL mint address</span>\n    <span class=\"token literal-property property\">toTokenAddress</span><span class=\"token operator\">:</span> <span class=\"token string\">\"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// USDC mint address</span>\n    <span class=\"token literal-property property\">slippage</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0.1\"</span><span class=\"token punctuation\">,</span>             <span class=\"token comment\">// Slippage tolerance in percentage</span>\n    <span class=\"token literal-property property\">userWalletAddress</span><span class=\"token operator\">:</span> userAddress<span class=\"token punctuation\">,</span>   <span class=\"token comment\">// Wallet performing the swap</span>\n    <span class=\"token literal-property property\">priceTolerance</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>         <span class=\"token comment\">// Maximum allowed price impact</span>\n    <span class=\"token literal-property property\">autoSlippage</span><span class=\"token operator\">:</span> <span class=\"token string\">\"false\"</span><span class=\"token punctuation\">,</span>       <span class=\"token comment\">// Use fixed slippage instead of auto</span>\n    <span class=\"token literal-property property\">pathNum</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3\"</span>                 <span class=\"token comment\">// Maximum routes to consider</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"兑换指令\" id=\"兑换指令\">兑换指令<a class=\"index_header-anchor__Xqb+L\" href=\"#兑换指令\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Helper function to convert DEX API instructions to Solana format</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createTransactionInstruction</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instruction</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword control-flow\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransactionInstruction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">programId</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>instruction<span class=\"token punctuation\">.</span><span class=\"token property-access\">programId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// DEX program ID</span>\n        <span class=\"token literal-property property\">keys</span><span class=\"token operator\">:</span> instruction<span class=\"token punctuation\">.</span><span class=\"token property-access\">accounts</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=&gt;</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            <span class=\"token literal-property property\">pubkey</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token property-access\">pubkey</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>    <span class=\"token comment\">// Account address</span>\n            <span class=\"token literal-property property\">isSigner</span><span class=\"token operator\">:</span> key<span class=\"token punctuation\">.</span><span class=\"token property-access\">isSigner</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\">// True if account must sign tx</span>\n            <span class=\"token literal-property property\">isWritable</span><span class=\"token operator\">:</span> key<span class=\"token punctuation\">.</span><span class=\"token property-access\">isWritable</span>  <span class=\"token comment\">// True if instruction modifies account</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token maybe-class-name\">Buffer</span><span class=\"token punctuation\">.</span><span class=\"token keyword module\">from</span><span class=\"token punctuation\">(</span>instruction<span class=\"token punctuation\">.</span><span class=\"token property-access\">data</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// Instruction parameters</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Fetch optimal swap route and instructions from DEX</span>\n<span class=\"token keyword\">const</span> timestamp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> requestPath <span class=\"token operator\">=</span> <span class=\"token string\">\"/api/v5/dex/aggregator/swap-instruction\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> queryString <span class=\"token operator\">=</span> <span class=\"token string\">\"?\"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">URLSearchParams</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">,</span> <span class=\"token string\">\"GET\"</span><span class=\"token punctuation\">,</span> requestPath<span class=\"token punctuation\">,</span> queryString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://web3.okx.com</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>requestPath<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>queryString<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> headers <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> response<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> instructionLists<span class=\"token punctuation\">,</span> addressLookupTableAccount <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Process DEX instructions into Solana-compatible format</span>\n<span class=\"token keyword\">const</span> instructions <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Remove duplicate lookup table addresses returned by DEX</span>\n<span class=\"token keyword\">const</span> uniqueLookupTables <span class=\"token operator\">=</span> <span class=\"token known-class-name class-name\">Array</span><span class=\"token punctuation\">.</span><span class=\"token keyword module\">from</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>addressLookupTableAccount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Lookup tables to load:\"</span><span class=\"token punctuation\">,</span> uniqueLookupTables<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Convert each DEX instruction to Solana format</span>\n<span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>instructionLists<span class=\"token operator\">?.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    instructions<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">push</span><span class=\"token punctuation\">(</span><span class=\"token spread operator\">...</span>instructionLists<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">map</span><span class=\"token punctuation\">(</span>createTransactionInstruction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"地址查找表\" id=\"地址查找表\">地址查找表<a class=\"index_header-anchor__Xqb+L\" href=\"#地址查找表\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Process lookup tables for transaction optimization</span>\n<span class=\"token comment\">// Lookup tables are crucial for complex swaps that interact with many accounts</span>\n<span class=\"token comment\">// They significantly reduce transaction size and cost</span>\n<span class=\"token keyword\">const</span> addressLookupTableAccounts <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span>uniqueLookupTables<span class=\"token operator\">?.</span>length <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Loading address lookup tables...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Fetch all lookup tables in parallel for better performance</span>\n    <span class=\"token keyword\">const</span> lookupTableAccounts <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> <span class=\"token known-class-name class-name\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">all</span><span class=\"token punctuation\">(</span>\n        uniqueLookupTables<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">address</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> pubkey <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PublicKey</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// Get lookup table account data from Solana</span>\n            <span class=\"token keyword\">const</span> account <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> connection\n                <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">getAddressLookupTable</span><span class=\"token punctuation\">(</span>pubkey<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token method function property-access\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token arrow operator\">=&gt;</span> res<span class=\"token punctuation\">.</span><span class=\"token property-access\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword control-flow\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>account<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword control-flow\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Could not fetch lookup table account </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>address<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword control-flow\">return</span> account<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    addressLookupTableAccounts<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">push</span><span class=\"token punctuation\">(</span><span class=\"token spread operator\">...</span>lookupTableAccounts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<h2 data-content=\"创建并签署交易\" id=\"创建并签署交易\">创建并签署交易<a class=\"index_header-anchor__Xqb+L\" href=\"#创建并签署交易\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Get recent blockhash for transaction timing and uniqueness</span>\n<span class=\"token keyword\">const</span> latestBlockhash <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">getLatestBlockhash</span><span class=\"token punctuation\">(</span><span class=\"token string\">'finalized'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Create versioned transaction message (V0 format required for lookup table support)</span>\n<span class=\"token keyword\">const</span> messageV0 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TransactionMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">payerKey</span><span class=\"token operator\">:</span> wallet<span class=\"token punctuation\">.</span><span class=\"token property-access\">publicKey</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\">// Fee payer address</span>\n    <span class=\"token literal-property property\">recentBlockhash</span><span class=\"token operator\">:</span> latestBlockhash<span class=\"token punctuation\">.</span><span class=\"token property-access\">blockhash</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Transaction timing</span>\n    instructions                     <span class=\"token comment\">// Swap instructions from DEX</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">compileToV0Message</span><span class=\"token punctuation\">(</span>addressLookupTableAccounts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Include lookup tables</span>\n<span class=\"token comment\">// Create new versioned transaction with optimizations</span>\n<span class=\"token keyword\">const</span> transaction <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">VersionedTransaction</span><span class=\"token punctuation\">(</span>messageV0<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Simulate transaction to check for errors</span>\n<span class=\"token comment\">// This helps catch issues before paying fees</span>\n<span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">simulateTransaction</span><span class=\"token punctuation\">(</span>transaction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Sign transaction with fee payer wallet</span>\ntransaction<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">sign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>wallet<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<h2 data-content=\"执行交易\" id=\"执行交易\">执行交易<a class=\"index_header-anchor__Xqb+L\" href=\"#执行交易\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Send transaction to Solana</span>\n<span class=\"token comment\">// skipPreflight=false ensures additional validation</span>\n<span class=\"token comment\">// maxRetries helps handle network issues</span>\n<span class=\"token keyword\">const</span> txId <span class=\"token operator\">=</span> <span class=\"token keyword control-flow\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">sendRawTransaction</span><span class=\"token punctuation\">(</span>transaction<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">serialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">skipPreflight</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Run preflight validation</span>\n    <span class=\"token literal-property property\">maxRetries</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span>         <span class=\"token comment\">// Retry on failure</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Log transaction results</span>\n<span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Transaction ID:\"</span><span class=\"token punctuation\">,</span> txId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Explorer URL:\"</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://solscan.io/tx/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>txId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// Wait for confirmation</span>\n<span class=\"token keyword control-flow\">await</span> connection<span class=\"token punctuation\">.</span><span class=\"token method function property-access\">confirmTransaction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">signature</span><span class=\"token operator\">:</span> txId<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">blockhash</span><span class=\"token operator\">:</span> latestBlockhash<span class=\"token punctuation\">.</span><span class=\"token property-access\">blockhash</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">lastValidBlockHeight</span><span class=\"token operator\">:</span> latestBlockhash<span class=\"token punctuation\">.</span><span class=\"token property-access\">lastValidBlockHeight</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token console class-name\">console</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Transaction confirmed!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre></div><!--/$--></div>",
  "url": "https://web3.okx.com/zh-hans/build/dev-docs/dex-api/dex-sdk-solana#创建并签署交易",
  "navigation": {
    "breadcrumbs": [
      "DEX API",
      "资源",
      "Solana 示例"
    ],
    "sidebar_links": [
      "介绍",
      "EVM 示例",
      "Solana 示例",
      "Sui 示例",
      "Javascript 签名 SDK",
      "Go 签名 SDK"
    ],
    "toc": [
      "创建兑换指令",
      "获取报价",
      "执行兑换指令"
    ]
  },
  "word_count": 1644,
  "extract_time": "2025-05-27 03:58:26"
}