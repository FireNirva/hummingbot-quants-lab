{
  "title": "DEX 集成 | 兑换 API | 交易 API | DEX API | DEX API 文档 | 欧易",
  "text": "DEX 集成\n#\n为了成功将您的 DEX 集成到 OKX 路由引擎中，请按照以下步骤操作：\n提供与 OKX DEX AMM 接口兼容的 DEX SDK：\n我们需要一个与我们的 AMM（自动化市场制造商）接口完全兼容的 DEX SDK。该SDK将允许我们与您的 DEX 进行通信并集成其功能，使流动性提供和交易执行能够在我们的平台上无缝进行。SDK 应能够处理定价、订单匹配、流动性池交互和交易执行等关键功能。\n允许我们分叉您的 SDK：\n为了确保长期的维护和用户支持，我们需要能够分叉您的 SDK。这意味着我们需要创建自己版本的 SDK 以供集成使用。通过这样做，我们可以：\n确保 SDK 的稳定性。\n独立维护和更新 SDK，修复潜在的错误并解决与您 DEX 集成相关的问题。\n根据我们的特定需求定制 SDK，进行性能优化。\n遵循我们提供的指南和示例：\n我们将提供详细的集成指南和示例代码，确保集成过程顺利进行。这将帮助您理解技术要求和结构，使过程更加简便和高效。通过遵循这些文档，您可以确保您的 DEX SDK 与我们的平台需求和集成标准对齐。\n通过满足这些指南，我们将能够为您的DEX提供可靠的支持，并确保您的流动性能够通过 OKX DEX 路由引擎进行访问。\n注意\n目前，该接口仅适用于基于 Solana 的 DEX。\nAMM 接入示例\n#\nuse async_trait\n:\n:\nasync_trait\n;\nuse solana_client\n:\n:\nrpc_client\n:\n:\nRpcClient\n;\nuse solana_sdk\n:\n:\npubkey\n:\n:\nPubkey\n;\nuse std\n:\n:\ncollections\n:\n:\nHashMap\n;\nuse std\n:\n:\nerror\n:\n:\nError\n;\nuse tokio\n:\n:\nsync\n:\n:\nmpsc\n:\n:\nSender\n;\npub mod raydium_clmm\n;\n// 其他 DEX 模块声明\n// pub mod raydium_amm;\n// pub mod orca_amm;\n// ...\n#\n[\nasync_trait\n]\npub trait Dex\n:\nSend\n+\nSync\n{\n// 返回 DEX 名称\nfn\ndex_name\n(\n&\nself\n)\n-\n>\nString\n;\n// 返回 DEX 的程序 ID\nfn\ndex_program_id\n(\n&\nself\n)\n-\n>\nPubkey\n;\n// 报价函数\nfn\nquote\n(\n&\nself\n,\namount_in\n:\nf64\n,\nmetadata\n:\n&\nPoolMetadata\n)\n-\n>\nf64\n;\n// 扫描链上所有池子地址\nfn\nfetch_pool_addresses\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n)\n-\n>\nVec\n<\nString\n>\n;\n// 监听新池子和数据变化的池子\nasync\nfn\nlisten_new_pool_addresses\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n,\naddress_tx\n:\nSender\n<\nString\n>\n,\n)\n-\n>\nResult\n<\n(\n)\n,\nBox\n<\ndyn Error\n>>\n;\n// 从池子地址导出报价参数\nfn\nfetch_pool_metadata\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n,\npool_address\n:\n&\nstr\n)\n-\n>\nOption\n<\nPoolMetadata\n>\n;\n}\n// 池子元数据（抽象设计）\n#\n[\nderive\n(\nClone\n)\n]\npub struct PoolMetadata\n{\npub pool_address\n:\nString\n,\npub base_mint\n:\nString\n,\npub quote_mint\n:\nString\n,\npub base_reserve\n:\nOption\n<\nf64\n>\n,\npub quote_reserve\n:\nOption\n<\nf64\n>\n,\npub trade_fee\n:\nOption\n<\nf64\n>\n,\npub extra\n:\nHashMap\n<\nString\n,\nPoolMetadataValue\n>\n,\n}\n// 池子元数据的扩展值类型\n#\n[\nderive\n(\nClone\n)\n]\npub\nenum\nPoolMetadataValue\n{\nString\n(\nString\n)\n,\nNumber\n(\nf64\n)\n,\nBool\n(\nbool\n)\n,\nArray\n(\nVec\n<\nPoolMetadataValue\n>\n)\n,\nMap\n(\nHashMap\n<\nString\n,\nPoolMetadataValue\n>\n)\n,\n}\n// 通用宏简化 HashMap 访问\nmacro_rules\n!\nget_extra\n{\n(\n$metadata\n:\nexpr\n,\n$key\n:\nexpr\n,\n$variant\n:\npath\n)\n=>\n{\n$metadata\n.\nextra\n.\nget\n(\n$key\n)\n.\nand_then\n(\n|\nv\n|\nmatch v\n{\n$variant\n(\nval\n)\n=>\nSome\n(\nval\n.\nclone\n(\n)\n)\n,\n_\n=>\nNone\n,\n}\n)\n}\n;\n}\npub\n(\ncrate\n)\nuse get_extra\n;\n基于 Raydium CLMM 的实现例子\n#\nuse async_trait\n:\n:\nasync_trait\n;\nuse solana_client\n:\n:\nrpc_client\n:\n:\nRpcClient\n;\nuse solana_sdk\n:\n:\n{\npubkey\n:\n:\nPubkey\n,\nsignature\n:\n:\nSignature\n,\ncommitment_config\n:\n:\nCommitmentConfig\n,\n}\n;\nuse std\n:\n:\ncollections\n:\n:\nHashMap\n;\nuse std\n:\n:\nerror\n:\n:\nError\n;\nuse std\n:\n:\nsync\n:\n:\n{\nArc\n,\nMutex\n}\n;\nuse tokio\n:\n:\nsync\n:\n:\nmpsc\n:\n:\nSender\n;\nuse base58\n:\n:\n{\nFromBase58\n,\nToBase58\n}\n;\nuse log\n:\n:\n{\ninfo\n,\nerror\n}\n;\nuse tokio_tungstenite\n:\n:\n{\nconnect_async\n,\ntungstenite\n:\n:\nprotocol\n:\n:\nMessage\n}\n;\nuse\nsuper\n:\n:\n{\nDex\n,\nPoolMetadata\n,\nget_extra\n}\n;\n// Raydium CLMM 程序 ID\nconst\nPROGRAM_ID\n:\n&\nstr\n=\n\"CLMM9tUush29+wnRVN2QqohW5Ns5mYAPbXTRmbn6kYH\"\n;\n// 全局映射表\nlazy_static\n:\n:\nlazy_static\n!\n{\nstatic\nref\nPOOL_ADDRESS_MAP\n:\nArc\n<\nMutex\n<\nHashMap\n<\nString\n,\nPoolDerivedAccounts\n>>>\n=\nArc\n:\n:\nnew\n(\nMutex\n:\n:\nnew\n(\nHashMap\n:\n:\nnew\n(\n)\n)\n)\n;\n}\n// Raydium CLMM 的池子派生账户\n#\n[\nderive\n(\nClone\n)\n]\nstruct PoolDerivedAccounts\n{\npool_address\n:\nString\n,\nbase_mint\n:\nString\n,\nquote_mint\n:\nString\n,\nbase_vault\n:\nString\n,\nquote_vault\n:\nString\n,\nfee_state\n:\nString\n,\ntick_array_current\n:\nString\n,\ntick_array_prev\n:\nString\n,\ntick_array_next\n:\nString\n,\nobservation_state\n:\nString\n,\n}\npub struct RaydiumCLMM\n;\n#\n[\nasync_trait\n]\nimpl Dex\nfor\nRaydiumCLMM\n{\nfn\ndex_name\n(\n&\nself\n)\n-\n>\nString\n{\n\"RaydiumCLMM\"\n.\nto_string\n(\n)\n}\nfn\ndex_program_id\n(\n&\nself\n)\n-\n>\nPubkey\n{\nPubkey\n:\n:\nfrom_str\n(\nPROGRAM_ID\n)\n.\nunwrap\n(\n)\n}\nfn\nquote\n(\n&\nself\n,\namount_in\n:\nf64\n,\nmetadata\n:\n&\nPoolMetadata\n)\n-\n>\nf64\n{\nif\namount_in\n<=\n0.0\n{\nreturn\n0.0\n;\n}\nlet\nfee_rate\n=\nmetadata\n.\ntrade_fee\n.\nunwrap_or\n(\n0.0\n)\n;\nlet\namount_in_with_fee\n=\namount_in\n*\n(\n1.0\n-\nfee_rate\n)\n;\nlet\nmut remaining_in\n=\namount_in_with_fee\n;\nlet\nmut total_out\n=\n0.0\n;\nlet\nsqrt_price_x64\n=\nget_extra\n!\n(\nmetadata\n,\n\"sqrt_price_x64\"\n,\nPoolMetadataValue\n:\n:\nNumber\n)\n.\nunwrap_or\n(\n0.0\n)\n;\nlet\ntick_current_index\n=\nget_extra\n!\n(\nmetadata\n,\n\"tick_current_index\"\n,\nPoolMetadataValue\n:\n:\nNumber\n)\n.\nunwrap_or\n(\n0.0\n)\nas\ni32\n;\nlet\ntick_array\n=\nget_extra\n!\n(\nmetadata\n,\n\"tick_array\"\n,\nPoolMetadataValue\n:\n:\nArray\n)\n.\nunwrap_or\n(\nvec\n!\n[\n]\n)\n;\nif\ntick_array\n.\nis_empty\n(\n)\n{\nreturn\n0.0\n;\n}\nlet\ncurrent_price\n=\nsqrt_price_x64\n/\n2_f64\n.\npowi\n(\n64\n)\n;\nlet\nmut current_tick\n=\ntick_current_index\n;\nlet\nmut ticks\n:\nVec\n<\n(\ni32\n,\nf64\n)\n>\n=\ntick_array\n.\niter\n(\n)\n.\nfilter_map\n(\n|\nv\n|\nmatch v\n{\nPoolMetadataValue\n:\n:\nMap\n(\nm\n)\n=>\n{\nlet\ntick_index\n=\nget_extra\n!\n(\nm\n,\n\"tick_index\"\n,\nPoolMetadataValue\n:\n:\nNumber\n)\n?\nas\ni32\n;\nlet\nliquidity\n=\nget_extra\n!\n(\nm\n,\n\"liquidity\"\n,\nPoolMetadataValue\n:\n:\nNumber\n)\n?\n;\nSome\n(\n(\ntick_index\n,\nliquidity\n)\n)\n}\n,\n_\n=>\nNone\n,\n}\n)\n.\ncollect\n(\n)\n;\nticks\n.\nsort_by\n(\n|\na\n,\nb\n|\na\n.\n0.\ncmp\n(\n&\nb\n.\n0\n)\n)\n;\nfor\n(\ntick_index\n,\nliquidity\n)\nin\nticks\n{\nif\ntick_index\n<=\ncurrent_tick\n{\ncontinue\n;\n}\nlet\nsqrt_price_lower\n=\n(\n1\n.\n0001_f64\n.\npowf\n(\ncurrent_tick\nas\nf64\n)\n)\n.\nsqrt\n(\n)\n;\nlet\nsqrt_price_upper\n=\n(\n1\n.\n0001_f64\n.\npowf\n(\ntick_index\nas\nf64\n)\n)\n.\nsqrt\n(\n)\n;\nlet\ndelta_sqrt_price\n=\nsqrt_price_upper\n-\nsqrt_price_lower\n;\nlet\nmax_amount_out\n=\nliquidity\n*\ndelta_sqrt_price\n;\nlet\ncost\n=\nmax_amount_out\n*\n(\nsqrt_price_upper\n+\nsqrt_price_lower\n)\n/\n2.0\n;\nif\nremaining_in\n>=\ncost\n{\ntotal_out\n+=\nmax_amount_out\n;\nremaining_in\n-=\ncost\n;\ncurrent_tick\n=\ntick_index\n;\n}\nelse\n{\nlet\nfraction\n=\nremaining_in\n/\ncost\n;\ntotal_out\n+=\nmax_amount_out\n*\nfraction\n;\nremaining_in\n=\n0.0\n;\nbreak\n;\n}\nif\nremaining_in\n<=\n0.0\n{\nbreak\n;\n}\n}\ntotal_out\n}\nfn\nfetch_pool_addresses\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n)\n-\n>\nVec\n<\nString\n>\n{\nlet\nprogram_id\n=\nself\n.\ndex_program_id\n(\n)\n;\nlet\naccounts\n=\nmatch client\n.\nget_program_accounts\n(\n&\nprogram_id\n)\n{\nOk\n(\naccs\n)\n=>\naccs\n,\nErr\n(\ne\n)\n=>\n{\nerror\n!\n(\n\"Failed to fetch {} pool addresses: {}\"\n,\nself\n.\ndex_name\n(\n)\n,\ne\n)\n;\nreturn\nVec\n:\n:\nnew\n(\n)\n;\n}\n}\n;\nlet\nmut pool_addresses\n=\nVec\n:\n:\nnew\n(\n)\n;\nfor\n(\npubkey\n,\naccount\n)\nin\naccounts\n{\nif\naccount\n.\nowner\n!=\nprogram_id\n{\ncontinue\n;\n}\nlet\ndata\n=\naccount\n.\ndata\n;\nif\ndata\n.\nlen\n(\n)\n<\n200\n{\ncontinue\n;\n}\nlet\nbase_mint\n=\ndata\n[\n0.\n.32\n]\n.\nto_base58\n(\n)\n;\nlet\nquote_mint\n=\ndata\n[\n32.\n.64\n]\n.\nto_base58\n(\n)\n;\nif\nbase_mint\n.\nis_empty\n(\n)\n||\nquote_mint\n.\nis_empty\n(\n)\n{\ncontinue\n;\n}\nlet\ndiscriminator\n=\nu64\n:\n:\nfrom_le_bytes\n(\ndata\n[\n0.\n.8\n]\n.\ntry_into\n(\n)\n.\nunwrap\n(\n)\n)\n;\nif\ndiscriminator\n==\n0\n{\ncontinue\n;\n}\nlet\npool_address\n=\npubkey\n.\nto_string\n(\n)\n;\npool_addresses\n.\npush\n(\npool_address\n.\nclone\n(\n)\n)\n;\nif\nlet\nSome\n(\naccounts\n)\n=\nself\n.\nderive_accounts_from_pool_address\n(\nclient\n,\n&\npool_address\n)\n{\nPOOL_ADDRESS_MAP\n.\nlock\n(\n)\n.\nunwrap\n(\n)\n.\ninsert\n(\npool_address\n,\naccounts\n)\n;\n}\n}\npool_addresses\n}\nasync\nfn\nlisten_new_pool_addresses\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n,\naddress_tx\n:\nSender\n<\nString\n>\n,\n)\n-\n>\nResult\n<\n(\n)\n,\nBox\n<\ndyn Error\n>>\n{\nlet\nprogram_id\n=\nself\n.\ndex_program_id\n(\n)\n;\nlet\nws_url\n=\n\"wss://api.mainnet-beta.solana.com\"\n;\nlet\n(\nmut ws_stream\n,\n_\n)\n=\nconnect_async\n(\nws_url\n)\n.\nawait\n?\n;\nlet\nsubscribe_msg\n=\nformat\n!\n(\nr#\n\"{\"\njsonrpc\n\":\"\n2.0\n\",\"\nid\n\":1,\"\nmethod\n\":\"\nlogsSubscribe\n\",\"\nparams\n\":[\"\nmentions\n\",\"\n{\n}\n\"]}\"\n#\n,\nprogram_id\n)\n;\nws_stream\n.\nsend\n(\nMessage\n:\n:\nText\n(\nsubscribe_msg\n)\n)\n.\nawait\n?\n;\nwhile\nlet\nSome\n(\nmsg\n)\n=\nws_stream\n.\nnext\n(\n)\n.\nawait\n{\nlet\nmsg\n=\nmsg\n?\n;\nif\nlet\nMessage\n:\n:\nText\n(\ntext\n)\n=\nmsg\n{\nlet\nlog\n:\nserde_json\n:\n:\nValue\n=\nserde_json\n:\n:\nfrom_str\n(\n&\ntext\n)\n?\n;\nif\nlog\n.\nget\n(\n\"result\"\n)\n.\nis_some\n(\n)\n{\ncontinue\n;\n}\nlet\nparams\n=\nlog\n.\nget\n(\n\"params\"\n)\n.\nand_then\n(\n|\np\n|\np\n.\nget\n(\n\"result\"\n)\n)\n.\nok_or\n(\n\"No params\"\n)\n?\n;\nlet\ntx_sig\n=\nparams\n.\nget\n(\n\"signature\"\n)\n.\nand_then\n(\n|\ns\n|\ns\n.\nas_str\n(\n)\n)\n.\nok_or\n(\n\"No signature\"\n)\n?\n;\nlet\nlogs\n=\nparams\n.\nget\n(\n\"logs\"\n)\n.\nand_then\n(\n|\nl\n|\nl\n.\nas_array\n(\n)\n)\n.\nok_or\n(\n\"No logs\"\n)\n?\n;\nlet\ntx\n=\nclient\n.\nget_transaction\n(\n&\nSignature\n:\n:\nfrom_str\n(\ntx_sig\n)\n?\n,\nCommitmentConfig\n:\n:\nconfirmed\n(\n)\n,\n)\n?\n;\nif\ntx\n.\nmeta\n.\nis_some\n(\n)\n&&\ntx\n.\nmeta\n.\nunwrap\n(\n)\n.\nerr\n.\nis_some\n(\n)\n{\ncontinue\n;\n}\nlet\nlog_str\n=\nlogs\n.\niter\n(\n)\n.\nfilter_map\n(\n|\nl\n|\nl\n.\nas_str\n(\n)\n)\n.\ncollect\n:\n:\n<\nVec\n<\n&\nstr\n>>\n(\n)\n.\njoin\n(\n\" \"\n)\n;\nlet\naccount_keys\n=\ntx\n.\ntransaction\n.\nmessage\n.\naccount_keys\n;\nfor\n(\ni\n,\nkey\n)\nin\naccount_keys\n.\niter\n(\n)\n.\nenumerate\n(\n)\n{\nif\ntx\n.\ntransaction\n.\nmessage\n.\nis_writable\n(\ni\n)\n{\nlet\npool_address\n=\nself\n.\nfind_pool_address_from_account\n(\n&\nkey\n.\nto_string\n(\n)\n)\n;\nif\npool_address\n.\nis_empty\n(\n)\n&&\nself\n.\nis_valid_pool_address\n(\nclient\n,\n&\nkey\n.\nto_string\n(\n)\n)\n{\nif\nlet\nSome\n(\naccounts\n)\n=\nself\n.\nderive_accounts_from_pool_address\n(\nclient\n,\n&\nkey\n.\nto_string\n(\n)\n)\n{\nPOOL_ADDRESS_MAP\n.\nlock\n(\n)\n.\nunwrap\n(\n)\n.\ninsert\n(\nkey\n.\nto_string\n(\n)\n,\naccounts\n)\n;\ninfo\n!\n(\n\"Detected new {} pool address: {}\"\n,\nself\n.\ndex_name\n(\n)\n,\nkey\n)\n;\naddress_tx\n.\nsend\n(\nkey\n.\nto_string\n(\n)\n)\n.\nawait\n?\n;\n}\n}\nelse\nif\n!\npool_address\n.\nis_empty\n(\n)\n{\ninfo\n!\n(\n\"Detected writable account affecting pool: {}, Pool: {}\"\n,\ntx_sig\n,\npool_address\n)\n;\naddress_tx\n.\nsend\n(\npool_address\n)\n.\nawait\n?\n;\n}\n}\n}\nif\nlog_str\n.\ncontains\n(\n\"initialize\"\n)\n{\nif\nlet\nSome\n(\npool_address\n)\n=\nself\n.\nextract_new_pool_address\n(\nclient\n,\ntx_sig\n)\n{\nif\nself\n.\nis_valid_pool_address\n(\nclient\n,\n&\npool_address\n)\n{\nif\nlet\nSome\n(\naccounts\n)\n=\nself\n.\nderive_accounts_from_pool_address\n(\nclient\n,\n&\npool_address\n)\n{\nPOOL_ADDRESS_MAP\n.\nlock\n(\n)\n.\nunwrap\n(\n)\n.\ninsert\n(\npool_address\n.\nclone\n(\n)\n,\naccounts\n)\n;\ninfo\n!\n(\n\"Detected new {} pool address: {}\"\n,\nself\n.\ndex_name\n(\n)\n,\npool_address\n)\n;\naddress_tx\n.\nsend\n(\npool_address\n)\n.\nawait\n?\n;\n}\n}\n}\n}\n}\n}\nOk\n(\n(\n)\n)\n}\nfn\nfetch_pool_metadata\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n,\npool_address\n:\n&\nstr\n)\n-\n>\nOption\n<\nPoolMetadata\n>\n{\nlet\nderived_accounts\n=\nself\n.\nderive_accounts_from_pool_address\n(\nclient\n,\npool_address\n)\n?\n;\nlet\nout\n=\nclient\n.\nget_account_data\n(\n&\nPubkey\n:\n:\nfrom_str\n(\npool_address\n)\n.\nok\n(\n)\n?\n)\n.\nok\n(\n)\n?\n;\nif\nout\n.\nlen\n(\n)\n<\n200\n{\nerror\n!\n(\n\"Pool data too short for {}\"\n,\npool_address\n)\n;\nreturn\nNone\n;\n}\nlet\nbase_reserve\n=\nself\n.\nget_vault_balance\n(\nclient\n,\n&\nderived_accounts\n.\nbase_vault\n)\n;\nlet\nquote_reserve\n=\nself\n.\nget_vault_balance\n(\nclient\n,\n&\nderived_accounts\n.\nquote_vault\n)\n;\nlet\nfee_data\n=\nclient\n.\nget_account_data\n(\n&\nPubkey\n:\n:\nfrom_str\n(\n&\nderived_accounts\n.\nfee_state\n)\n.\nok\n(\n)\n?\n)\n.\nok\n(\n)\n?\n;\nlet\nfee_numerator\n=\nu64\n:\n:\nfrom_le_bytes\n(\nfee_data\n[\n0.\n.8\n]\n.\ntry_into\n(\n)\n.\nunwrap\n(\n)\n)\n;\nlet\nfee_denominator\n=\nu64\n:\n:\nfrom_le_bytes\n(\nfee_data\n[\n8.\n.16\n]\n.\ntry_into\n(\n)\n.\nunwrap\n(\n)\n)\n;\nlet\ntrade_fee\n=\nif\nfee_denominator\n>\n0\n{\nSome\n(\nfee_numerator\nas\nf64\n/\nfee_denominator\nas\nf64\n)\n}\nelse\n{\nNone\n}\n;\nlet\nsqrt_price_x64\n=\nu64\n:\n:\nfrom_le_bytes\n(\nout\n[\n64.\n.72\n]\n.\ntry_into\n(\n)\n.\nunwrap\n(\n)\n)\n;\nlet\ntick_current_index\n=\ni32\n:\n:\nfrom_le_bytes\n(\nout\n[\n72.\n.76\n]\n.\ntry_into\n(\n)\n.\nunwrap\n(\n)\n)\n;\nlet\ntick_array_data\n=\nclient\n.\nget_account_data\n(\n&\nPubkey\n:\n:\nfrom_str\n(\n&\nderived_accounts\n.\ntick_array_current\n)\n.\nok\n(\n)\n?\n)\n.\nunwrap_or_default\n(\n)\n;\nlet\nmut tick_array\n=\nVec\n:\n:\nnew\n(\n)\n;\nif\n!\ntick_array_data\n.\nis_empty\n(\n)\n{\nfor\ni\nin\n(\n8.\n.\ntick_array_data\n.\nlen\n(\n)\n-\n12\n)\n.\nstep_by\n(\n12\n)\n{\nlet\ntick_index\n=\ni32\n:\n:\nfrom_le_bytes\n(\ntick_array_data\n[\ni\n.\n.\ni\n+\n4\n]\n.\ntry_into\n(\n)\n.\nunwrap\n(\n)\n)\n;\nlet\nliquidity\n=\nf64\n:\n:\nfrom_le_bytes\n(\ntick_array_data\n[\ni\n+\n4.\n.\ni\n+\n12\n]\n.\ntry_into\n(\n)\n.\nunwrap\n(\n)\n)\n/\n1_000_000.0\n;\nlet\nmut tick_map\n=\nHashMap\n:\n:\nnew\n(\n)\n;\ntick_map\n.\ninsert\n(\n\"tick_index\"\n.\nto_string\n(\n)\n,\nPoolMetadataValue\n:\n:\nNumber\n(\ntick_index\nas\nf64\n)\n)\n;\ntick_map\n.\ninsert\n(\n\"liquidity\"\n.\nto_string\n(\n)\n,\nPoolMetadataValue\n:\n:\nNumber\n(\nliquidity\n)\n)\n;\ntick_array\n.\npush\n(\nPoolMetadataValue\n:\n:\nMap\n(\ntick_map\n)\n)\n;\n}\n}\nlet\nmut extra\n=\nHashMap\n:\n:\nnew\n(\n)\n;\nextra\n.\ninsert\n(\n\"sqrt_price_x64\"\n.\nto_string\n(\n)\n,\nPoolMetadataValue\n:\n:\nNumber\n(\nsqrt_price_x64\nas\nf64\n)\n)\n;\nextra\n.\ninsert\n(\n\"tick_current_index\"\n.\nto_string\n(\n)\n,\nPoolMetadataValue\n:\n:\nNumber\n(\ntick_current_index\nas\nf64\n)\n)\n;\nextra\n.\ninsert\n(\n\"tick_array\"\n.\nto_string\n(\n)\n,\nPoolMetadataValue\n:\n:\nArray\n(\ntick_array\n)\n)\n;\nSome\n(\nPoolMetadata\n{\npool_address\n:\npool_address\n.\nto_string\n(\n)\n,\nbase_mint\n:\nderived_accounts\n.\nbase_mint\n,\nquote_mint\n:\nderived_accounts\n.\nquote_mint\n,\nbase_reserve\n:\nSome\n(\nbase_reserve\n)\n,\nquote_reserve\n:\nSome\n(\nquote_reserve\n)\n,\ntrade_fee\n,\nextra\n,\n}\n)\n}\n}\nimpl RaydiumCLMM\n{\nfn\nderive_accounts_from_pool_address\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n,\npool_address\n:\n&\nstr\n)\n-\n>\nOption\n<\nPoolDerivedAccounts\n>\n{\nlet\nout\n=\nclient\n.\nget_account_data\n(\n&\nPubkey\n:\n:\nfrom_str\n(\npool_address\n)\n.\nok\n(\n)\n?\n)\n.\nok\n(\n)\n?\n;\nif\nout\n.\nlen\n(\n)\n<\n200\n{\nerror\n!\n(\n\"Pool data too short for {}\"\n,\npool_address\n)\n;\nreturn\nNone\n;\n}\nlet\nbase_mint\n=\nout\n[\n0.\n.32\n]\n.\nto_base58\n(\n)\n;\nlet\nquote_mint\n=\nout\n[\n32.\n.64\n]\n.\nto_base58\n(\n)\n;\nlet\nbase_vault\n=\nout\n[\n96.\n.128\n]\n.\nto_base58\n(\n)\n;\nlet\nquote_vault\n=\nout\n[\n128.\n.160\n]\n.\nto_base58\n(\n)\n;\nlet\nfee_state\n=\nout\n[\n160.\n.192\n]\n.\nto_base58\n(\n)\n;\nlet\ntick_array_current_seed\n=\nformat\n!\n(\n\"tick_array{}\"\n,\npool_address\n)\n;\nlet\ntick_array_current\n=\nPubkey\n:\n:\ncreate_program_address\n(\n&\n[\n&\ntick_array_current_seed\n.\nas_bytes\n(\n)\n]\n,\n&\nPubkey\n:\n:\nfrom_str\n(\nPROGRAM_ID\n)\n.\nunwrap\n(\n)\n,\n)\n.\nok\n(\n)\n?.\nto_string\n(\n)\n;\nlet\ntick_array_prev_seed\n=\nformat\n!\n(\n\"tick_array_prev{}\"\n,\npool_address\n)\n;\nlet\ntick_array_prev\n=\nPubkey\n:\n:\ncreate_program_address\n(\n&\n[\n&\ntick_array_prev_seed\n.\nas_bytes\n(\n)\n]\n,\n&\nPubkey\n:\n:\nfrom_str\n(\nPROGRAM_ID\n)\n.\nunwrap\n(\n)\n,\n)\n.\nok\n(\n)\n?.\nto_string\n(\n)\n;\nlet\ntick_array_next_seed\n=\nformat\n!\n(\n\"tick_array_next{}\"\n,\npool_address\n)\n;\nlet\ntick_array_next\n=\nPubkey\n:\n:\ncreate_program_address\n(\n&\n[\n&\ntick_array_next_seed\n.\nas_bytes\n(\n)\n]\n,\n&\nPubkey\n:\n:\nfrom_str\n(\nPROGRAM_ID\n)\n.\nunwrap\n(\n)\n,\n)\n.\nok\n(\n)\n?.\nto_string\n(\n)\n;\nlet\nobservation_state_seed\n=\nformat\n!\n(\n\"observation_state{}\"\n,\npool_address\n)\n;\nlet\nobservation_state\n=\nPubkey\n:\n:\ncreate_program_address\n(\n&\n[\n&\nobservation_state_seed\n.\nas_bytes\n(\n)\n]\n,\n&\nPubkey\n:\n:\nfrom_str\n(\nPROGRAM_ID\n)\n.\nunwrap\n(\n)\n,\n)\n.\nok\n(\n)\n?.\nto_string\n(\n)\n;\nSome\n(\nPoolDerivedAccounts\n{\npool_address\n:\npool_address\n.\nto_string\n(\n)\n,\nbase_mint\n,\nquote_mint\n,\nbase_vault\n,\nquote_vault\n,\nfee_state\n,\ntick_array_current\n,\ntick_array_prev\n,\ntick_array_next\n,\nobservation_state\n,\n}\n)\n}\nfn\nfind_pool_address_from_account\n(\n&\nself\n,\naccount_address\n:\n&\nstr\n)\n-\n>\nString\n{\nlet\nmap\n=\nPOOL_ADDRESS_MAP\n.\nlock\n(\n)\n.\nunwrap\n(\n)\n;\nfor\n(\npool_address\n,\naccounts\n)\nin\nmap\n.\niter\n(\n)\n{\nif\naccount_address\n==\npool_address\n||\naccount_address\n==\n&\naccounts\n.\nbase_vault\n||\naccount_address\n==\n&\naccounts\n.\nquote_vault\n||\naccount_address\n==\n&\naccounts\n.\ntick_array_current\n||\naccount_address\n==\n&\naccounts\n.\ntick_array_prev\n||\naccount_address\n==\n&\naccounts\n.\ntick_array_next\n{\nreturn\npool_address\n.\nclone\n(\n)\n;\n}\n}\nString\n:\n:\nnew\n(\n)\n}\nfn\nis_valid_pool_address\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n,\npool_address\n:\n&\nstr\n)\n-\n>\nbool\n{\nlet\nout\n=\nmatch client\n.\nget_account_data\n(\n&\nPubkey\n:\n:\nfrom_str\n(\npool_address\n)\n.\nunwrap\n(\n)\n)\n{\nOk\n(\ndata\n)\n=>\ndata\n,\nErr\n(\n_\n)\n=>\nreturn\nfalse\n,\n}\n;\nif\nout\n.\nlen\n(\n)\n<\n200\n{\nreturn\nfalse\n;\n}\nif\nPubkey\n:\n:\nfrom_str\n(\n&\nout\n.\nowner\n.\nto_string\n(\n)\n)\n.\nunwrap\n(\n)\n!=\nPubkey\n:\n:\nfrom_str\n(\nPROGRAM_ID\n)\n.\nunwrap\n(\n)\n{\nreturn\nfalse\n;\n}\nlet\nbase_mint\n=\nout\n[\n0.\n.32\n]\n.\nto_base58\n(\n)\n;\nlet\nquote_mint\n=\nout\n[\n32.\n.64\n]\n.\nto_base58\n(\n)\n;\nif\nbase_mint\n.\nis_empty\n(\n)\n||\nquote_mint\n.\nis_empty\n(\n)\n{\nreturn\nfalse\n;\n}\nlet\ndiscriminator\n=\nu64\n:\n:\nfrom_le_bytes\n(\nout\n[\n0.\n.8\n]\n.\ntry_into\n(\n)\n.\nunwrap\n(\n)\n)\n;\nif\ndiscriminator\n==\n0\n{\nreturn\nfalse\n;\n}\ntrue\n}\nfn\nget_vault_balance\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n,\nvault\n:\n&\nstr\n)\n-\n>\nf64\n{\nmatch client\n.\nget_token_account_balance\n(\n&\nPubkey\n:\n:\nfrom_str\n(\nvault\n)\n.\nunwrap\n(\n)\n,\nCommitmentConfig\n:\n:\nconfirmed\n(\n)\n)\n{\nOk\n(\nresp\n)\n=>\nresp\n.\nui_amount\n.\nunwrap_or\n(\n0.0\n)\n,\nErr\n(\n_\n)\n=>\n0.0\n,\n}\n}\nfn\nextract_new_pool_address\n(\n&\nself\n,\nclient\n:\n&\nRpcClient\n,\ntx_sig\n:\n&\nstr\n)\n-\n>\nOption\n<\nString\n>\n{\nlet\ntx\n=\nclient\n.\nget_transaction\n(\n&\nSignature\n:\n:\nfrom_str\n(\ntx_sig\n)\n.\nok\n(\n)\n?\n,\nCommitmentConfig\n:\n:\nconfirmed\n(\n)\n,\n)\n.\nok\n(\n)\n?\n;\nfor\nkey\nin\ntx\n.\ntransaction\n.\nmessage\n.\naccount_keys\n{\nif\nkey\n.\nis_writable\n(\n)\n&&\n!\nkey\n.\nis_signer\n(\n)\n{\nreturn\nSome\n(\nkey\n.\nto_string\n(\n)\n)\n;\n}\n}\nNone\n}\n}",
  "html": "<div class=\"routes_md__xWlGF\"><!--$--><h1 id=\"dex-集成\">DEX 集成<a class=\"index_header-anchor__Xqb+L\" href=\"#dex-集成\" style=\"opacity:0\">#</a></h1>\n<p>为了成功将您的 DEX 集成到 OKX 路由引擎中，请按照以下步骤操作：</p>\n<ol>\n<li>\n<p>提供与 OKX DEX AMM 接口兼容的 DEX SDK：\n我们需要一个与我们的 AMM（自动化市场制造商）接口完全兼容的 DEX SDK。该SDK将允许我们与您的 DEX 进行通信并集成其功能，使流动性提供和交易执行能够在我们的平台上无缝进行。SDK 应能够处理定价、订单匹配、流动性池交互和交易执行等关键功能。</p>\n</li>\n<li>\n<p>允许我们分叉您的 SDK：\n为了确保长期的维护和用户支持，我们需要能够分叉您的 SDK。这意味着我们需要创建自己版本的 SDK 以供集成使用。通过这样做，我们可以：</p>\n</li>\n</ol>\n<ul>\n<li>确保 SDK 的稳定性。</li>\n<li>独立维护和更新 SDK，修复潜在的错误并解决与您 DEX 集成相关的问题。</li>\n<li>根据我们的特定需求定制 SDK，进行性能优化。</li>\n</ul>\n<ol start=\"3\">\n<li>遵循我们提供的指南和示例：\n我们将提供详细的集成指南和示例代码，确保集成过程顺利进行。这将帮助您理解技术要求和结构，使过程更加简便和高效。通过遵循这些文档，您可以确保您的 DEX SDK 与我们的平台需求和集成标准对齐。</li>\n</ol>\n<p>通过满足这些指南，我们将能够为您的DEX提供可靠的支持，并确保您的流动性能够通过 OKX DEX 路由引擎进行访问。</p>\n<div class=\"index_wrapper__x5A2Q\"><div aria-labelledby=\":Rdbf:\" class=\"okui-alert info-alert\"><i aria-label=\"信息\" class=\"icon iconfont okui-alert-icon doc-ssr-okds-information-circle-fill\" role=\"img\"></i><div class=\"okui-alert-msg-box\"><div class=\"okui-alert-title\" id=\":Rdbf:\">注意</div><div class=\"okui-alert-desc\"><div class=\"index_desc__5fNBE\">目前，该接口仅适用于基于 Solana 的 DEX。</div></div></div></div></div>\n<h2 data-content=\"AMM 接入示例\" id=\"amm-接入示例\">AMM 接入示例<a class=\"index_header-anchor__Xqb+L\" href=\"#amm-接入示例\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\">use async_trait<span class=\"token operator\">:</span><span class=\"token operator\">:</span>async_trait<span class=\"token punctuation\">;</span>\nuse solana_client<span class=\"token operator\">:</span><span class=\"token operator\">:</span>rpc_client<span class=\"token operator\">:</span><span class=\"token operator\">:</span>RpcClient<span class=\"token punctuation\">;</span>\nuse solana_sdk<span class=\"token operator\">:</span><span class=\"token operator\">:</span>pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Pubkey<span class=\"token punctuation\">;</span>\nuse std<span class=\"token operator\">:</span><span class=\"token operator\">:</span>collections<span class=\"token operator\">:</span><span class=\"token operator\">:</span>HashMap<span class=\"token punctuation\">;</span>\nuse std<span class=\"token operator\">:</span><span class=\"token operator\">:</span>error<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Error<span class=\"token punctuation\">;</span>\nuse tokio<span class=\"token operator\">:</span><span class=\"token operator\">:</span>sync<span class=\"token operator\">:</span><span class=\"token operator\">:</span>mpsc<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Sender<span class=\"token punctuation\">;</span>\n\npub mod raydium_clmm<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 其他 DEX 模块声明</span>\n<span class=\"token comment\">// pub mod raydium_amm;</span>\n<span class=\"token comment\">// pub mod orca_amm;</span>\n<span class=\"token comment\">// ...</span>\n\n#<span class=\"token punctuation\">[</span>async_trait<span class=\"token punctuation\">]</span>\npub trait Dex<span class=\"token operator\">:</span> Send <span class=\"token operator\">+</span> Sync <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 返回 DEX 名称</span>\n    fn <span class=\"token function\">dex_name</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> String<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 返回 DEX 的程序 ID</span>\n    fn <span class=\"token function\">dex_program_id</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Pubkey<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 报价函数</span>\n    fn <span class=\"token function\">quote</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> amount_in<span class=\"token operator\">:</span> f64<span class=\"token punctuation\">,</span> metadata<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>PoolMetadata<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> f64<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 扫描链上所有池子地址</span>\n    fn <span class=\"token function\">fetch_pool_addresses</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Vec<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 监听新池子和数据变化的池子</span>\n    <span class=\"token keyword\">async</span> fn <span class=\"token function\">listen_new_pool_addresses</span><span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span>\n        client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">,</span>\n        address_tx<span class=\"token operator\">:</span> Sender<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Result<span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Box<span class=\"token operator\">&lt;</span>dyn Error<span class=\"token operator\">&gt;&gt;</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 从池子地址导出报价参数</span>\n    fn <span class=\"token function\">fetch_pool_metadata</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">,</span> pool_address<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Option<span class=\"token operator\">&lt;</span>PoolMetadata<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 池子元数据（抽象设计）</span>\n#<span class=\"token punctuation\">[</span><span class=\"token function\">derive</span><span class=\"token punctuation\">(</span>Clone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\npub struct PoolMetadata <span class=\"token punctuation\">{</span>\n    pub pool_address<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    pub base_mint<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    pub quote_mint<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    pub base_reserve<span class=\"token operator\">:</span> Option<span class=\"token operator\">&lt;</span>f64<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span>\n    pub quote_reserve<span class=\"token operator\">:</span> Option<span class=\"token operator\">&lt;</span>f64<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span>\n    pub trade_fee<span class=\"token operator\">:</span> Option<span class=\"token operator\">&lt;</span>f64<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span>\n    pub extra<span class=\"token operator\">:</span> HashMap<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 池子元数据的扩展值类型</span>\n#<span class=\"token punctuation\">[</span><span class=\"token function\">derive</span><span class=\"token punctuation\">(</span>Clone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\npub <span class=\"token keyword\">enum</span> PoolMetadataValue <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>f64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">Bool</span><span class=\"token punctuation\">(</span>bool<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">Array</span><span class=\"token punctuation\">(</span>Vec<span class=\"token operator\">&lt;</span>PoolMetadataValue<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">Map</span><span class=\"token punctuation\">(</span>HashMap<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 通用宏简化 HashMap 访问</span>\nmacro_rules<span class=\"token operator\">!</span> get_extra <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">(</span>$metadata<span class=\"token operator\">:</span>expr<span class=\"token punctuation\">,</span> $key<span class=\"token operator\">:</span>expr<span class=\"token punctuation\">,</span> $variant<span class=\"token operator\">:</span>path<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n        $metadata<span class=\"token punctuation\">.</span>extra<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>$key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">and_then</span><span class=\"token punctuation\">(</span><span class=\"token operator\">|</span>v<span class=\"token operator\">|</span> match v <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">$variant</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            _ <span class=\"token operator\">=&gt;</span> None<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">pub</span><span class=\"token punctuation\">(</span>crate<span class=\"token punctuation\">)</span> use get_extra<span class=\"token punctuation\">;</span>\n\n</code></pre></div>\n<h2 data-content=\"基于 Raydium CLMM 的实现例子\" id=\"基于-raydium-clmm-的实现例子\">基于 Raydium CLMM 的实现例子<a class=\"index_header-anchor__Xqb+L\" href=\"#基于-raydium-clmm-的实现例子\" style=\"opacity:0\">#</a></h2>\n<div class=\"remark-highlight\"><pre class=\"language-typescript\"><code class=\"language-typescript\">use async_trait<span class=\"token operator\">:</span><span class=\"token operator\">:</span>async_trait<span class=\"token punctuation\">;</span>\nuse solana_client<span class=\"token operator\">:</span><span class=\"token operator\">:</span>rpc_client<span class=\"token operator\">:</span><span class=\"token operator\">:</span>RpcClient<span class=\"token punctuation\">;</span>\nuse solana_sdk<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>\n    pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Pubkey<span class=\"token punctuation\">,</span>\n    signature<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Signature<span class=\"token punctuation\">,</span>\n    commitment_config<span class=\"token operator\">:</span><span class=\"token operator\">:</span>CommitmentConfig<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nuse std<span class=\"token operator\">:</span><span class=\"token operator\">:</span>collections<span class=\"token operator\">:</span><span class=\"token operator\">:</span>HashMap<span class=\"token punctuation\">;</span>\nuse std<span class=\"token operator\">:</span><span class=\"token operator\">:</span>error<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Error<span class=\"token punctuation\">;</span>\nuse std<span class=\"token operator\">:</span><span class=\"token operator\">:</span>sync<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>Arc<span class=\"token punctuation\">,</span> Mutex<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nuse tokio<span class=\"token operator\">:</span><span class=\"token operator\">:</span>sync<span class=\"token operator\">:</span><span class=\"token operator\">:</span>mpsc<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Sender<span class=\"token punctuation\">;</span>\nuse base58<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>FromBase58<span class=\"token punctuation\">,</span> ToBase58<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nuse log<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>info<span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nuse tokio_tungstenite<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>connect_async<span class=\"token punctuation\">,</span> tungstenite<span class=\"token operator\">:</span><span class=\"token operator\">:</span>protocol<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Message<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nuse <span class=\"token keyword\">super</span><span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token punctuation\">{</span>Dex<span class=\"token punctuation\">,</span> PoolMetadata<span class=\"token punctuation\">,</span> get_extra<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Raydium CLMM 程序 ID</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PROGRAM_ID</span><span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>str <span class=\"token operator\">=</span> <span class=\"token string\">\"CLMM9tUush29+wnRVN2QqohW5Ns5mYAPbXTRmbn6kYH\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 全局映射表</span>\nlazy_static<span class=\"token operator\">:</span><span class=\"token operator\">:</span>lazy_static<span class=\"token operator\">!</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> ref <span class=\"token constant\">POOL_ADDRESS_MAP</span><span class=\"token operator\">:</span> Arc<span class=\"token operator\">&lt;</span>Mutex<span class=\"token operator\">&lt;</span>HashMap<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> PoolDerivedAccounts<span class=\"token operator\">&gt;&gt;&gt;</span> <span class=\"token operator\">=</span> Arc<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>Mutex<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span>HashMap<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Raydium CLMM 的池子派生账户</span>\n#<span class=\"token punctuation\">[</span><span class=\"token function\">derive</span><span class=\"token punctuation\">(</span>Clone<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\nstruct PoolDerivedAccounts <span class=\"token punctuation\">{</span>\n    pool_address<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    base_mint<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    quote_mint<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    base_vault<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    quote_vault<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    fee_state<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    tick_array_current<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    tick_array_prev<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    tick_array_next<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    observation_state<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\npub struct RaydiumCLMM<span class=\"token punctuation\">;</span>\n\n#<span class=\"token punctuation\">[</span>async_trait<span class=\"token punctuation\">]</span>\nimpl Dex <span class=\"token keyword\">for</span> RaydiumCLMM <span class=\"token punctuation\">{</span>\n    fn <span class=\"token function\">dex_name</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> String <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"RaydiumCLMM\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    fn <span class=\"token function\">dex_program_id</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Pubkey <span class=\"token punctuation\">{</span>\n        Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PROGRAM_ID</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    fn <span class=\"token function\">quote</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> amount_in<span class=\"token operator\">:</span> f64<span class=\"token punctuation\">,</span> metadata<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>PoolMetadata<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> f64 <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> amount_in <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0.0</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">let</span> fee_rate <span class=\"token operator\">=</span> metadata<span class=\"token punctuation\">.</span>trade_fee<span class=\"token punctuation\">.</span><span class=\"token function\">unwrap_or</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> amount_in_with_fee <span class=\"token operator\">=</span> amount_in <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.0</span> <span class=\"token operator\">-</span> fee_rate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> mut remaining_in <span class=\"token operator\">=</span> amount_in_with_fee<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> mut total_out <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> sqrt_price_x64 <span class=\"token operator\">=</span> get_extra<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">,</span> <span class=\"token string\">\"sqrt_price_x64\"</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap_or</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> tick_current_index <span class=\"token operator\">=</span> get_extra<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">,</span> <span class=\"token string\">\"tick_current_index\"</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap_or</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> i32<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> tick_array <span class=\"token operator\">=</span> get_extra<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">,</span> <span class=\"token string\">\"tick_array\"</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token builtin\">Array</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap_or</span><span class=\"token punctuation\">(</span>vec<span class=\"token operator\">!</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> tick_array<span class=\"token punctuation\">.</span><span class=\"token function\">is_empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">let</span> current_price <span class=\"token operator\">=</span> sqrt_price_x64 <span class=\"token operator\">/</span> 2_f64<span class=\"token punctuation\">.</span><span class=\"token function\">powi</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> mut current_tick <span class=\"token operator\">=</span> tick_current_index<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> mut ticks<span class=\"token operator\">:</span> Vec<span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span>i32<span class=\"token punctuation\">,</span> f64<span class=\"token punctuation\">)</span><span class=\"token operator\">&gt;</span> <span class=\"token operator\">=</span> tick_array<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">filter_map</span><span class=\"token punctuation\">(</span><span class=\"token operator\">|</span>v<span class=\"token operator\">|</span> match v <span class=\"token punctuation\">{</span>\n                PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">Map</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">let</span> tick_index <span class=\"token operator\">=</span> get_extra<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> <span class=\"token string\">\"tick_index\"</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Number<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span> <span class=\"token keyword\">as</span> i32<span class=\"token punctuation\">;</span>\n                    <span class=\"token keyword\">let</span> liquidity <span class=\"token operator\">=</span> get_extra<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> <span class=\"token string\">\"liquidity\"</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Number<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>tick_index<span class=\"token punctuation\">,</span> liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                _ <span class=\"token operator\">=&gt;</span> None<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ticks<span class=\"token punctuation\">.</span><span class=\"token function\">sort_by</span><span class=\"token punctuation\">(</span><span class=\"token operator\">|</span>a<span class=\"token punctuation\">,</span> b<span class=\"token operator\">|</span> a<span class=\"token punctuation\">.</span><span class=\"token number\">0.</span><span class=\"token function\">cmp</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>b<span class=\"token punctuation\">.</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>tick_index<span class=\"token punctuation\">,</span> liquidity<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> ticks <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> tick_index <span class=\"token operator\">&lt;=</span> current_tick <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">let</span> sqrt_price_lower <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>0001_f64<span class=\"token punctuation\">.</span><span class=\"token function\">powf</span><span class=\"token punctuation\">(</span>current_tick <span class=\"token keyword\">as</span> f64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">let</span> sqrt_price_upper <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>0001_f64<span class=\"token punctuation\">.</span><span class=\"token function\">powf</span><span class=\"token punctuation\">(</span>tick_index <span class=\"token keyword\">as</span> f64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">let</span> delta_sqrt_price <span class=\"token operator\">=</span> sqrt_price_upper <span class=\"token operator\">-</span> sqrt_price_lower<span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">let</span> max_amount_out <span class=\"token operator\">=</span> liquidity <span class=\"token operator\">*</span> delta_sqrt_price<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">let</span> cost <span class=\"token operator\">=</span> max_amount_out <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>sqrt_price_upper <span class=\"token operator\">+</span> sqrt_price_lower<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> remaining_in <span class=\"token operator\">&gt;=</span> cost <span class=\"token punctuation\">{</span>\n                total_out <span class=\"token operator\">+=</span> max_amount_out<span class=\"token punctuation\">;</span>\n                remaining_in <span class=\"token operator\">-=</span> cost<span class=\"token punctuation\">;</span>\n                current_tick <span class=\"token operator\">=</span> tick_index<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">let</span> fraction <span class=\"token operator\">=</span> remaining_in <span class=\"token operator\">/</span> cost<span class=\"token punctuation\">;</span>\n                total_out <span class=\"token operator\">+=</span> max_amount_out <span class=\"token operator\">*</span> fraction<span class=\"token punctuation\">;</span>\n                remaining_in <span class=\"token operator\">=</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> remaining_in <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0.0</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        total_out\n    <span class=\"token punctuation\">}</span>\n\n    fn <span class=\"token function\">fetch_pool_addresses</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Vec<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> program_id <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">dex_program_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> accounts <span class=\"token operator\">=</span> match client<span class=\"token punctuation\">.</span><span class=\"token function\">get_program_accounts</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>program_id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span>accs<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> accs<span class=\"token punctuation\">,</span>\n            <span class=\"token function\">Err</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token punctuation\">{</span>\n                error<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to fetch {} pool addresses: {}\"</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">dex_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> Vec<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> mut pool_addresses <span class=\"token operator\">=</span> Vec<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>pubkey<span class=\"token punctuation\">,</span> account<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> accounts <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> account<span class=\"token punctuation\">.</span>owner <span class=\"token operator\">!=</span> program_id <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> account<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">let</span> base_mint <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span><span class=\"token number\">0.</span><span class=\"token number\">.32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_base58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">let</span> quote_mint <span class=\"token operator\">=</span> data<span class=\"token punctuation\">[</span><span class=\"token number\">32.</span><span class=\"token number\">.64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_base58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> base_mint<span class=\"token punctuation\">.</span><span class=\"token function\">is_empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> quote_mint<span class=\"token punctuation\">.</span><span class=\"token function\">is_empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">let</span> discriminator <span class=\"token operator\">=</span> u64<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_le_bytes</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span><span class=\"token number\">0.</span><span class=\"token number\">.8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> discriminator <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">let</span> pool_address <span class=\"token operator\">=</span> pubkey<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            pool_addresses<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>accounts<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">derive_accounts_from_pool_address</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pool_address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token constant\">POOL_ADDRESS_MAP</span><span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">,</span> accounts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        pool_addresses\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">async</span> fn <span class=\"token function\">listen_new_pool_addresses</span><span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span>\n        client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">,</span>\n        address_tx<span class=\"token operator\">:</span> Sender<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">&gt;</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Result<span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Box<span class=\"token operator\">&lt;</span>dyn Error<span class=\"token operator\">&gt;&gt;</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> program_id <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">dex_program_id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> ws_url <span class=\"token operator\">=</span> <span class=\"token string\">\"wss://api.mainnet-beta.solana.com\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> <span class=\"token punctuation\">(</span>mut ws_stream<span class=\"token punctuation\">,</span> _<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">connect_async</span><span class=\"token punctuation\">(</span>ws_url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>await<span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> subscribe_msg <span class=\"token operator\">=</span> format<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>\n            r#<span class=\"token string\">\"{\"</span>jsonrpc<span class=\"token string\">\":\"</span><span class=\"token number\">2.0</span><span class=\"token string\">\",\"</span>id<span class=\"token string\">\":1,\"</span>method<span class=\"token string\">\":\"</span>logsSubscribe<span class=\"token string\">\",\"</span>params<span class=\"token string\">\":[\"</span>mentions<span class=\"token string\">\",\"</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token string\">\"]}\"</span>#<span class=\"token punctuation\">,</span>\n            program_id\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        ws_stream<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>Message<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">Text</span><span class=\"token punctuation\">(</span>subscribe_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>await<span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">while</span> <span class=\"token keyword\">let</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> ws_stream<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>await <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> msg <span class=\"token operator\">=</span> msg<span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> Message<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">Text</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> msg <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">let</span> log<span class=\"token operator\">:</span> serde_json<span class=\"token operator\">:</span><span class=\"token operator\">:</span>Value <span class=\"token operator\">=</span> serde_json<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>text<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> log<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"result\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">is_some</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token keyword\">let</span> params <span class=\"token operator\">=</span> log<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"params\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">and_then</span><span class=\"token punctuation\">(</span><span class=\"token operator\">|</span>p<span class=\"token operator\">|</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"result\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok_or</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No params\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">let</span> tx_sig <span class=\"token operator\">=</span> params<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"signature\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">and_then</span><span class=\"token punctuation\">(</span><span class=\"token operator\">|</span>s<span class=\"token operator\">|</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok_or</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No signature\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">let</span> logs <span class=\"token operator\">=</span> params<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"logs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">and_then</span><span class=\"token punctuation\">(</span><span class=\"token operator\">|</span>l<span class=\"token operator\">|</span> l<span class=\"token punctuation\">.</span><span class=\"token function\">as_array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok_or</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"No logs\"</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token keyword\">let</span> tx <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">get_transaction</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token operator\">&amp;</span>Signature<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span>tx_sig<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n                    CommitmentConfig<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">confirmed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span> tx<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span><span class=\"token function\">is_some</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> tx<span class=\"token punctuation\">.</span>meta<span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">is_some</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token keyword\">let</span> log_str <span class=\"token operator\">=</span> logs<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter_map</span><span class=\"token punctuation\">(</span><span class=\"token operator\">|</span>l<span class=\"token operator\">|</span> l<span class=\"token punctuation\">.</span><span class=\"token function\">as_str</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>collect<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token operator\">&lt;</span>Vec<span class=\"token operator\">&lt;</span><span class=\"token operator\">&amp;</span>str<span class=\"token operator\">&gt;&gt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">let</span> account_keys <span class=\"token operator\">=</span> tx<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>account_keys<span class=\"token punctuation\">;</span>\n\n                <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> account_keys<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">enumerate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> tx<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span><span class=\"token function\">is_writable</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">let</span> pool_address <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">find_pool_address_from_account</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">if</span> pool_address<span class=\"token punctuation\">.</span><span class=\"token function\">is_empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">is_valid_pool_address</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>accounts<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">derive_accounts_from_pool_address</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                                <span class=\"token constant\">POOL_ADDRESS_MAP</span><span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> accounts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                                info<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Detected new {} pool address: {}\"</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">dex_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                                address_tx<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>await<span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token punctuation\">}</span>\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>pool_address<span class=\"token punctuation\">.</span><span class=\"token function\">is_empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            info<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Detected writable account affecting pool: {}, Pool: {}\"</span><span class=\"token punctuation\">,</span> tx_sig<span class=\"token punctuation\">,</span> pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                            address_tx<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>await<span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token keyword\">if</span> log_str<span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"initialize\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">extract_new_pool_address</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> tx_sig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">if</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">is_valid_pool_address</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pool_address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>accounts<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">derive_accounts_from_pool_address</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>pool_address<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                                <span class=\"token constant\">POOL_ADDRESS_MAP</span><span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> accounts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                                info<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Detected new {} pool address: {}\"</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">dex_name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                                address_tx<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>await<span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n                            <span class=\"token punctuation\">}</span>\n                        <span class=\"token punctuation\">}</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    fn <span class=\"token function\">fetch_pool_metadata</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">,</span> pool_address<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Option<span class=\"token operator\">&lt;</span>PoolMetadata<span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> derived_accounts <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">derive_accounts_from_pool_address</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> pool_address<span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> out <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">get_account_data</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> out<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">{</span>\n            error<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Pool data too short for {}\"</span><span class=\"token punctuation\">,</span> pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> None<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">let</span> base_reserve <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">get_vault_balance</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>derived_accounts<span class=\"token punctuation\">.</span>base_vault<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> quote_reserve <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">get_vault_balance</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>derived_accounts<span class=\"token punctuation\">.</span>quote_vault<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> fee_data <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">get_account_data</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>derived_accounts<span class=\"token punctuation\">.</span>fee_state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> fee_numerator <span class=\"token operator\">=</span> u64<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_le_bytes</span><span class=\"token punctuation\">(</span>fee_data<span class=\"token punctuation\">[</span><span class=\"token number\">0.</span><span class=\"token number\">.8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> fee_denominator <span class=\"token operator\">=</span> u64<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_le_bytes</span><span class=\"token punctuation\">(</span>fee_data<span class=\"token punctuation\">[</span><span class=\"token number\">8.</span><span class=\"token number\">.16</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> trade_fee <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> fee_denominator <span class=\"token operator\">&gt;</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>fee_numerator <span class=\"token keyword\">as</span> f64 <span class=\"token operator\">/</span> fee_denominator <span class=\"token keyword\">as</span> f64<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> None <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> sqrt_price_x64 <span class=\"token operator\">=</span> u64<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_le_bytes</span><span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">[</span><span class=\"token number\">64.</span><span class=\"token number\">.72</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> tick_current_index <span class=\"token operator\">=</span> i32<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_le_bytes</span><span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">[</span><span class=\"token number\">72.</span><span class=\"token number\">.76</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> tick_array_data <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">get_account_data</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>derived_accounts<span class=\"token punctuation\">.</span>tick_array_current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap_or_default</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> mut tick_array <span class=\"token operator\">=</span> Vec<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token operator\">!</span>tick_array_data<span class=\"token punctuation\">.</span><span class=\"token function\">is_empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token punctuation\">(</span><span class=\"token number\">8.</span><span class=\"token punctuation\">.</span>tick_array_data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">step_by</span><span class=\"token punctuation\">(</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">let</span> tick_index <span class=\"token operator\">=</span> i32<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_le_bytes</span><span class=\"token punctuation\">(</span>tick_array_data<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>i<span class=\"token operator\">+</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">let</span> liquidity <span class=\"token operator\">=</span> f64<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_le_bytes</span><span class=\"token punctuation\">(</span>tick_array_data<span class=\"token punctuation\">[</span>i<span class=\"token operator\">+</span><span class=\"token number\">4.</span><span class=\"token punctuation\">.</span>i<span class=\"token operator\">+</span><span class=\"token number\">12</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1_000_000.0</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">let</span> mut tick_map <span class=\"token operator\">=</span> HashMap<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                tick_map<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tick_index\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>tick_index <span class=\"token keyword\">as</span> f64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                tick_map<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"liquidity\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>liquidity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                tick_array<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">Map</span><span class=\"token punctuation\">(</span>tick_map<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">let</span> mut extra <span class=\"token operator\">=</span> HashMap<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        extra<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sqrt_price_x64\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>sqrt_price_x64 <span class=\"token keyword\">as</span> f64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        extra<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tick_current_index\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>tick_current_index <span class=\"token keyword\">as</span> f64<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        extra<span class=\"token punctuation\">.</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tick_array\"</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PoolMetadataValue<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">Array</span><span class=\"token punctuation\">(</span>tick_array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>PoolMetadata <span class=\"token punctuation\">{</span>\n            pool_address<span class=\"token operator\">:</span> pool_address<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            base_mint<span class=\"token operator\">:</span> derived_accounts<span class=\"token punctuation\">.</span>base_mint<span class=\"token punctuation\">,</span>\n            quote_mint<span class=\"token operator\">:</span> derived_accounts<span class=\"token punctuation\">.</span>quote_mint<span class=\"token punctuation\">,</span>\n            base_reserve<span class=\"token operator\">:</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>base_reserve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            quote_reserve<span class=\"token operator\">:</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>quote_reserve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            trade_fee<span class=\"token punctuation\">,</span>\n            extra<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\nimpl RaydiumCLMM <span class=\"token punctuation\">{</span>\n    fn <span class=\"token function\">derive_accounts_from_pool_address</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">,</span> pool_address<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Option<span class=\"token operator\">&lt;</span>PoolDerivedAccounts<span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> out <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">get_account_data</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> out<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">{</span>\n            error<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Pool data too short for {}\"</span><span class=\"token punctuation\">,</span> pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">return</span> None<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">let</span> base_mint <span class=\"token operator\">=</span> out<span class=\"token punctuation\">[</span><span class=\"token number\">0.</span><span class=\"token number\">.32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_base58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> quote_mint <span class=\"token operator\">=</span> out<span class=\"token punctuation\">[</span><span class=\"token number\">32.</span><span class=\"token number\">.64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_base58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> base_vault <span class=\"token operator\">=</span> out<span class=\"token punctuation\">[</span><span class=\"token number\">96.</span><span class=\"token number\">.128</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_base58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> quote_vault <span class=\"token operator\">=</span> out<span class=\"token punctuation\">[</span><span class=\"token number\">128.</span><span class=\"token number\">.160</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_base58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> fee_state <span class=\"token operator\">=</span> out<span class=\"token punctuation\">[</span><span class=\"token number\">160.</span><span class=\"token number\">.192</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_base58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> tick_array_current_seed <span class=\"token operator\">=</span> format<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tick_array{}\"</span><span class=\"token punctuation\">,</span> pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> tick_array_current <span class=\"token operator\">=</span> Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">create_program_address</span><span class=\"token punctuation\">(</span>\n            <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span>tick_array_current_seed<span class=\"token punctuation\">.</span><span class=\"token function\">as_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PROGRAM_ID</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> tick_array_prev_seed <span class=\"token operator\">=</span> format<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tick_array_prev{}\"</span><span class=\"token punctuation\">,</span> pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> tick_array_prev <span class=\"token operator\">=</span> Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">create_program_address</span><span class=\"token punctuation\">(</span>\n            <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span>tick_array_prev_seed<span class=\"token punctuation\">.</span><span class=\"token function\">as_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PROGRAM_ID</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> tick_array_next_seed <span class=\"token operator\">=</span> format<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tick_array_next{}\"</span><span class=\"token punctuation\">,</span> pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> tick_array_next <span class=\"token operator\">=</span> Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">create_program_address</span><span class=\"token punctuation\">(</span>\n            <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span>tick_array_next_seed<span class=\"token punctuation\">.</span><span class=\"token function\">as_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PROGRAM_ID</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> observation_state_seed <span class=\"token operator\">=</span> format<span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"observation_state{}\"</span><span class=\"token punctuation\">,</span> pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> observation_state <span class=\"token operator\">=</span> Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">create_program_address</span><span class=\"token punctuation\">(</span>\n            <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span><span class=\"token operator\">&amp;</span>observation_state_seed<span class=\"token punctuation\">.</span><span class=\"token function\">as_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PROGRAM_ID</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>PoolDerivedAccounts <span class=\"token punctuation\">{</span>\n            pool_address<span class=\"token operator\">:</span> pool_address<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            base_mint<span class=\"token punctuation\">,</span>\n            quote_mint<span class=\"token punctuation\">,</span>\n            base_vault<span class=\"token punctuation\">,</span>\n            quote_vault<span class=\"token punctuation\">,</span>\n            fee_state<span class=\"token punctuation\">,</span>\n            tick_array_current<span class=\"token punctuation\">,</span>\n            tick_array_prev<span class=\"token punctuation\">,</span>\n            tick_array_next<span class=\"token punctuation\">,</span>\n            observation_state<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    fn <span class=\"token function\">find_pool_address_from_account</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> account_address<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> String <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> map <span class=\"token operator\">=</span> <span class=\"token constant\">POOL_ADDRESS_MAP</span><span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">,</span> accounts<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> account_address <span class=\"token operator\">==</span> pool_address <span class=\"token operator\">||</span>\n               account_address <span class=\"token operator\">==</span> <span class=\"token operator\">&amp;</span>accounts<span class=\"token punctuation\">.</span>base_vault <span class=\"token operator\">||</span>\n               account_address <span class=\"token operator\">==</span> <span class=\"token operator\">&amp;</span>accounts<span class=\"token punctuation\">.</span>quote_vault <span class=\"token operator\">||</span>\n               account_address <span class=\"token operator\">==</span> <span class=\"token operator\">&amp;</span>accounts<span class=\"token punctuation\">.</span>tick_array_current <span class=\"token operator\">||</span>\n               account_address <span class=\"token operator\">==</span> <span class=\"token operator\">&amp;</span>accounts<span class=\"token punctuation\">.</span>tick_array_prev <span class=\"token operator\">||</span>\n               account_address <span class=\"token operator\">==</span> <span class=\"token operator\">&amp;</span>accounts<span class=\"token punctuation\">.</span>tick_array_next <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> pool_address<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        String<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    fn <span class=\"token function\">is_valid_pool_address</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">,</span> pool_address<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> bool <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> out <span class=\"token operator\">=</span> match client<span class=\"token punctuation\">.</span><span class=\"token function\">get_account_data</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span>pool_address<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> data<span class=\"token punctuation\">,</span>\n            <span class=\"token function\">Err</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> out<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">200</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>out<span class=\"token punctuation\">.</span>owner<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PROGRAM_ID</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">let</span> base_mint <span class=\"token operator\">=</span> out<span class=\"token punctuation\">[</span><span class=\"token number\">0.</span><span class=\"token number\">.32</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_base58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> quote_mint <span class=\"token operator\">=</span> out<span class=\"token punctuation\">[</span><span class=\"token number\">32.</span><span class=\"token number\">.64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_base58</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> base_mint<span class=\"token punctuation\">.</span><span class=\"token function\">is_empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> quote_mint<span class=\"token punctuation\">.</span><span class=\"token function\">is_empty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">let</span> discriminator <span class=\"token operator\">=</span> u64<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_le_bytes</span><span class=\"token punctuation\">(</span>out<span class=\"token punctuation\">[</span><span class=\"token number\">0.</span><span class=\"token number\">.8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">try_into</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> discriminator <span class=\"token operator\">==</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token boolean\">true</span>\n    <span class=\"token punctuation\">}</span>\n\n    fn <span class=\"token function\">get_vault_balance</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">,</span> vault<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> f64 <span class=\"token punctuation\">{</span>\n        match client<span class=\"token punctuation\">.</span><span class=\"token function\">get_token_account_balance</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>Pubkey<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span>vault<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> CommitmentConfig<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">confirmed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span>resp<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> resp<span class=\"token punctuation\">.</span>ui_amount<span class=\"token punctuation\">.</span><span class=\"token function\">unwrap_or</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token function\">Err</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">)</span> <span class=\"token operator\">=&gt;</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    fn <span class=\"token function\">extract_new_pool_address</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>self<span class=\"token punctuation\">,</span> client<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>RpcClient<span class=\"token punctuation\">,</span> tx_sig<span class=\"token operator\">:</span> <span class=\"token operator\">&amp;</span>str<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">&gt;</span> Option<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">&gt;</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> tx <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">get_transaction</span><span class=\"token punctuation\">(</span>\n            <span class=\"token operator\">&amp;</span>Signature<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">from_str</span><span class=\"token punctuation\">(</span>tx_sig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span>\n            CommitmentConfig<span class=\"token operator\">:</span><span class=\"token operator\">:</span><span class=\"token function\">confirmed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> key <span class=\"token keyword\">in</span> tx<span class=\"token punctuation\">.</span>transaction<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">.</span>account_keys <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> key<span class=\"token punctuation\">.</span><span class=\"token function\">is_writable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">is_signer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token function\">Some</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">to_string</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n        None\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div><!--/$--></div>",
  "url": "https://web3.okx.com/zh-hans/build/dev-docs/dex-api/dex-integration#amm-接入示例",
  "navigation": {
    "breadcrumbs": [
      "DEX API",
      "交易 API",
      "DEX 集成"
    ],
    "sidebar_links": [
      "搭建兑换应用",
      "搭建跨链应用",
      "介绍",
      "API 参考",
      "设置分佣",
      "DEX 集成",
      "智能合约",
      "错误码",
      "FAQ",
      "介绍",
      "API 参考",
      "支持的跨链桥",
      "智能合约",
      "错误码",
      "FAQ",
      "介绍",
      "API 参考",
      "错误码"
    ],
    "toc": [
      "AMM 接入示例",
      "基于 Raydium CLMM 的实现例子"
    ]
  },
  "word_count": 3485,
  "extract_time": "2025-05-27 01:40:25"
}